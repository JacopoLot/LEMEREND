---
title: "LEMEREND"
author: "Jacopo Lot"
date: "02-05-2024"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
rm(list = ls())
```


### Patients diagnosed with PD in 2016: transition matrices

The database contains information on 30423 patients aged 50 and over. It includes both patients diagnosed with Parkinson's disease (PD) in 2020 and living patients who received an earlier diagnosis. The criterion used to distinguish between the two stages of PD is hospitalisation: if a patient has been hospitalised due to PD, then they are considered to have severe PD. The variables are as follows:

* Gender (“BEN_SEX_COD”, 1 if male, 2 if female)

* Age class ("CLA_AGE_5")

* Year of hospitalisation (or "never", if never hospitalised) ("first_hospit")

* Year of first appearance in the data ("first_year")

* Year of death (or "alive", if still living) ("yod")

* Severity of the disease during the period (mild/severe) ("severity")

* Severity of the disease at the end of the period ("severity_at_end")

* Number of cases ("n_patients")

A filter to keep only the new diagnoses in 2016 has been applied in accordance with the gender/age class/year of diagnosis approach.

```{r, message=FALSE, warning=FALSE}
library(readxl)
library(tidyverse)
library(purrr)
library(janitor)
library(ggplot2)

df <- read_excel("Parkinson data n_patients.xlsx")
f_prob <- read_excel("Prob of death.xlsx", sheet = "f prob" )
```

Now let's break down data with respect to:

* age class
* severity during the period: this represents an indicator for the severity at the beginning of the period, since a transitioned patients must have been "mild" at the beginning to transition later.
* severity at end
* gender
* life status (alive or dead)
* number of cases

```{r, message=FALSE, warning=FALSE}
library(dplyr)
library(tidyverse)
#Filter to retain new diagnoses in 2016
summary_df <- df %>% 
   filter( 
      first_year == "2016")%>% mutate(
    yod_binary = case_when(
      yod != "Alive" ~ "Dead",
      TRUE ~ yod 
    ),
    gender = factor(BEN_SEX_COD, levels = c("1", "2"), labels = c("Male", "Female"))
  ) %>% 
  group_by(CLA_AGE_5, severity, severity_at_end, gender, yod_binary) %>% 
  summarise(
    n_patients = sum(`n_patients`)
  ) %>% 
  ungroup() %>% 
  complete(CLA_AGE_5, severity, severity_at_end, gender, yod_binary, fill = list(n_patients = 0)) %>%
  select(CLA_AGE_5, gender, yod_binary, severity, severity_at_end, n_patients) %>% 
  arrange(gender)

summary_df

summary_df1 <- summary_df %>% 
  mutate(
    severity = case_when(
      severity == "Transitioned" & yod_binary == "Dead" ~ "Severe",
      TRUE ~ severity
    )
  ) %>% 
  #filter(severity != "Transitioned" & yod_binary != "Dead") %>% 
  group_by(CLA_AGE_5, severity, severity_at_end, gender, yod_binary) %>% 
  summarise(
    n_patients = sum(`n_patients`)
  ) %>% 
  ungroup() %>% 
  complete(CLA_AGE_5, severity, severity_at_end, gender, yod_binary, fill = list(n_patients = 0)) %>%
  select(CLA_AGE_5, gender, yod_binary, severity, severity_at_end, n_patients) %>% 
  arrange(gender)
  
summary_df1

#summary_df %>% write_excel_csv(file = "summary_df.csv")

summary_df2 <- df %>% 
 mutate(
    yod_binary = case_when(
      yod != "Alive" ~ "Dead",
      TRUE ~ yod 
    ),
    gender = factor(BEN_SEX_COD, levels = c("1", "2"), labels = c("Male", "Female"))
  ) %>% 
  group_by(CLA_AGE_5, severity, severity_at_end, gender, yod_binary) %>% 
  summarise(
    n_patients = sum(`n_patients`)
  ) %>% 
  ungroup() %>% 
  complete(CLA_AGE_5, severity, severity_at_end, gender, yod_binary, fill = list(n_patients = 0)) %>%
  select(CLA_AGE_5, gender, yod_binary, severity, severity_at_end, n_patients) %>% 
  arrange(gender)
summary_df2
```

```{r}
sum(summary_df$n_patients)
```


The above table allows to build cohorts, where each cohort is identified by 4 consecutive rows. Now we can compute the transition matrix of each cohort:

* x(1,1), P(P -> P): the probability of remaining into the prodromal stage is 0 since, sooner or later, the disease will progress to MPD
* x(1,2), P(P -> MPD): 1 - F, where F is defined at point 4
* x(1,3), P(P -> APD) = 0: PD is always progressive and therefore a patient must necessarily experience MPD before transitioning to the advanced stage
* x(1,4): P(P -> D): let's define this probability as F. It can be estimated by considering mortality data extracted from INSEE during the period 2009-2011, in order to avoid the impact of the Covid-19 pandemic on mortality rates. The data on the number of deaths is standardized to a cohort of 10000 individuals for each year of age. Therefore, the probability of death for each year of age will be the number of deaths divided by 10000. The formula used to compute the probability of dying within the next five years for each age class is:  $$
P_{x, 5 \text{ years}} = \sum_{i=0}^{4} \left( \prod_{j=0}^{i-1} (1 - p(x+j)) \right) \times p(x+i)$$
where x is the initial year of age of a certain age class.
This is the probability that an individual aged x will die within the next 5 years, which requires to consider both the probabilities of surviving each year up to 5 years and the probabilities of dying in each year. If p(x) is the probability that the individual will die within a year, the probability of surviving a given year will be 1 - p(x). To survive several years, the survival probabilities for each single year shall be multiplied. The formula considers the conditional probabilities of dying in each of the next five years and sums them.

The table f_prob estimates F according to the above descripted approach: 

```{r}
f_prob
```

The remaining elements are:

* x(2,1), P(MPD -> P) = 0 (PD is irreversible)
* x(2,2), P(MPD -> MPD) = 1 - x(2,3) - x(2,4)
* x(2,3), P(MPD -> APD): this probability can be estimated by the number of MPD patients who transitioned to APD at the end of the 5-year observation period divided by the number of MPD patients at the beginning of the period 
* x(2,4), P(MPD -> D): this probability can be estimated by the number of MPD patients who died at the end of the observation period over the number of MPD patients at the beginning of the period.
* x(3,1), P(APD -> P) = 0 (PD is irreversible)
* x(3,2), P(APD -> MPD) = 0 (PD is irreversible)
* x(3,3) = 1 - x(3,4)
* x(3,4), P(APD -> D): this probability can be estimated by the number of APD patients who died at the end of the observation period over the number of APD patients at the beginning of the period.
* x(4,1), P(D -> P) = 0 (death is the absorbing state)
* x(4,2), P(D -> MPD) = 0
* x(4,3), P(D -> APD) = 0
* x(4,4), P(D -> D) = 1

Generally speaking, a transition matrix with 4 states (Prodromal, Mild Parkinson Disease, Severe/Advanced Parkinson Disease, Death) looks like the following:

```{r}
a <- matrix(NA, nrow = 4, ncol = 4)

a[1, 1] <- 0
a[1, 2] <- "1 - F"
a[1, 3] <- 0
a[1, 4] <- "F"
a[2, 1] <- 0
a[2, 2] <- "1 - P(MPD -> APD) - P(MPD -> D)" 
a[2, 3] <- "P(MPD -> APD)"
a[2, 4] <- "P(MPD -> D)"
a[3, 1] <- 0
a[3, 2] <- 0
a[3, 3] <- "1 - P(APD -> D)"
a[3, 4] <- "P(APD -> D)"
a[4, 1] <- 0
a[4, 2] <- 0
a[4, 3] <- 0
a[4,4] <- 1

a
```

The transition matrix for the first cohort (males within the 50-54 age class) is:

```{r}

x <- matrix(NA, nrow = 4, ncol = 4)

x[1, 1] <- 0
x[1, 2] <- 1 - f_prob$F[1]
x[1, 3] <- 0
x[1, 4] <- f_prob$F[1]
x[2, 1] <- 0

numerator_MPD_APD <- summary_df1 %>%
    filter(CLA_AGE_5 == "50-54" & gender == "Male" & severity == "Transitioned" & yod_binary == "Alive") %>%
    summarise(n_patients = sum(n_patients)) %>%
    pull(n_patients)

  numerator_MPD_MPD <- summary_df %>%
    filter(CLA_AGE_5 == "50-54" & gender == "Male" & severity == "Mild" & yod_binary == "Alive") %>%
    summarise(n_patients = sum(n_patients)) %>%
    pull(n_patients)

  numerator_MPD_D <- summary_df %>%
    filter(CLA_AGE_5 == "50-54" & gender == "Male" & severity %in% c("Mild", "Transitioned") & yod_binary == "Dead") %>%
    summarise(n_patients = sum(n_patients)) %>%
    pull(n_patients)

  denominator_MPD <- summary_df %>%
    filter(CLA_AGE_5 == "50-54" & gender == "Male" & severity %in% c("Mild", "Transitioned")) %>%
    summarise(n_patients = sum(n_patients)) %>%
    pull(n_patients)


x[2, 3] <- numerator_MPD_APD / denominator_MPD
x[2, 4] <- numerator_MPD_D / denominator_MPD
x[2, 2] <- 1 - (numerator_MPD_APD / denominator_MPD) - (numerator_MPD_D / denominator_MPD)

x[3, 1] <- 0
x[3, 2] <- 0
numerator_APD_D <- summary_df2 %>%
  filter(CLA_AGE_5 == "50-54", gender == "Male", severity_at_end == "Severe", yod_binary == "Dead") %>%
  summarise(n_patients = sum(n_patients)) %>% 
  pull(n_patients)
denominator_APD_D <- summary_df2 %>%
  filter(CLA_AGE_5 == "50-54", gender == "Male", severity_at_end == "Severe") %>% 
  summarise(n_patients = sum(n_patients)) %>% 
  pull(n_patients)
x[3, 4] <- numerator_APD_D / denominator_APD_D
x[3, 3] <- 1 - (numerator_APD_D / denominator_APD_D)
x[4, 1] <- 0
x[4, 2] <- 0
x[4, 3] <- 0
x[4,4] <- 1

x

```

Let's iterate the process for each of the 20 cohorts within the database:

```{r}
age_classes <- c("50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85-89", "90-94", "95et+")
genders <- c("Male", "Female")

generate_transition_matrix_old <- function(summary_df, summary_df2, age_classes, gender_name) {
  
  x <- matrix(NA, nrow = 4, ncol = 4)

  x[1, 1] <- 0
  f_prob1 <- f_prob %>% 
    filter(`Age class` == age_class, Gender == gender_name) %>% 
    summarise(f_prob = F) %>% 
    pull(f_prob)
  x[1, 2] <- 1 - f_prob1
  x[1, 3] <- 0
  x[1, 4] <- f_prob1

  numerator_MPD_APD <- summary_df1 %>%
    filter(CLA_AGE_5 == age_class & gender == gender_name & severity == "Transitioned" & yod_binary == "Alive") %>%
    summarise(n_patients = sum(n_patients)) %>%
    pull(n_patients)

  numerator_MPD_D <- summary_df %>%
    filter(CLA_AGE_5 == age_class & gender == gender_name & severity %in% c("Mild", "Transitioned") & yod_binary == "Dead") %>%
    summarise(n_patients = sum(n_patients)) %>%
    pull(n_patients)

  denominator_MPD <- summary_df %>%
    filter(CLA_AGE_5 == age_class & gender == gender_name & severity %in% c("Mild", "Transitioned")) %>%
    summarise(n_patients = sum(n_patients)) %>%
    pull(n_patients)
  
  x[2, 1] <- 0
  x[2, 3] <- numerator_MPD_APD / denominator_MPD
  x[2, 4] <- numerator_MPD_D / denominator_MPD
  x[2, 2] <- 1 - (numerator_MPD_APD / denominator_MPD) - (numerator_MPD_D / denominator_MPD)

  x[3, 1] <- 0
  x[3, 2] <- 0
  numerator_APD_D <- summary_df2 %>%
    filter(CLA_AGE_5 == age_class, gender == gender_name, severity_at_end == "Severe", yod_binary == "Dead") %>%
    summarise(n_patients = sum(n_patients)) %>% 
    pull(n_patients)
  denominator_APD_D <- summary_df2 %>%
    filter(CLA_AGE_5 == age_class, gender == gender_name, severity_at_end == "Severe") %>%
    summarise(n_patients = sum(n_patients)) %>% 
    pull(n_patients)
  
  x[3, 4] <- numerator_APD_D / denominator_APD_D

  x[3, 3] <- 1 - (numerator_APD_D / denominator_APD_D)

  x[4, 1] <- 0
  x[4, 2] <- 0
  x[4, 3] <- 0
  x[4, 4] <- 1

  return(x)
}

transition_matrices_old <- list()

for (gender in genders) {
  for (age_class in age_classes) {
    matrix_name <- paste(gender, age_class, sep = "_")
    transition_matrices_old[[matrix_name]] <- generate_transition_matrix_old(summary_df, summary_df2, age_class, gender)
  }
}


transition_matrices_old

names(transition_matrices_old) <- NULL  

males_old <- transition_matrices_old[1:10]
females_old <- transition_matrices_old[11:20]

matrices_mf_old <- list(males_old, females_old)
matrices_mf_old

for (i in 1:length(males_old)) {
  colnames(males_old[[i]]) <- c("P.m", "MPD.m", "APD.m", "D.m")
  col_names_m <- c("P.m", "MPD.m", "APD.m", "D.m") 
  rownames(males_old[[i]]) <- c("P.m", "MPD.m", "APD.m", "D.m")
  row_names_m <- c("P.m", "MPD.m", "APD.m", "D.m") 
}
for (i in 1:length(females_old)) {
  colnames(females_old[[i]]) <- c("P.f", "MPD.f", "APD.f", "D.f")
  col_names_f <- c("P.f", "MPD.f", "APD.f", "D.f")
  rownames(females_old[[i]]) <- c("P.f", "MPD.f", "APD.f", "D.f")
  row_names_f <- c("P.f", "MPD.f", "APD.f", "D.f")
}
for (i in 1:length(males_old)) {
  dimnames(males_old[[i]]) <- list(row_names_m, col_names_m)
}
for (i in 1:length(females_old)) {
  dimnames(females_old[[i]]) <- list(row_names_f, col_names_f)
}

transition_matrices_mf_old <- list(males_old, females_old)
transition_matrices_mf_old
transition_matrices_m_old <- transition_matrices_mf_old[[1]]
transition_matrices_f_old <- transition_matrices_mf_old[[2]]

extract_rows_as_named_list <- function(matrix) {
  list(
    P = setNames(as.numeric(matrix[1, ]), c("P", "MPD", "APD", "D")),
    MPD = setNames(as.numeric(matrix[2, ]), c("P", "MPD", "APD", "D")),
    APD = setNames(as.numeric(matrix[3, ]), c("P", "MPD", "APD", "D")),
    D = setNames(as.numeric(matrix[4, ]), c("P", "MPD", "APD", "D"))
  )
}

transition_prob_m_old <- lapply(transition_matrices_m_old, extract_rows_as_named_list)

transition_prob_f_old <- lapply(transition_matrices_f_old, extract_rows_as_named_list)

print("Transition Probabilities for Males:")
print(transition_prob_m_old)

print("Transition Probabilities for Females:")
print(transition_prob_f_old)
```

Let's analyse the graph depicting probabilities of death with respect to severity:

```{r}
severity_labels <- c("Prodromal", "Mild", "Advanced")

# Extracting probabilities of death from matrices
extract_probabilities <- function(matrices, age_classes, genders) {
  data <- data.frame()
  
  for (i in 1:length(matrices)) {
    age_class <- age_classes[i]
    matrix <- matrices[[i]]
    
    data <- rbind(data, data.frame(
      age_class = age_class,
      gender = genders,
      severity = severity_labels[1],
      probability_of_death = matrix[1, 4]
    ))
    
    data <- rbind(data, data.frame(
      age_class = age_class,
      gender = genders,
      severity = severity_labels[2],
      probability_of_death = matrix[2, 4]
    ))
    
    data <- rbind(data, data.frame(
      age_class = age_class,
      gender = genders,
      severity = severity_labels[3],
      probability_of_death = matrix[3, 4]
    ))
  }
  
  return(data)
}

# Extracting data for males/females
males_data <- extract_probabilities(males_old, age_classes, "Male")
females_data <- extract_probabilities(females_old, age_classes, "Female")

final_data <- rbind(males_data, females_data)

graph_prob_mf <- ggplot(final_data, aes(x = age_class, y = probability_of_death, color = severity, group = severity)) +
  geom_line() +
  geom_point() +
  facet_wrap(~ gender) +
  scale_color_manual(values = c("Prodromal" = "green", "Mild" = "orange", "Advanced" = "red")) +
  theme_minimal() +
  labs(title = "Probability of death with respect to severity, baseline scenario",
       x = "Age class",
       y = "Probability",
       color = "Severity") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
graph_prob_mf
```

A sensible relationship between probability of death and severity emerges from the graph: the more severe the disease, the higher the probability of death.
The only exception is represented by the last age class due to the very small sample size.

Let's impose this relationship as valid also for patients aged 95 years and more: the differential between the probability of dying when mild and the probability of dying when prodromal of the previous age class, 90-94, is used to adjust the last probability of dying when prodromal:

```{r}
# Let's apply the adjustment
final_data1 <- final_data %>%
  group_by(gender) %>% 
  mutate(probability_of_death = ifelse(
    age_class == "95et+" & severity == "Prodromal",
    probability_of_death[age_class == "95et+" & severity == "Mild"] -
      (probability_of_death[age_class == "90-94" & severity == "Mild"] -
       probability_of_death[age_class == "90-94" & severity == "Prodromal"]),
    probability_of_death
  ))

#final_data_males <- final_data1 %>%
 # filter(gender == "Male")

#final_data_females <- final_data1 %>% 
 # filter(gender == "Female")

age_classes <- c("50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85-89", "90-94", "95et+")
genders <- c("Male", "Female")

f_prob1 <- f_prob %>%
  mutate(
    F = case_when(
      `Age class` == "95et+" & Gender == "Male" ~ final_data1 %>% filter(gender == "Male", age_class == "95et+") %>% pull(probability_of_death) %>% first(),
      `Age class` == "95et+" & Gender == "Female" ~ final_data1 %>% filter(gender == "Female", age_class == "95et+") %>% pull(probability_of_death) %>% first(),
      TRUE ~ F
    )
  )


generate_transition_matrix <- function(summary_df, summary_df2, final_data1, age_classes, gender_name) {
  
  x <- matrix(NA, nrow = 4, ncol = 4)
  x[1, 1] <- 0
  age_classes_to_select <- c("50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85-89", "90-94")
  
  f_prob2 <- f_prob1 %>% 
    filter(`Age class` == age_classes & Gender == gender_name) %>% 
    pull(F)
   
  x[1, 2] <- 1 - f_prob2
  x[1, 3] <- 0
  x[1, 4] <- f_prob2

  x[2, 1] <- 0
  
  numerator_MPD_APD <- summary_df1 %>%
    filter(CLA_AGE_5 == age_class & gender == gender_name & severity == "Transitioned" & yod_binary == "Alive") %>%
    summarise(n_patients = sum(n_patients)) %>%
    pull(n_patients)

  numerator_MPD_MPD <- summary_df %>%
    filter(CLA_AGE_5 == age_class & gender == gender_name & severity == "Mild" & yod_binary == "Alive") %>%
    summarise(n_patients = sum(n_patients)) %>%
    pull(n_patients)

  numerator_MPD_D <- summary_df %>%
    filter(CLA_AGE_5 == age_class & gender == gender_name & severity %in% c("Mild", "Transitioned") & yod_binary == "Dead") %>%
    summarise(n_patients = sum(n_patients)) %>%
    pull(n_patients)

  denominator_MPD <- summary_df %>%
    filter(CLA_AGE_5 == age_class & gender == gender_name & severity %in% c("Mild", "Transitioned")) %>%
    summarise(n_patients = sum(n_patients)) %>%
    pull(n_patients)
  
  x[2, 3] <- numerator_MPD_APD / denominator_MPD

  x[2, 4] <- numerator_MPD_D / denominator_MPD

  x[2, 2] <- 1 - (numerator_MPD_APD / denominator_MPD) - (numerator_MPD_D / denominator_MPD)

  x[3, 1] <- 0
  x[3, 2] <- 0
  numerator_APD_D <- summary_df2 %>%
    filter(CLA_AGE_5 == age_class, gender == gender_name, severity_at_end == "Severe", yod_binary == "Dead") %>%
    summarise(n_patients = sum(n_patients)) %>% 
    pull(n_patients)
  
  denominator_APD_D <- summary_df2 %>%
    filter(CLA_AGE_5 == age_class, gender == gender_name, severity_at_end == "Severe") %>%
    summarise(n_patients = sum(n_patients)) %>% 
    pull(n_patients)
  
  x[3, 4] <- numerator_APD_D / denominator_APD_D

  x[3, 3] <- 1 - (numerator_APD_D / denominator_APD_D)

  x[4, 1] <- 0
  x[4, 2] <- 0
  x[4, 3] <- 0
  x[4, 4] <- 1

  return(x)
}

transition_matrices <- list()

for (gender in genders) {
  for (age_class in age_classes) {
    matrix_name <- paste(gender, age_class, sep = "_")
    transition_matrices[[matrix_name]] <- generate_transition_matrix(summary_df, summary_df2, final_data1, age_class, gender)
  }
}


transition_matrices

names(transition_matrices) <- NULL  

males <- transition_matrices[1:10]
females <- transition_matrices[11:20]

matrices_mf <- list(males, females)
matrices_mf

for (i in 1:length(males)) {
  colnames(males[[i]]) <- c("P.m", "MPD.m", "APD.m", "D.m")
  col_names_m <- c("P.m", "MPD.m", "APD.m", "D.m") 
  rownames(males[[i]]) <- c("P.m", "MPD.m", "APD.m", "D.m")
  row_names_m <- c("P.m", "MPD.m", "APD.m", "D.m") 
}
for (i in 1:length(females)) {
  colnames(females[[i]]) <- c("P.f", "MPD.f", "APD.f", "D.f")
  col_names_f <- c("P.f", "MPD.f", "APD.f", "D.f")
  rownames(females[[i]]) <- c("P.f", "MPD.f", "APD.f", "D.f")
  row_names_f <- c("P.f", "MPD.f", "APD.f", "D.f")
}
for (i in 1:length(males)) {
  dimnames(males[[i]]) <- list(row_names_m, col_names_m)
}
for (i in 1:length(females)) {
  dimnames(females[[i]]) <- list(row_names_f, col_names_f)
}

transition_matrices_mf <- list(males, females)
transition_matrices_mf
transition_matrices_m <- transition_matrices_mf[[1]]
transition_matrices_f <- transition_matrices_mf[[2]]

extract_rows_as_named_list <- function(matrix) {
  list(
    P = setNames(as.numeric(matrix[1, ]), c("P", "MPD", "APD", "D")),
    MPD = setNames(as.numeric(matrix[2, ]), c("P", "MPD", "APD", "D")),
    APD = setNames(as.numeric(matrix[3, ]), c("P", "MPD", "APD", "D")),
    D = setNames(as.numeric(matrix[4, ]), c("P", "MPD", "APD", "D"))
  )
}

transition_prob_m <- lapply(transition_matrices_m, extract_rows_as_named_list)

transition_prob_f <- lapply(transition_matrices_f, extract_rows_as_named_list)

print("Transition Probabilities for Males:")
print(transition_prob_m)

print("Transition Probabilities for Females:")
print(transition_prob_f)

graph_prob_mf <- ggplot(final_data1, aes(x = age_class, y = probability_of_death, color = severity, group = severity)) +
  geom_line() +
  geom_point() +
  facet_wrap(~ gender) +
  scale_color_manual(values = c("Prodromal" = "green", "Mild" = "orange", "Advanced" = "red")) +
  theme_minimal() +
  labs(title = "Probability of death with respect to severity, baseline scenario",
       x = "Age class",
       y = "Probability",
       color = "Severity") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
graph_prob_mf
```

Graphs showcasing the probability of remaining MPD:

```{r}
extract_probabilities2 <- function(matrices, age_classes, genders) {
  data <- data.frame()
  
  for (i in 1:length(matrices)) {
    age_class <- age_classes[i]
    matrix <- matrices[[i]]
    
    data <- rbind(data, data.frame(
      age_class = age_class,
      gender = genders,
      severity = severity_labels[2],
      probability_of_remainingMPD = matrix[2, 2]
    ))
    
  }
  
  return(data)
}

males_data_rem <- extract_probabilities2(males, age_classes, "Male")
females_data_rem <- extract_probabilities2(females, age_classes, "Female")

final_data_rem <- rbind(males_data_rem, females_data_rem)

graph_prob_mf_rem <- ggplot(final_data_rem, aes(x = age_class, y = probability_of_remainingMPD, colour = gender, group = gender)) +
  geom_line() +
  geom_point() +
  facet_wrap(~ gender) +
  theme_minimal() +
  labs(title = "Probability of remaining MPD with respect to gender and age classes, baseline scenario",
       x = "Age class",
       y = "Probability") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), plot.title = element_text(size = 10))
graph_prob_mf_rem
```


Graphs showcasing the probability of transitioning from MPD to APD:

```{r}
extract_probabilities1 <- function(matrices, age_classes, genders) {
  data <- data.frame()
  
  for (i in 1:length(matrices)) {
    age_class <- age_classes[i]
    matrix <- matrices[[i]]
    
    data <- rbind(data, data.frame(
      age_class = age_class,
      gender = genders,
      severity = severity_labels[2],
      probability_of_transitioning = matrix[2, 3]
    ))
    
  }
  
  return(data)
}

males_data_tra <- extract_probabilities1(males, age_classes, "Male")
females_data_tra <- extract_probabilities1(females, age_classes, "Female")

final_data_tra <- rbind(males_data_tra, females_data_tra)

graph_prob_mf_tra <- ggplot(final_data_tra, aes(x = age_class, y = probability_of_transitioning, colour = gender, group = gender)) +
  geom_line() +
  geom_point() +
  facet_wrap(~ gender) +
  theme_minimal() +
  labs(title = "Probability of transitioning from MPD to APD with respect to gender and age classes, baseline scenario",
       x = "Age class",
       y = "Probability") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), plot.title = element_text(size = 10))
graph_prob_mf_tra
```



### Patients diagnosed with PD in 2016: costs

The database for cost calculations contains 26274 patients, due to an operation of data cleaning for a more meaningful specification of costs, and 3 additional variables:

* Observed costs in the data (for individuals who transitioned from one state to another, we have both the costs for their mild period and their severe period) ("True costs")

* Costs with, for individuals who transitioned from mild -> severe, imputation of the average costs of the mild period on their severe period (i.e., the cost in a counterfactual situation where all these individuals remained mild) ("Counterfactual costs (mild)")

* Costs with, for individuals who transitioned from mild -> severe, imputation of the average costs of the severe period on their mild period (i.e., the cost in a counterfactual situation where all these individuals were severe from the beginning of the period) ("Counterfactual costs (severe)")

All these costs have been extracted from the "Cartologie des Pathologies" and are referred to the 2016-2020 period, matching the length of the Markov cycle.

```{r, message=FALSE, warning=FALSE}
library(readxl)
library(tidyverse)

df2 <- read_excel("Parkinson data costs.xlsx") %>% 
  filter(first_year == "2016")%>% mutate(
    across(
      c(  "True costs"  ),
      ~ as.numeric(.x)
    )
  )
```

Now let's decompose the new database into cohorts. Regarding the new variables, the weighted average of the 'True costs' contained in df2 shall be considered, assuming that all newly diagnosed individuals are at the mild stage at the beginning of the 5-year period and either at the mild or severe stage at the end of the period: patients who have transitioned are to be considered as severe at the end of the period.

```{r, message=FALSE, warning=FALSE}
library(dplyr)

summary_df3 <- df2 %>% 
  mutate(
    yod_binary = case_when(
      yod != "Alive" ~ "Dead",
      TRUE ~ yod
    ),
    gender = factor(BEN_SEX_COD, levels = c("1", "2"), labels = c("Male", "Female"))
  ) %>% 
  group_by(CLA_AGE_5, severity_at_end, gender) %>% 
  summarise(
    n_patients = sum(`Number of Parkinson cases`),
    Mean_reimbursed = weighted.mean(`True costs`, `Number of Parkinson cases`),
   
  ) %>% 
  arrange(gender)

summary_df3
```

To evaluate the relevance of the criteria used to distinguish between mild and severe PD, it is useful to calculate the differences between the average cost for a patient with severe PD and the average cost for a patient with mild PD, taking into account the decomposition into cohorts. Before examining the results, we would expect that the average cost for patients with severe PD is significantly higher than the average cost for patients with mild PD: if this is the case, then the criteria effectively distinguish between two groups of patients with very different cost profiles.

```{r, message=FALSE, warning=FALSE}
library(ggplot2)

difference_df <- summary_df3 %>%
       pivot_wider(id_cols = CLA_AGE_5, names_from = c(gender, severity_at_end), values_from = Mean_reimbursed) 
difference_df
```

```{r, message=FALSE, warning=FALSE, results='hide'}
mean_reimbursed_difference_male <- difference_df$Male_Severe - difference_df$Male_Mild
mean_reimbursed_difference_female <- difference_df$Female_Severe - difference_df$Female_Mild
 


male_plot <- ggplot(difference_df, aes(x = CLA_AGE_5, y = mean_reimbursed_difference_male)) +
  geom_bar(stat = "identity", fill = "lightblue", position = "dodge") +
  labs(title = "Difference in Mean Reimbursement Between Parkinson's Severity (Males)",
       x = "Age Classes",
       y = "Difference in Mean Reimbursement")
  theme_minimal()

female_plot <- ggplot(difference_df, aes(x = CLA_AGE_5, y = mean_reimbursed_difference_female)) +
  geom_bar(stat = "identity", fill = "pink", position = "dodge") +
  labs(title = "Difference in Mean Reimbursement Between Parkinson's Severity (Females)",
       x = "Age Classes",
       y = "Difference in Mean Reimbursement")
  theme_minimal()

print(male_plot)
print(female_plot)
```

The two graphs show that the differences are indeed significant and seem to follow a random trend for females and a decreasing trend for males. Such a decreasing trend would suggest a deterioration in average overall medical conditions as male patients get older, which narrows the difference between the average costs of the 2 phases of the disease. In particular, the differences among males aged 95 and over are negative, but this is due to the insignificant sample size for these very old male patients. On the other hand, all the other differences are particularly significant, leading to the conclusion that hospitalization is a valid indicator for distinguishing between the two stages of the disease.

```{r}
difference_df2 <- difference_df %>% pivot_longer(cols = -CLA_AGE_5, names_to = "severity", values_to = "cost")




library(ggplot2)
costs_males <- ggplot(difference_df2 %>% filter(str_detect(severity, "Male")), aes(x = CLA_AGE_5, y = cost, group = severity, colour = severity)) +
  geom_line() +
  labs(title = "Average medical costs (males)",
       x = "Age Classes",
       y = "Cost") +
  theme_minimal()

costs_females <- ggplot(difference_df2 %>% filter(str_detect(severity, "Female")), aes(x = CLA_AGE_5, y = cost, group = severity, colour = severity)) +
  geom_line() +
  labs(title = "Average medical costs (females)",
       x = "Age Classes",
       y = "Cost") +
  theme_minimal()
options(scipen=999)
costs_males 
costs_females
```

The lines representing the average costs of patients with severe PD are consistently above the lines showing the average costs of patients with mild PD, once again proving the relevance of the criterion. In addition, even if a clear decreasing trend is not exhibited, the average medical cost of the oldest cohort is always lower than that of the youngest cohort. Common wisdom would suggest that average medical costs increase with age as patients are more prone to illnesses, but the above evidence shows that it is not the case for PD patients. A possible explanation is based on the characteristics of PD: medical literature suggests that the response to treatments is negatively associated with age both for levodopa administration and deep brain stimulation, hence the cost-effectiveness of treatments decreases with age. As a result, medical costs can be decomposed into a fixed, constant component, representing costs that are not associated with PD, and a variable component, which is directly related to PD. The fixed component is represented by the average medical costs of healthy patients while the variable component is the average extra cost of PD patients. 



### Patients diagnosed with PD in 2016: average extra costs

The vector of costs is C = (cp, c, C, 0), where cp is the average medical cost for prodromal patients, c is the average extra cost for patients affected by MPD, which is equal to the difference between the average medical cost of MPD patients and cp, C is the average extra cost associated with APD patient and deceased patients cost 0.

cp is assumed to be equal to the average medical cost of a healthy patient. The database containing healthy patients, where an healthy patient is defined as a generic patient not being affected by PD. The new variables are:

* mean_cost: total average cost over 5 years

* n_years: number of years during which the patient was alive out of 5 years

* mean_cost_per_year: average annual cost for the period during which the patient was alive 

The new database shall be merged with the database indicating average medical costs of PD patients, after having applied a filter to retain patients who have been alive throughout the entire period in order to avoid the inclusion of average costs that incorporate costs of dead patients:

```{r, message=FALSE, warning=FALSE}
library(readxl)
library(tidyverse)

df3 <- read_excel("Healthy cohort.xlsx") %>% 
  filter(n_years == 5) %>% 
  mutate(
    yod_binary = case_when(
      yod != "Alive" ~ "Dead",
      TRUE ~ yod
    ),
  ) %>% 
  group_by(CLA_AGE_5, BEN_SEX_COD) %>% 
  summarise(
    Mean_reimbursed = weighted.mean(as.numeric(mean_cost), n),
    n_patients = sum(n),
    severity_at_end = "Healthy"
  ) %>% 
  mutate(gender = case_when(BEN_SEX_COD == 1 ~ "Male", BEN_SEX_COD == 2 ~ "Female")) %>% 
  select(-BEN_SEX_COD) %>% 
  bind_rows(summary_df3)
df3
difference_df3 <- df3 %>%
       pivot_wider(id_cols = CLA_AGE_5, names_from = c(gender, severity_at_end), values_from = Mean_reimbursed) 
difference_df3


```

The average extra costs for MPD and APD patients, c and C, will be:

```{r}
difference_df4 <- difference_df3 %>% 
mutate(
    Extra_Cost_Mild_Males = Male_Mild - Male_Healthy,
    Extra_Cost_Severe_Males = Male_Severe - Male_Healthy,
    Extra_Cost_Mild_Females = Female_Mild - Female_Healthy,
    Extra_Cost_Severe_Females = Female_Severe - Female_Healthy
  ) %>%
  select(CLA_AGE_5, Extra_Cost_Mild_Males, Extra_Cost_Severe_Males,  Extra_Cost_Mild_Females , Extra_Cost_Severe_Females)

difference_df4
```

Some extra costs concerning the oldest patients appear to be negative, but this is because of the particular definition of healthy: a healthy patient is not affected by PD but might be affected by other medical conditions that make medical costs increase, especially at an old age. Since negative extra costs are not meaningful, let's assume that negative deltas are equal to 0.

```{r}
difference_df5 <- difference_df3 %>% 
 mutate(
    Extra_Cost_Mild_Males = ifelse(Male_Mild - Male_Healthy < 0, 0, Male_Mild - Male_Healthy),
    Extra_Cost_Severe_Males = ifelse(Male_Severe - Male_Healthy < 0, 0, Male_Severe - Male_Healthy),
    Extra_Cost_Mild_Females = ifelse(Female_Mild - Female_Healthy < 0, 0, Female_Mild - Female_Healthy),
    Extra_Cost_Severe_Females = ifelse(Female_Severe - Female_Healthy < 0, 0, Female_Severe - Female_Healthy)
  ) %>%
  select(CLA_AGE_5, Extra_Cost_Mild_Males, Extra_Cost_Severe_Males, Extra_Cost_Mild_Females, Extra_Cost_Severe_Females  )

difference_df5 
```

The graphs showcasing extra costs are the following:

```{r}
difference_df6<- difference_df5 %>% 
  pivot_longer(cols = -CLA_AGE_5, names_to = "severity", values_to = "cost")
  
p1 <- ggplot(data = difference_df6 %>% filter(severity %in% c("Extra_Cost_Mild_Males", "Extra_Cost_Severe_Males")), aes(x = CLA_AGE_5, y = cost, group =  severity, color = severity)) +
  geom_line() +
  ggtitle("Average Extra Costs (Males)") +
  xlab("Age Class") +
  ylab("Average extra cost") +
  theme_minimal()

p2 <- ggplot(data = difference_df6 %>% filter(severity %in% c("Extra_Cost_Mild_Females", "Extra_Cost_Severe_Females")), aes(x = CLA_AGE_5, y = cost, group =  severity, color = severity)) +
  geom_line() +
  ggtitle("Average Extra Costs (Females)") +
  xlab("Age Class") +
  ylab("Average extra cost") +
  theme_minimal()

p1
p2
```

These graphs exhibit a similar trend compared to the ones referring to average medical costs. Again, the blue lines are consistently above the red lines and the trend is roughly decreasing, due to the decreasing cost-effectiveness of treatments as PD progresses. The fact that average medical costs are similar to the total medical costs indicates that PD is a significant driver of healthcare expenses, implying that a substantial portion of PD patients' medical costs is directly attributable to PD itself. Moreover, the assumption that the fixed component (namely average medical costs of healthy patients) was constant is acceptable since the above graphs can be approximated by average medical costs minus a constant.

This constant is equal to the weighted average of healthy patients' average medical costs, separately for male and female patients.

```{r}
df_filtered_males <- df3 %>% 
  filter(severity_at_end == "Healthy", gender == "Male")
constant_males <- weighted.mean(df_filtered_males$Mean_reimbursed, df_filtered_males$n_patients)
df_filtered_females <- df3 %>%
  filter(severity_at_end == "Healthy", gender == "Female")
constant_females <- weighted.mean(df_filtered_females$Mean_reimbursed, df_filtered_females$n_patients)
constant_males
constant_females
```

Let's subtract the constants to observe the similarity between the graphs:

```{r}
library(ggplot2)
costs_males1 <- ggplot(difference_df2 %>% filter(str_detect(severity, "Male")), aes(x = CLA_AGE_5, y = cost - constant_males, group = severity, colour = severity)) +
  geom_line() +
  labs(title = "Average medical costs - constant (males)",
       x = "Age Classes",
       y = "Cost") +
  theme_minimal()

costs_females1 <- ggplot(difference_df2 %>% filter(str_detect(severity, "Female")), aes(x = CLA_AGE_5, y = cost - constant_females, group = severity, colour = severity)) +
  geom_line() +
  labs(title = "Average medical costs - constant (females)",
       x = "Age Classes",
       y = "Cost") +
  theme_minimal()
options(scipen=999)
costs_males1 
p1
costs_females1
p2
```

At this point the matrix of costs can be constructed:

```{r}
costs_model_males <- data.frame(cp = difference_df3$Male_Healthy, c = difference_df5$Extra_Cost_Mild_Males, C = difference_df5$Extra_Cost_Severe_Males, D = 0 )
col_names_costs <- c("cp", "c", "C", "D")
rownames(costs_model_males) <- c("50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85-89", "90-94", "95+")
row_names_costs <- c("50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85-89", "90-94", "95+")
dimnames(costs_model_males) <- list(row_names_costs, col_names_costs)
costs_model_females <- data.frame(cp = difference_df3$Female_Healthy, c = difference_df5$Extra_Cost_Mild_Females, C = difference_df5$Extra_Cost_Severe_Females, D = 0)
rownames(costs_model_females) <- c("50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85-89", "90-94", "95+")
dimnames(costs_model_females) <- list(row_names_costs, col_names_costs)
costs_model_males
costs_model_females
```



### Baseline scenario    

Once transition matrices and cost matrices are available, the microsimulation model can be initialized:

```{r}
n.i <- 26000 #number of newly diagnosed PD patients in 2020, according to the French public health agency. This institution also claims that PD is approximately 1.5 times more frequent in men than women (hence, a proper approximation is: 60% men and 40% women)
n_males <- n.i * 0.6
n_females <- n.i * 0.4
n.t <- 15 #number of cycles of the model: starting from 2020, 2 5-year cycles are necessary to reach 2030
n.sim <- 100 #number of simulations. The higher the number of simulations, the more precise the results of the model, but the processing power at hand should be taken into account when setting this number.
v.n <- c("P", "MPD", "APD", "D") # model states
n.s <- length(v.n) # number of health states
v.M_1_males <- rep("P", n_males) #everyone begins in the prodromal stage
v.M_1_females <- rep("P", n_females) #everyone begins in the prodromal stage
d.c.1 <- ((1+0.025)^5) - 1 # 5-year discount rate for costs, assuming a annual discount rate of 2.5% for the 2020-2070 period
d.c.2 <- ((1+0.015)^5) - 1 # 5-year discount rate for costs, assuming a annual discount rate of 1.5% for the 2070-2095 period
```

Costs are to be mapped before entering microsimulation:

```{r, warning=FALSE, message=FALSE}
#Males
transition_costs_m <- list()
for (cycle in 1:10) {
  c.P.m <- costs_model_males[[cycle, "cp"]]
  c.MPD.m <- costs_model_males[[cycle, "c"]]
  c.APD.m <- costs_model_males[[cycle, "C"]]
  c.D.m <- costs_model_males[[cycle, "D"]]
  transition_costs_m[[cycle]] <- list(
    "P" = c(c.P.m),
    "MPD" = c(c.MPD.m),
    "APD" = c(c.APD.m),
    "D" = c(c.D.m)
  )
}

#When patients go beyond 95 years of age, costs for the last age class are to be repeated 
last_transition_m <- transition_costs_m[[10]]
for (i in 11:n.t) {
  transition_costs_m[[i]] <- last_transition_m
}

print(transition_costs_m)

#Females
transition_costs_f <- list()
for (cycle in 1:10) {
  c.P.f <- costs_model_females[[cycle, "cp"]]
  c.MPD.f <- costs_model_females[[cycle, "c"]]
  c.APD.f <- costs_model_females[[cycle, "C"]]
  c.D.f <- costs_model_females[[cycle, "D"]]
  transition_costs_f[[cycle]] <- list(
    "P" = c(c.P.f),
    "MPD" = c(c.MPD.f),
    "APD" = c(c.APD.f),
    "D" = c(c.D.f)
  )
}

#When patients go beyond 95 years of age, costs for the last age class are to be repeated 
last_transition_f <- transition_costs_f[[10]]
for (i in 11:n.t) {
  transition_costs_f[[i]] <- last_transition_f
}

print(transition_costs_f)
```

The microsimulation function for male patients is:

```{r}
m.M <- m.C <-  matrix(nrow = n_males,
                      ncol = n.t + 1,
                      dimnames = list(paste("ind", 1:n_males, sep = " "), paste("cycle", 0:n.t, sep = " "))) 
m.M[, 1] <- v.M_1_males
```


```{r, warning=FALSE, message=FALSE}
#Males
Probs <- function(state){
  return(transition_prob_m[[state]])
}
Costs <- function(state) {
  return(transition_costs_m[[state]])
}

# Testing 
set.seed(1) #deterministic sequence of random numbers

transition_prob_m <- transition_prob_m %>% 
  map(~ map(.x, ~ sort(.x, decreasing = TRUE)))
loop_microsim <- function(n.t) {
     for (t in 1:n.t) {
      m.p <- m.M[, t]
# calculate the transition probabilities at cycle t
     #state <- list("P", "MPD", "APD","D")
      for (i in 1:length(m.p)) {
        current_state <- m.p[i]
        new_state <- m.p[i]
         if (t > 10) {
           new_state <- sample(names(transition_prob_m[[10]][[current_state]]), 1, prob = transition_prob_m[[10]][[current_state]])
         } else {
           new_state <- sample(names(transition_prob_m[[t]][[current_state]]), 1, prob = transition_prob_m[[t]][[current_state]])
         }
        m.M[i, t + 1] <- new_state
        #m.C[i, t + 1] <- Costs(current_state)
      }   
    } # close the loop for the time points
  return(m.M)
}


# Init m.M #repeat it!!!!
model_results_m <- list()
for(i in 1:n.sim) {
m.M <- m.C <-  matrix(nrow = n_males,
                      ncol = n.t + 1,
                      dimnames = list(paste("ind", 1:n_males, sep = " "), paste("cycle", 0:n.t, sep = " "))) 
m.M[, 1] <- v.M_1_males
# Microsim loop
model_results_m[[i]] <- loop_microsim(n.t)
print(i)
} 
# repeat it!!!

#Results of the median cycle, the 50th
model_results_m[[50]][1:300, ]
df_m.M <- model_results_m[[50]] %>% as.tibble()
library(janitor)
map(
  c("cycle 0", "cycle 1", "cycle 2", "cycle 3", "cycle 4", "cycle 5",
    "cycle 6", "cycle 7", "cycle 8", "cycle 9", "cycle 10", "cycle 11", "cycle 12", "cycle 13", "cycle 14"),
  ~ df_m.M %>% tabyl(!!sym(.x))
)

# Transition costs in a dataframe
transition_costs_m <-
  transition_costs_m %>% 
  data.table::rbindlist() %>% 
  t() %>% 
  as_tibble(rownames = "Stage") %>% 
  rename_with(~ c("Stage", "cycle 0", "cycle 1", "cycle 2", "cycle 3", "cycle 4",
    "cycle 5", "cycle 6", "cycle 7", "cycle 8", "cycle 9", "cycle 10", "cycle 11", "cycle 12", "cycle 13", "cycle 14")) %>% 
  pivot_longer(cols = -Stage, names_to = "cycle", values_to = "cost")

final_cost_m <-
  map(
    model_results_m,
    ~ .x %>% 
      as_tibble() %>% 
      mutate(id = row_number()) %>% 
      pivot_longer(cols = -id, names_to = "cycle", values_to = "Stage") %>% 
      left_join(
        transition_costs_m
      )
  )
  

final_cost_m2 <-
  map(
    final_cost_m,
    ~ .x %>% 
      group_by(cycle) %>% 
      summarise(
      n = n(),
      sum_costs = sum(cost, na.rm = TRUE)
    ) %>% 
    mutate(cycle = as_factor (cycle) %>%  fct_relevel(c("cycle 0", "cycle 1", "cycle 2", "cycle 3", "cycle 4", "cycle 5", "cycle 6", "cycle 7", "cycle 8", "cycle 9", "cycle 10", "cycle 11", "cycle 12", "cycle 13", "cycle 14"))) %>%  arrange(cycle) %>% 
    filter(cycle != "cycle 15")
  )
final_cost_m2
```

The same reasoning is applied to female patients:

```{r}
m.M <- m.C <-  matrix(nrow = n_females,
                      ncol = n.t + 1,
                      dimnames = list(paste("ind", 1:n_females, sep = " "), paste("cycle", 0:n.t, sep = " "))) 
m.M[, 1] <- v.M_1_females
```


```{r, warning=FALSE, message=FALSE}
#Females
Probs <- function(state){
  return(transition_prob_f[[state]])
}
Costs <- function(state) {
  return(transition_costs_f[[state]])
}
# Testing 
set.seed(1) #deterministic sequence of random numbers

transition_prob_f <- transition_prob_f %>% 
  map(~ map(.x, ~ sort(.x, decreasing = TRUE)))
loop_microsim <- function(n.t) {
     for (t in 1:n.t) {
      m.p <- m.M[, t]
# calculate the transition probabilities at cycle t
     #state <- list("P", "MPD", "APD","D")
      for (i in 1:length(m.p)) {
        current_state <- m.p[i]
        new_state <- m.p[i]
         if (t > 10) {
           new_state <- sample(names(transition_prob_f[[10]][[current_state]]), 1, prob = transition_prob_f[[10]][[current_state]])
         } else {
           new_state <- sample(names(transition_prob_f[[t]][[current_state]]), 1, prob = transition_prob_f[[t]][[current_state]])
         }
        m.M[i, t + 1] <- new_state
        #m.C[i, t + 1] <- Costs(current_state)
      }   
    } # close the loop for the time points
  return(m.M)
}


# Init m.M #repeat it!!!!
model_results_f <- list()
for(i in 1:n.sim) {
m.M <- m.C <-  matrix(nrow = n_females,
                      ncol = n.t + 1,
                      dimnames = list(paste("ind", 1:n_females, sep = " "), paste("cycle", 0:n.t, sep = " "))) 
m.M[, 1] <- v.M_1_females
# Microsim loop
model_results_f[[i]] <- loop_microsim(n.t)
print(i)
}  
# repeat it!!!

#Results of the median cycle, the 50th
model_results_f[[50]][1:300, ]
df_m.M <- model_results_f[[50]] %>% as.tibble()
library(janitor)
map(
  c("cycle 0", "cycle 1", "cycle 2", "cycle 3", "cycle 4", "cycle 5",
    "cycle 6", "cycle 7", "cycle 8", "cycle 9", "cycle 10", "cycle 11", "cycle 12", "cycle 13", "cycle 14"),
  ~ df_m.M %>% tabyl(!!sym(.x))
)

#Transition costs
transition_costs_f <-
  transition_costs_f %>% 
  data.table::rbindlist() %>% 
  t() %>% 
  as_tibble(rownames = "Stage") %>% 
  rename_with(~ c("Stage", "cycle 0", "cycle 1", "cycle 2", "cycle 3", "cycle 4",
    "cycle 5", "cycle 6", "cycle 7", "cycle 8", "cycle 9", "cycle 10", "cycle 11", "cycle 12", "cycle 13", "cycle 14")) %>% 
  pivot_longer(cols = -Stage, names_to = "cycle", values_to = "cost")

final_cost_f <- map(
    model_results_f,
    ~ .x %>% 
      as_tibble() %>% 
      mutate(id = row_number()) %>% 
      pivot_longer(cols = -id, names_to = "cycle", values_to = "Stage") %>% 
      left_join(
        transition_costs_f
      )
  )
 

final_cost_f2 <-
  map(
    final_cost_f,
    ~ .x %>% 
      group_by(cycle) %>% 
      summarise(
      n = n(),
      sum_costs = sum(cost, na.rm = TRUE)
    ) %>% 
    mutate(cycle = as_factor (cycle) %>%  fct_relevel(c("cycle 0", "cycle 1", "cycle 2", "cycle 3", "cycle 4", "cycle 5", "cycle 6", "cycle 7", "cycle 8", "cycle 9", "cycle 10", "cycle 11", "cycle 12", "cycle 13", "cycle 14"))) %>%  arrange(cycle) %>% 
    filter(cycle != "cycle 15")
  )
final_cost_f2
```

The variability of costs over 30 simulations is observed through a box plot:

```{r}
#Males
final_cost_m2_combined <- bind_rows(final_cost_m2)

final_cost_m2_combined$cycle <- factor(final_cost_m2_combined$cycle, 
                                           levels = c("cycle 0", "cycle 1", "cycle 2", "cycle 3", "cycle 4", 
                                                      "cycle 5", "cycle 6", "cycle 7", "cycle 8", "cycle 9", "cycle 10", "cycle 11", "cycle 12", "cycle 13", "cycle 14"))

var_graph_m <- ggplot(final_cost_m2_combined, aes(x = cycle, y = sum_costs)) +
  geom_boxplot(width = 0.9) +  
  labs(title = "Box Plot of Total Costs per Cycle, Baseline Scenario (Males)",
       x = "Cycle",
       y = "Variability") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
var_graph_m

#Females
final_cost_f2_combined <- bind_rows(final_cost_f2)

final_cost_f2_combined$cycle <- factor(final_cost_f2_combined$cycle, 
                                           levels = c("cycle 0", "cycle 1", "cycle 2", "cycle 3", "cycle 4", 
                                                      "cycle 5", "cycle 6", "cycle 7", "cycle 8", "cycle 9", "cycle 10", "cycle 11", "cycle 12", "cycle 13", "cycle 14"))

var_graph_f <- ggplot(final_cost_f2_combined, aes(x = cycle, y = sum_costs)) +
  geom_boxplot(width = 0.9) +  
  labs(title = "Box Plot of Total Costs per Cycle, Baseline Scenario (Females)",
       x = "Cycle",
       y = "Variability") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
var_graph_f
```

Both graphs show a roughly decreasing trend in total costs over cycles. “Cycle 0” starts with the highest total costs for both genders, since all patients are alive at the prodromal stage and they are associated with the average costs of “healthy” patients. Then, costs drop significantly by “cycle 5” for males and by “cycle 7” for females due to the higher longevity of female patients. However, the most important remark is that variability ap-pears to be moderate across microsimulations, especially among the latest cycles whereby a rapid stabilization of costs occurs.

The graphs showcasing costs over cycles are:

```{r} 
#Averaging costs across simulations
#Males
combined_costs_m <- map_df(final_cost_m2, ~ .x)
mean_costs_per_cycle_m <- combined_costs_m %>%
  group_by(cycle) %>%
  summarise(avg_tot_costs = mean(sum_costs, na.rm = TRUE)) %>%
  mutate(cycle = as_factor(cycle) %>% fct_relevel(c("cycle 0", "cycle 1", "cycle 2", "cycle 3", "cycle 4", "cycle 5", "cycle 6", "cycle 7", "cycle 8", "cycle 9", "cycle 10", "cycle 11", "cycle 12", "cycle 13", "cycle 14"))) %>%
  arrange(cycle)
print(mean_costs_per_cycle_m)
#Females
combined_costs_f <- map_df(final_cost_f2, ~ .x)
mean_costs_per_cycle_f <- combined_costs_f %>%
  group_by(cycle) %>%
  summarise(avg_tot_costs = mean(sum_costs, na.rm = TRUE)) %>%
  mutate(cycle = as_factor(cycle) %>% fct_relevel(c("cycle 0", "cycle 1", "cycle 2", "cycle 3", "cycle 4", "cycle 5", "cycle 6", "cycle 7", "cycle 8", "cycle 9", "cycle 10", "cycle 11", "cycle 12", "cycle 13", "cycle 14"))) %>%
  arrange(cycle)
print(mean_costs_per_cycle_f)

#Graphs
#Males
graph1 <- ggplot(data = mean_costs_per_cycle_m %>% mutate(Year = c("2020-25", "2025-30", "2030-35", "2035-40", "2040-45", "2045-50", "2050-55", "2055-60", "2060-65", "2065-70", "2070-75", "2075-80", "2080-85", "2085-90", "2090-95")), aes(x = Year, y = avg_tot_costs))+
  geom_col(fill = "turquoise") +
  ggtitle("Average total costs from microsimulation (Males)") +
  xlab("Year") +
  ylab("Cost") +
  theme_minimal()+
  scale_y_continuous(labels = scales::comma, limits = c(0, max(mean_costs_per_cycle_m$avg_tot_costs) * 1)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8))
options(scipen=999)
#Females
graph2 <- ggplot(data = mean_costs_per_cycle_f %>% mutate(Year = c("2020-25", "2025-30", "2030-35", "2035-40", "2040-45", "2045-50", "2050-55", "2055-60", "2060-65", "2065-70", "2070-75", "2075-80", "2080-85", "2085-90", "2090-95")), aes(x = Year, y = avg_tot_costs))+
  geom_col(fill = "pink") +
  ggtitle("Average total costs from microsimulation (Females)") +
  xlab("Year") +
  ylab("Cost") +
  theme_minimal()+
  scale_y_continuous(labels = scales::comma, limits = c(0, max(mean_costs_per_cycle_f$avg_tot_costs) * 1)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8))
options(scipen=999)

graph1
graph2
```

Both graphs show a similar trend of high initial costs followed by a gradual decline over the microsimulation period and stabilization at minimal values, which cannot even be showcased by the depiction, for both genders. Considering male patients, the highest costs are observed between 2020 and 2040, and the decline starts thereafter. On the other hand, female patients exhibit costs that decline more gradually and remain significant for the 2050-2065 period, when the costs of males really start to disappear from the graph: again, this is evidence for the higher longevity of women.

Costs need to be discounted when it comes to comparing them at time 0, corresponding to 2020, the first year of the model’s time window 2020 – 2095. In accordance with the approach suggested by the Quinet Commission, “d.c.1” is applied to the first 10 rows of “final_cost_m2”, the list of tables containing aggregated costs for each microsimulation, while “d.c.2” is applied to the last 5. In this way, the two discount periods 2020-2070 and 2070-2095 are differentiated. Eventually, discount weights, “dw”, are multiplied by aggregated costs to obtain the column “discounted_costs”.

```{r}
# Males
discounted_costs_m <-
  map(final_cost_m2, 
  ~ .x %>%  
   mutate(
    dw = ifelse(row_number() <= 10, 
                (1)/((1+d.c.1)^(row_number()-1)), 
                (1)/((1+d.c.2)^(row_number()-1))), #vector of discount weights
    discounted_costs = sum_costs * dw )%>% #the column "discounted_costs" represents the vector of discounted costs  
  select(cycle, n, discounted_costs) 
  )
discounted_costs_m

# Females
discounted_costs_f <-
  map(final_cost_f2, 
  ~ .x %>%  
   mutate(
    dw = ifelse(row_number() <= 10, 
                (1)/((1+d.c.1)^(row_number()-1)), 
                (1)/((1+d.c.2)^(row_number()-1))), #vector of discount weights
    discounted_costs = sum_costs * dw )%>% #the column "discounted_costs" represents the vector of discounted costs  
  select(cycle, n, discounted_costs) 
  )
discounted_costs_f

```

The Total Discounted Cost of PD patients for n.t = 15 (cycles) is:

```{r}
#Males
tot_discounted_costs_m <- list()
for(i in 1:n.sim) {
tot_discounted_cost <- sum(discounted_costs_m[[i]]$discounted_costs) 
tot_discounted_costs_m[[i]] <- list(
  "tot_discounted_costs" = c(tot_discounted_cost)
)
}
print(tot_discounted_costs_m)
#Females
tot_discounted_costs_f <- list()
for(i in 1:n.sim) {
tot_discounted_cost <- sum(discounted_costs_f[[i]]$discounted_costs) 
tot_discounted_costs_f[[i]] <- list(
  "tot_discounted_costs" = c(tot_discounted_cost)
)
}
print(tot_discounted_costs_f)
#Averaging total costs across simulations
TDC_m_baseline <- mean(unlist(tot_discounted_costs_m))
TDC_f_baseline <- mean(unlist(tot_discounted_costs_f))
#Final result
TDC_baseline <- TDC_m_baseline + TDC_f_baseline
TDC_baseline
```



### Alternative scenario: A1

The alternative scenario considers a 1-year delay in the onset of APD thanks to AI-based early detection. Physicians will be able to slow down the progression of PD thanks to an aggressive early treatment of the disease, resulting in a higher probability of remaining in the mild stage (P(MPD→MPD)) which consequently reduces the probability of transitioning to the severe stage (P(MPD→APD)).

The increase in P(MPD→MPD) is modelled through the following formula: $$
p^\prime = p^{\frac{60-x}{60}}$$

where p' is the new probability, p is the initial probability, 60 is the number of months for the 5-year period and x is the number of additional months of the mild stage gained due to early detection. Consequently, the new probability of transitioning to the severe stage is P(MPD→APD) = 1 – p’ – P(MPD→D).

According to the initial hypothesis, x = 12 months and therefore 
$$ p^\prime=\ p^\frac{60-12}{60}=p^\frac{4}{5} $$.

Transition probabilities will be changed accordingly:

```{r}
library(dplyr)
library(ggplot2)
library(fastmap)
library(purrr)
library(tibble)
library(tidyr)
library(forcats)
age_classes <- c("50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85-89", "90-94", "95et+")
genders <- c("Male", "Female")

generate_transition_matrix_alt_old <- function(summary_df, summary_df2, age_classes, gender_name) {
  
  x <- matrix(NA, nrow = 4, ncol = 4)

  x[1, 1] <- 0
  f_prob1 <- f_prob %>% 
    filter(`Age class` == age_class, Gender == gender_name) %>% 
    summarise(f_prob = F) %>% 
    pull(f_prob)
  x[1, 2] <- 1 - f_prob1
  x[1, 3] <- 0
  x[1, 4] <- f_prob1
  
  
   numerator_MPD_APD <- summary_df1 %>%
    filter(CLA_AGE_5 == age_class & gender == gender_name & severity == "Transitioned" & yod_binary == "Alive") %>%
    summarise(n_patients = sum(n_patients)) %>%
    pull(n_patients)

  numerator_MPD_MPD <- summary_df %>%
    filter(CLA_AGE_5 == age_class & gender == gender_name & severity == "Mild" & yod_binary == "Alive") %>%
    summarise(n_patients = sum(n_patients)) %>%
    pull(n_patients)

  numerator_MPD_D <- summary_df %>%
    filter(CLA_AGE_5 == age_class & gender == gender_name & severity %in% c("Mild", "Transitioned") & yod_binary == "Dead") %>%
    summarise(n_patients = sum(n_patients)) %>%
    pull(n_patients)

  denominator_MPD <- summary_df %>%
    filter(CLA_AGE_5 == age_class & gender == gender_name & severity %in% c("Mild", "Transitioned")) %>%
    summarise(n_patients = sum(n_patients)) %>%
    pull(n_patients)

  x[2, 1] <- 0
  
  x[2, 3] <- 1 - (numerator_MPD_D / denominator_MPD) - ((numerator_MPD_MPD/denominator_MPD)^(4/5))

  x[2, 4] <- numerator_MPD_D / denominator_MPD

  x[2, 2] <- (numerator_MPD_MPD/denominator_MPD)^(4/5)

  x[3, 1] <- 0
  x[3, 2] <- 0
  numerator_APD_D <- summary_df2 %>%
    filter(CLA_AGE_5 == age_class, gender == gender_name, severity_at_end == "Severe", yod_binary == "Dead") %>%
    summarise(n_patients = sum(n_patients)) %>% 
    pull(n_patients)
  
  denominator_APD_D <- summary_df2 %>%
    filter(CLA_AGE_5 == age_class, gender == gender_name, severity_at_end == "Severe") %>%
    summarise(n_patients = sum(n_patients)) %>% 
    pull(n_patients)
  
  x[3, 4] <- numerator_APD_D / denominator_APD_D

  x[3, 3] <- 1 - (numerator_APD_D / denominator_APD_D)

  x[4, 1] <- 0
  x[4, 2] <- 0
  x[4, 3] <- 0
  x[4, 4] <- 1

  return(x)
}

transition_matrices_alt_old <- list()

for (gender in genders) {
  for (age_class in age_classes) {
    matrix_name <- paste(gender, age_class, sep = "_")
    transition_matrices_alt_old[[matrix_name]] <- generate_transition_matrix_alt_old(summary_df, summary_df2, age_class, gender)
  }
}


transition_matrices_alt_old

names(transition_matrices_alt_old) <- NULL  

males_alt_old <- transition_matrices_alt_old[1:10]
females_alt_old <- transition_matrices_alt_old[11:20]

matrices_mf_alt_old <- list(males_alt_old, females_alt_old)
matrices_mf_old

for (i in 1:length(males_alt_old)) {
  colnames(males_alt_old[[i]]) <- c("P.m", "MPD.m", "APD.m", "D.m")
  col_names_m <- c("P.m", "MPD.m", "APD.m", "D.m") 
  rownames(males_alt_old[[i]]) <- c("P.m", "MPD.m", "APD.m", "D.m")
  row_names_m <- c("P.m", "MPD.m", "APD.m", "D.m") 
}
for (i in 1:length(females_alt_old)) {
  colnames(females_alt_old[[i]]) <- c("P.f", "MPD.f", "APD.f", "D.f")
  col_names_f <- c("P.f", "MPD.f", "APD.f", "D.f")
  rownames(females_alt_old[[i]]) <- c("P.f", "MPD.f", "APD.f", "D.f")
  row_names_f <- c("P.f", "MPD.f", "APD.f", "D.f")
}
for (i in 1:length(males_alt_old)) {
  dimnames(males_alt_old[[i]]) <- list(row_names_m, col_names_m)
}
for (i in 1:length(females_alt_old)) {
  dimnames(females_alt_old[[i]]) <- list(row_names_f, col_names_f)
}

transition_matrices_mf_alt_old <- list(males_alt_old, females_alt_old)
transition_matrices_mf_alt_old
transition_matrices_m_alt_old <- transition_matrices_mf_alt_old[[1]]
transition_matrices_f_alt_old <- transition_matrices_mf_alt_old[[2]]

extract_rows_as_named_list <- function(matrix) {
  list(
    P = setNames(as.numeric(matrix[1, ]), c("P", "MPD", "APD", "D")),
    MPD = setNames(as.numeric(matrix[2, ]), c("P", "MPD", "APD", "D")),
    APD = setNames(as.numeric(matrix[3, ]), c("P", "MPD", "APD", "D")),
    D = setNames(as.numeric(matrix[4, ]), c("P", "MPD", "APD", "D"))
  )
}

transition_prob_m_alt_old <- lapply(transition_matrices_m_alt_old, extract_rows_as_named_list)

transition_prob_f_alt_old <- lapply(transition_matrices_f_alt_old, extract_rows_as_named_list)

print("Transition Probabilities for Males:")
print(transition_prob_m_alt_old)

print("Transition Probabilities for Females:")
print(transition_prob_f_alt_old)
```

The graph showcasing probabilities of death with respect to severity:

```{r}
severity_labels <- c("Prodromal", "Mild", "Advanced")

# Extracting probabilities of death from matrices
extract_probabilities <- function(matrices, age_classes, genders) {
  data <- data.frame()
  
  for (i in 1:length(matrices)) {
    age_class <- age_classes[i]
    matrix <- matrices[[i]]
    
    data <- rbind(data, data.frame(
      age_class = age_class,
      gender = genders,
      severity = severity_labels[1],
      probability_of_death = matrix[1, 4]
    ))
    
    data <- rbind(data, data.frame(
      age_class = age_class,
      gender = genders,
      severity = severity_labels[2],
      probability_of_death = matrix[2, 4]
    ))
    
    data <- rbind(data, data.frame(
      age_class = age_class,
      gender = genders,
      severity = severity_labels[3],
      probability_of_death = matrix[3, 4]
    ))
  }
  
  return(data)
}

# Extracting data for males/females
males_data_alt_old <- extract_probabilities(males_alt_old, age_classes, "Male")
females_data_alt_old <- extract_probabilities(females_alt_old, age_classes, "Female")

final_data_alt_old <- rbind(males_data_alt_old, females_data_alt_old)

# Let's apply the adjustment
final_data_alt1_old <- final_data_alt_old %>%
  group_by(gender) %>% 
  mutate(probability_of_death = ifelse(
    age_class == "95et+" & severity == "Prodromal",
    probability_of_death[age_class == "95et+" & severity == "Mild"] -
      (probability_of_death[age_class == "90-94" & severity == "Mild"] -
       probability_of_death[age_class == "90-94" & severity == "Prodromal"]),
    probability_of_death
  ))

graph_prob_mf_alt <- ggplot(final_data_alt1_old, aes(x = age_class, y = probability_of_death, color = severity, group = severity)) +
  geom_line() +
  geom_point() +
  facet_wrap(~ gender) +
  scale_color_manual(values = c("Prodromal" = "green", "Mild" = "orange", "Advanced" = "red")) +
  theme_minimal() +
  labs(title = "Probability of death with respect to severity, alternative scenario",
       x = "Age class",
       y = "Probability",
       color = "Severity") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
graph_prob_mf_alt
```

Considering the alternative scenario A1, the proposed assumption is to consider a 1-year delay in the onset of APD thanks to AI-based early detection. The manipulation of the prodromal period should not be considered as this stage cannot be precisely detected by definition, as well as the rigor of the criteria used to distinguish between MPD and APD should not be varied as such variation is already used to tackle the issue related to the unclear definition of APD.  The new approach suggests that physicians will be able to slow down the progression of PD thanks to an aggressive early treatment of the disease, resulting in a higher probability of remaining in the mild stage (P(MPD→MPD)) which proportionally reduces the probability of transitioning to the severe stage (P(MPD→APD)) and the probability of dying (P(MPD→D)).
The increase in P(MPD→MPD) is modeled through the following formula: 

$$ p^\prime=\ p^\frac{60-x}{60} $$
where p’ is the new probability, p is the initial probability, 60 is the number of months for the 5-year period and x is the number of additional months of the mild stage gained due to early detection. Accordingly, the positive gain in P(MPD→APD) is defined as:

$$ \mathrm{\Delta}\ =\ p^\prime\ -\ p $$
This gain is counterbalanced by a proportional redistribution of its negative value, - delta, among the other two transition probabilities having MPD as the initial state, namely P(MPD→APD) and P(MPD→D).  For this purpose, the negative gain is decomposed into:

$$ -\ \mathrm{\Delta}\ =\ -\ \Delta(\mathrm{MPD} \rightarrow \mathrm{APD})\ -\ \Delta(\mathrm{MPD} \rightarrow \mathrm{D}) $$ 

The two components are proportional to the initial probabilities computed in the baseline scenario:

$$ \Delta(\mathrm{MPD} \rightarrow \mathrm{APD}) = \frac{p(\mathrm{MPD} \rightarrow \mathrm{APD})}{p(\mathrm{MPD} \rightarrow \mathrm{APD}) + p(\mathrm{MPD} \rightarrow \mathrm{D})} \ \mathrm{\Delta} $$
$$ \Delta(\mathrm{MPD} \rightarrow \mathrm{D}) = \frac{p(\mathrm{MPD} \rightarrow \mathrm{D})}{p(\mathrm{MPD} \rightarrow \mathrm{APD}) + p(\mathrm{MPD} \rightarrow \mathrm{D})} \ \mathrm{\Delta} $$

Consequently, the new probabilities for the alternative scenario are defined as:

$$ p'(\mathrm{MPD} \rightarrow \mathrm{APD}) = p(\mathrm{MPD} \rightarrow \mathrm{APD}) - \Delta(\mathrm{MPD} \rightarrow \mathrm{APD}) $$

$$ p'(\mathrm{MPD} \rightarrow \mathrm{D}) = p(\mathrm{MPD} \rightarrow \mathrm{D}) - \Delta(\mathrm{MPD} \rightarrow \mathrm{D}) $$ 

In this way, the sum to 1 for the second row of the transition matrices is ensured in the alternative scenario A1.

```{r}
# Adjust probability_of_death for 95+ patients
final_data1_alt <- final_data_alt_old %>%
  group_by(gender) %>%
  mutate(probability_of_death = ifelse(
    age_class == "95et+" & severity == "Prodromal",
    probability_of_death[age_class == "95et+" & severity == "Mild"] -
      (probability_of_death[age_class == "90-94" & severity == "Mild"] -
       probability_of_death[age_class == "90-94" & severity == "Prodromal"]),
    probability_of_death
  ))

age_classes <- c("50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85-89", "90-94", "95et+")
genders <- c("Male", "Female")

# Update f_prob1 with correct probabilities
f_prob1 <- f_prob %>%
  mutate(
    F = case_when(
      `Age class` == "95et+" & Gender == "Male" ~ final_data1_alt %>% filter(gender == "Male", age_class == "95et+") %>% pull(probability_of_death) %>% first(),
      `Age class` == "95et+" & Gender == "Female" ~ final_data1_alt %>% filter(gender == "Female", age_class == "95et+") %>% pull(probability_of_death) %>% first(),
      TRUE ~ F
    )
  )

# Function to generate transition matrix
generate_transition_matrix_alt <- function(summary_df, summary_df2, final_data1_alt, age_class, gender_name) {
  x <- matrix(NA, nrow = 4, ncol = 4)
  x[1, 1] <- 0

  f_prob2 <- f_prob1 %>%
    filter(`Age class` == age_class & Gender == gender_name) %>%
    pull(F)
   
  x[1, 2] <- 1 - f_prob2
  x[1, 3] <- 0
  x[1, 4] <- f_prob2

  x[2, 1] <- 0

  numerator_MPD_APD <- summary_df1 %>%
    filter(CLA_AGE_5 == age_class & gender == gender_name & severity == "Transitioned" & yod_binary == "Alive") %>%
    summarise(n_patients = sum(n_patients)) %>%
    pull(n_patients)

  numerator_MPD_MPD <- summary_df %>%
    filter(CLA_AGE_5 == age_class & gender == gender_name & severity == "Mild" & yod_binary == "Alive") %>%
    summarise(n_patients = sum(n_patients)) %>%
    pull(n_patients)

  numerator_MPD_D <- summary_df %>%
    filter(CLA_AGE_5 == age_class & gender == gender_name & severity %in% c("Mild", "Transitioned") & yod_binary == "Dead") %>%
    summarise(n_patients = sum(n_patients)) %>%
    pull(n_patients)

  denominator_MPD <- summary_df %>%
    filter(CLA_AGE_5 == age_class & gender == gender_name & severity %in% c("Mild", "Transitioned")) %>%
    summarise(n_patients = sum(n_patients)) %>%
    pull(n_patients)

  if (length(numerator_MPD_D) > 0 && length(denominator_MPD) > 0 && denominator_MPD != 0) {
    x[2, 4] <- numerator_MPD_D / denominator_MPD
  } else {
    x[2, 4] <- NA
  }

  if (length(numerator_MPD_D) > 0 && length(denominator_MPD) > 0 && denominator_MPD != 0) {
    x[2, 3] <- 1 - (numerator_MPD_D / denominator_MPD) - ((numerator_MPD_MPD / denominator_MPD)^(4/5))
  } else {
    x[2, 3] <- NA
  }

  x[2, 2] <- ifelse(length(numerator_MPD_MPD) > 0 && length(denominator_MPD) > 0 && denominator_MPD != 0, 
                    (numerator_MPD_MPD / denominator_MPD)^(4/5), NA)

  x[3, 1] <- 0
  x[3, 2] <- 0
  numerator_APD_D <- summary_df2 %>%
    filter(CLA_AGE_5 == age_class, gender == gender_name, severity_at_end == "Severe", yod_binary == "Dead") %>%
    summarise(n_patients = sum(n_patients)) %>%
    pull(n_patients)
  
  denominator_APD_D <- summary_df2 %>%
    filter(CLA_AGE_5 == age_class, gender == gender_name, severity_at_end == "Severe") %>%
    summarise(n_patients = sum(n_patients)) %>%
    pull(n_patients)

  if (length(numerator_APD_D) > 0 && length(denominator_APD_D) > 0 && denominator_APD_D != 0) {
    x[3, 4] <- numerator_APD_D / denominator_APD_D
    x[3, 3] <- 1 - x[3, 4]
  } else {
    x[3, 4] <- NA
    x[3, 3] <- NA
  }

  x[4, 1] <- 0
  x[4, 2] <- 0
  x[4, 3] <- 0
  x[4, 4] <- 1

  return(x)
}

transition_matrices_alt1 <- list()

for (gender in genders) {
  for (age_class in age_classes) {
    matrix_name <- paste(gender, age_class, sep = "_")
    transition_matrices_alt1[[matrix_name]] <- generate_transition_matrix_alt(summary_df, summary_df2, final_data1_alt, age_class, gender)
  }
}

names(transition_matrices_alt1) <- NULL  

males_alt1 <- transition_matrices_alt1[1:10]
females_alt1 <- transition_matrices_alt1[11:20]

matrices_mf_alt1 <- list(males_alt1, females_alt1)

for (i in 1:length(males_alt1)) {
  colnames(males_alt1[[i]]) <- c("P.m", "MPD.m", "APD.m", "D.m")
  rownames(males_alt1[[i]]) <- c("P.m", "MPD.m", "APD.m", "D.m")
}
for (i in 1:length(females_alt1)) {
  colnames(females_alt1[[i]]) <- c("P.f", "MPD.f", "APD.f", "D.f")
  rownames(females_alt1[[i]]) <- c("P.f", "MPD.f", "APD.f", "D.f")
}

transition_matrices_m_alt1 <- matrices_mf_alt1[[1]]
transition_matrices_f_alt1 <- matrices_mf_alt1[[2]]

extract_rows_as_named_list <- function(matrix) {
  list(
    P = setNames(as.numeric(matrix[1, ]), c("P", "MPD", "APD", "D")),
    MPD = setNames(as.numeric(matrix[2, ]), c("P", "MPD", "APD", "D")),
    APD = setNames(as.numeric(matrix[3, ]), c("P", "MPD", "APD", "D")),
    D = setNames(as.numeric(matrix[4, ]), c("P", "MPD", "APD", "D"))
  )
}

transition_prob_m_alt1 <- lapply(transition_matrices_m_alt1, extract_rows_as_named_list)
transition_prob_f_alt1 <- lapply(transition_matrices_f_alt1, extract_rows_as_named_list)

print("Transition Probabilities for Males:")
print(transition_prob_m_alt1)

print("Transition Probabilities for Females:")
print(transition_prob_f_alt1)

# Function to calculate delta
calculate_delta <- function(baseline, alt) {
  delta <- alt - baseline
  return(delta)
}

# Function to update transition probabilities based on delta distribution
update_transition_probabilities <- function(transition_prob_m, transition_prob_f, transition_prob_m_alt1, transition_prob_f_alt1) {
  for (i in 1:length(transition_prob_m)) {
    # Extract baseline and alternative matrices
    baseline_matrix_m <- transition_prob_m[[i]]$MPD
    alt_matrix_m <- transition_prob_m_alt1[[i]]$MPD
    baseline_matrix_f <- transition_prob_f[[i]]$MPD
    alt_matrix_f <- transition_prob_f_alt1[[i]]$MPD
    
    # Baseline and alternative [2,2] elements
    baseline_m_MPD <- baseline_matrix_m["MPD"]
    alt_m_MPD <- alt_matrix_m["MPD"]
    
    baseline_f_MPD <- baseline_matrix_f["MPD"]
    alt_f_MPD <- alt_matrix_f["MPD"]
    
    # Calculate deltas
    delta_m <- calculate_delta(baseline_m_MPD, alt_m_MPD)
    delta_f <- calculate_delta(baseline_f_MPD, alt_f_MPD)
    
    # Calculate baseline probabilities
    p_m_APD <- baseline_matrix_m["APD"]
    p_m_D <- baseline_matrix_m["D"]
    p_f_APD <- baseline_matrix_f["APD"]
    p_f_D <- baseline_matrix_f["D"]
    
    # Calculate delta distribution for males
    sum_m_APD_D <- p_m_APD + p_m_D
    delta_m_APD <- (p_m_APD / sum_m_APD_D) * delta_m
    delta_m_D <- (p_m_D / sum_m_APD_D) * delta_m
    
    # Calculate delta distribution for females
    sum_f_APD_D <- p_f_APD + p_f_D
    delta_f_APD <- (p_f_APD / sum_f_APD_D) * delta_f
    delta_f_D <- (p_f_D / sum_f_APD_D) * delta_f
    
    # Update alternative transition probabilities for males
    transition_prob_m_alt1[[i]]$MPD["APD"] <- baseline_matrix_m["APD"] - delta_m_APD
    transition_prob_m_alt1[[i]]$MPD["D"] <- baseline_matrix_m["D"] - delta_m_D
    
    # Update alternative transition probabilities for females
    transition_prob_f_alt1[[i]]$MPD["APD"] <- baseline_matrix_f["APD"] - delta_f_APD
    transition_prob_f_alt1[[i]]$MPD["D"] <- baseline_matrix_f["D"] - delta_f_D
  }
  return(list(transition_prob_m_alt1, transition_prob_f_alt1))
}

# Call the function to update transition probabilities
updated_transition_probs <- update_transition_probabilities(transition_prob_m, transition_prob_f, transition_prob_m_alt1, transition_prob_f_alt1)
transition_prob_m_alt <- updated_transition_probs[[1]]
transition_prob_f_alt <- updated_transition_probs[[2]]

print("Updated Transition Probabilities for Males (Alternative Scenario):")
print(transition_prob_m_alt)

print("Updated Transition Probabilities for Females (Alternative Scenario):")
print(transition_prob_f_alt)

males_alt <- lapply(transition_prob_m_alt, function(prob) {
  matrix(c(prob$P, prob$MPD, prob$APD, prob$D), nrow = 4, byrow = TRUE)
})
females_alt <- lapply(transition_prob_f_alt, function(prob) {
  matrix(c(prob$P, prob$MPD, prob$APD, prob$D), nrow = 4, byrow = TRUE)
})

for (i in 1:length(males_alt)) {
  colnames(males_alt[[i]]) <- c("P.m", "MPD.m", "APD.m", "D.m")
  rownames(males_alt[[i]]) <- c("P.m", "MPD.m", "APD.m", "D.m")
}
for (i in 1:length(females_alt)) {
  colnames(females_alt[[i]]) <- c("P.f", "MPD.f", "APD.f", "D.f")
  rownames(females_alt[[i]]) <- c("P.f", "MPD.f", "APD.f", "D.f")
}

print("Updated Transition Matrices for Males (Alternative Scenario):")
print(males_alt)

print("Updated Transition Matrices for Females (Alternative Scenario):")
print(females_alt)
```

The graph showcasing probabilities of remaining MPD:

```{r}
extract_probabilities2_alt <- function(matrices, age_classes, genders) {
  data <- data.frame()
  
  for (i in 1:length(matrices)) {
    age_class <- age_classes[i]
    matrix <- matrices[[i]]
    
    data <- rbind(data, data.frame(
      age_class = age_class,
      gender = genders,
      severity = severity_labels[2],
      probability_of_remainingMPD = matrix[2, 2]
    ))
    
  }
  
  return(data)
}

males_data_rem_alt <- extract_probabilities2_alt(males_alt, age_classes, "Male")
females_data_rem_alt <- extract_probabilities2_alt(females_alt, age_classes, "Female")

final_data_rem_alt <- rbind(males_data_rem_alt, females_data_rem_alt)

graph_prob_mf_rem_alt <- ggplot(final_data_rem_alt, aes(x = age_class, y = probability_of_remainingMPD, colour = gender, group = gender)) +
  geom_line() +
  geom_point() +
  facet_wrap(~ gender) +
  theme_minimal() +
  labs(title = "Probability of remaining MPD with respect to gender and age classes, alternative scenario",
       x = "Age class",
       y = "Probability") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), plot.title = element_text(size = 10))
graph_prob_mf_rem_alt
```


The graph showcasing probabilities of transitioning from MPD to APD is:

```{r}
extract_probabilities1 <- function(matrices, age_classes, genders) {
  data <- data.frame()
  
  for (i in 1:length(matrices)) {
    age_class <- age_classes[i]
    matrix <- matrices[[i]]
    
    data <- rbind(data, data.frame(
      age_class = age_class,
      gender = genders,
      severity = severity_labels[2],
      probability_of_transitioning = matrix[2, 3]
    ))
    
  }
  
  return(data)
}

males_data_tra_alt <- extract_probabilities1(males_alt, age_classes, "Male")
females_data_tra_alt <- extract_probabilities1(females_alt, age_classes, "Female")

final_data_tra_alt <- rbind(males_data_tra_alt, females_data_tra_alt)

graph_prob_mf_tra_alt <- ggplot(final_data_tra_alt, aes(x = age_class, y = probability_of_transitioning, colour = gender, group = gender)) +
  geom_line() +
  geom_point() +
  facet_wrap(~ gender) +
  theme_minimal() +
  labs(title = "Probability of transitioning from MPD to APD with respect to gender and age classes, alternative scenario",
       x = "Age class",
       y = "Probability") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), plot.title = element_text(size = 10))
graph_prob_mf_tra_alt
```

Comparison across scenarios (probability of remaining MPD):

```{r}
extract_probabilities_comb1 <- function(matrices, age_classes, genders, scenario) {
  data <- data.frame()
  
  for (i in 1:length(matrices)) {
    age_class <- age_classes[i]
    matrix <- matrices[[i]]
    
    data <- rbind(data, data.frame(
      age_class = age_class,
      gender = genders,
      severity = severity_labels[2],
      probability_of_remainingMPD = matrix[2, 2],
      scenario = scenario
    ))
    
  }
  
  return(data)
}

# Extract data for baseline scenario
males_data_rem_comb <- extract_probabilities_comb1(males, age_classes, "Male", "Baseline")
females_data_rem_comb <- extract_probabilities_comb1(females, age_classes, "Female", "Baseline")

# Extract data for alternative scenario
males_data_rem_alt_comb <- extract_probabilities_comb1(males_alt, age_classes, "Male", "Alternative")
females_data_rem_alt_comb <- extract_probabilities_comb1(females_alt, age_classes, "Female", "Alternative")

# Combine all data
final_data_rem_comb <- rbind(males_data_rem_comb, females_data_rem_comb, males_data_rem_alt_comb, females_data_rem_alt_comb)

# Create the combined graph
graph_prob_mf_rem_combined <- ggplot(final_data_rem_comb, aes(x = age_class, y = probability_of_remainingMPD, colour = scenario, group = scenario)) +
  geom_line() +
  geom_point() +
  facet_wrap(~ gender) +
  theme_minimal() +
  labs(title = "Probability of remaining MPD: comparison across scenarios",
       x = "Age class",
       y = "Probability",
       colour = "Scenario") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), plot.title = element_text(size = 10))

graph_prob_mf_rem_combined
```

Comparison across scenarios (probability of transitioning from MPD to APD):

```{r}
extract_probabilities_comb2 <- function(matrices, age_classes, genders, scenario) {
  data <- data.frame()
  
  for (i in 1:length(matrices)) {
    age_class <- age_classes[i]
    matrix <- matrices[[i]]
    
    data <- rbind(data, data.frame(
      age_class = age_class,
      gender = genders,
      severity = severity_labels[2],
      probability_of_transitioning = matrix[2, 3],
      scenario = scenario
    ))
    
  }
  
  return(data)
}

# Extract data for baseline scenario
males_data_tra_comb <- extract_probabilities_comb2(males, age_classes, "Male", "Baseline")
females_data_tra_comb <- extract_probabilities_comb2(females, age_classes, "Female", "Baseline")

# Extract data for alternative scenario
males_data_tra_alt_comb <- extract_probabilities_comb2(males_alt, age_classes, "Male", "Alternative")
females_data_tra_alt_comb <- extract_probabilities_comb2(females_alt, age_classes, "Female", "Alternative")

# Combine all data
final_data_tra_comb <- rbind(males_data_tra_comb, females_data_tra_comb, males_data_tra_alt_comb, females_data_tra_alt_comb)

# Create the combined graph
graph_prob_mf_tra_combined <- ggplot(final_data_tra_comb, aes(x = age_class, y = probability_of_transitioning, colour = scenario, group = scenario)) +
  geom_line() +
  geom_point() +
  facet_wrap(~ gender) +
  theme_minimal() +
  labs(title = "Probability of transitioning from MPD to APD: comparison across scenarios",
       x = "Age class",
       y = "Probability",
       colour = "Scenario") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), plot.title = element_text(size = 10))

graph_prob_mf_tra_combined
```

Comparison across scenarios (probability of dying when MPD):

```{r}
extract_probabilities_comb3 <- function(matrices, age_classes, genders, scenario) {
  data <- data.frame()
  
  for (i in 1:length(matrices)) {
    age_class <- age_classes[i]
    matrix <- matrices[[i]]
    
    data <- rbind(data, data.frame(
      age_class = age_class,
      gender = genders,
      severity = severity_labels[2],
      probability_of_dyingMPD = matrix[2, 4],
      scenario = scenario
    ))
    
  }
  
  return(data)
}

# Extract data for baseline scenario
males_data_die_comb <- extract_probabilities_comb3(males, age_classes, "Male", "Baseline")
females_data_die_comb <- extract_probabilities_comb3(females, age_classes, "Female", "Baseline")

# Extract data for alternative scenario
males_data_die_alt_comb <- extract_probabilities_comb3(males_alt, age_classes, "Male", "Alternative")
females_data_die_alt_comb <- extract_probabilities_comb3(females_alt, age_classes, "Female", "Alternative")

# Combine all data
final_data_die_comb <- rbind(males_data_die_comb, females_data_die_comb, males_data_die_alt_comb, females_data_die_alt_comb)

# Create the combined graph
graph_prob_mf_die_combined <- ggplot(final_data_die_comb, aes(x = age_class, y = probability_of_dyingMPD, colour = scenario, group = scenario)) +
  geom_line() +
  geom_point() +
  facet_wrap(~ gender) +
  theme_minimal() +
  labs(title = "Probability of dying when MPD: comparison across scenarios",
       x = "Age class",
       y = "Probability",
       colour = "Scenario") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), plot.title = element_text(size = 10))

graph_prob_mf_die_combined
```

The new version of the microsimulation model is to be initialized:

```{r}
n.i <- 26000 #number of newly diagnosed PD patients in 2020, according to the French public health agency. This institution also claims that PD is approximately 1.5 times more frequent in men than women
n_males <- n.i * 0.6
n_females <- n.i * 0.4
n.t <- 15 #number of cycles of the model: starting from 2020, 2 5-year cycles are necessary to reach 2030
n.sim <- 100 #number of simulations. The higher the number of simulations, the more precise the results of the model, but the processing power at hand should be taken into account when setting this number.
v.n <- c("P", "MPD", "APD", "D") # model states
n.s <- length(v.n) # number of health states
v.M_1_males <- rep("P", n_males) #everyone begins in the prodromal stage
v.M_1_females <- rep("P", n_females) #everyone begins in the prodromal stage
d.c.1 <- ((1+0.025)^5) - 1 # 5-year discount rate for costs, assuming a annual discount rate of 2.5% for the 2020-2070 period
d.c.2 <- ((1+0.015)^5) - 1 # 5-year discount rate for costs, assuming a annual discount rate of 1.5% for the 2070-2095 period
```

Costs in alternative scenarios are slightly different from those of the baseline scenario due to anticipation in the detection of the disease. In particular, the 1-year gain in delaying the onset of PD is associated with an early detection of 2 years, resulting in an early treatment of prodromal patients. All patients begin the model as prodromal in “cycle 0”, after which they either transition to MPD or pass away in “cycle 1” and this means that these patients are treated 2 years in advance before the beginning of “cycle 1”. Accordingly, the additional medical expense is equal to the 2 fifths of “c”, which is the average extra cost of a MPD patient during the 5-year cycle of the model.
Furthermore, it is essential to note that prodromal patients in the preclinical phase of the disease are administered lower drug dosages compared to those experiencing mild symptoms. Consequently, the incremental medical expenditure should be multiplied by a reduction factor, defined as 'lambda'. In the absence of public health directives for treating these patients, 'lambda' is assigned a value of 0.5, subject to potential modification in subsequent studies. 

```{r, warning=FALSE, message=FALSE}
#Males
lambda <- 0.5
transition_costs_m_alt <- list()
for (cycle in 1:10) {
  c.P.m <- costs_model_males[[cycle, "cp"]] + (lambda*(2/5)*costs_model_males[[cycle, "c"]])
  c.MPD.m <- costs_model_males[[cycle, "c"]]
  c.APD.m <- costs_model_males[[cycle, "C"]]
  c.D.m <- costs_model_males[[cycle, "D"]]
  transition_costs_m_alt[[cycle]] <- list(
    "P" = c(c.P.m),
    "MPD" = c(c.MPD.m),
    "APD" = c(c.APD.m),
    "D" = c(c.D.m)
  )
  
}

#Costs are repeated for 95+
last_transition_m_alt <- transition_costs_m_alt[[10]]
for (i in 11:n.t) {
  transition_costs_m_alt[[i]] <- last_transition_m_alt
}
print(transition_costs_m_alt)

#Females
transition_costs_f_alt <- list()
for (cycle in 1:10) {
  c.P.f <- costs_model_females[[cycle, "cp"]] + (lambda*(2/5)*costs_model_females[[cycle, "c"]])
  c.MPD.f <- costs_model_females[[cycle, "c"]]
  c.APD.f <- costs_model_females[[cycle, "C"]]
  c.D.f <- costs_model_females[[cycle, "D"]]
  transition_costs_f_alt[[cycle]] <- list(
    "P" = c(c.P.f),
    "MPD" = c(c.MPD.f),
    "APD" = c(c.APD.f),
    "D" = c(c.D.f)
  )
  
}

#Costs are repeated for 95+
last_transition_f_alt <- transition_costs_f_alt[[10]]
for (i in 11:n.t) {
  transition_costs_f_alt[[i]] <- last_transition_f_alt
}

print(transition_costs_f_alt)
```

The microsimulation function for male patients is:

```{r}
m.M <- m.C <-  matrix(nrow = n_males,
                      ncol = n.t + 1,
                      dimnames = list(paste("ind", 1:n_males, sep = " "), paste("cycle", 0:n.t, sep = " "))) 
m.M[, 1] <- v.M_1_males
```

```{r, warning=FALSE, message=FALSE}
#Males
Probs <- function(state){
  return(transition_prob_m_alt[[state]])
}
Costs <- function(state) {
  return(transition_costs_m[[state]])
}

# Testing 
set.seed(1) #deterministic sequence of random numbers

transition_prob_m_alt <- transition_prob_m_alt %>% 
  map(~ map(.x, ~ sort(.x, decreasing = TRUE)))
loop_microsim_alt <- function(n.t) {
     for (t in 1:n.t) {
      m.p <- m.M_alt[, t]
# calculate the transition probabilities at cycle t
     #state <- list("P", "MPD", "APD","D")
      for (i in 1:length(m.p)) {
        current_state <- m.p[i]
        new_state <- m.p[i]
         if (t > 10) {
           new_state <- sample(names(transition_prob_m_alt[[10]][[current_state]]), 1, prob = transition_prob_m_alt[[10]][[current_state]])
         } else {
           new_state <- sample(names(transition_prob_m_alt[[t]][[current_state]]), 1, prob = transition_prob_m_alt[[t]][[current_state]])
         }
        m.M_alt[i, t + 1] <- new_state
        #m.C[i, t + 1] <- Costs(current_state)
      }   
    } # close the loop for the time points
  return(m.M_alt)
}

# Init m.M #repeat it!!!!
model_results_m_alt <- list()
for(i in 1:n.sim) {
m.M_alt <- m.C_alt <-  matrix(nrow = n_males,
                      ncol = n.t + 1,
                      dimnames = list(paste("ind", 1:n_males, sep = " "), paste("cycle", 0:n.t, sep = " "))) 
m.M_alt[, 1] <- v.M_1_males
# Microsim loop
model_results_m_alt[[i]] <- loop_microsim_alt(n.t)
print(i)
} 
# repeat it!!!


#Results of the median simulation, the 50th
model_results_m_alt[[50]][1:300, ]
df_m.M_alt <- model_results_m_alt[[50]] %>% as.tibble()
library(janitor)
map(
  c("cycle 0", "cycle 1", "cycle 2", "cycle 3", "cycle 4", "cycle 5",
    "cycle 6", "cycle 7", "cycle 8", "cycle 9", "cycle 10", "cycle 11", "cycle 12", "cycle 13", "cycle 14"),
  ~ df_m.M_alt %>% tabyl(!!sym(.x))
)

# Transition costs in a dataframe
transition_costs_m_alt <-
 transition_costs_m_alt %>% 
  data.table::rbindlist() %>% 
  t() %>% 
  as_tibble(rownames = "Stage") %>% 
  rename_with(~ c("Stage", "cycle 0", "cycle 1", "cycle 2", "cycle 3", "cycle 4",
   "cycle 5", "cycle 6", "cycle 7", "cycle 8", "cycle 9", "cycle 10", "cycle 11", "cycle 12", "cycle 13", "cycle 14")) %>% 
  pivot_longer(cols = -Stage, names_to = "cycle", values_to = "cost")


final_cost_m_alt <-
  map(
    model_results_m_alt,
    ~ .x %>% 
      as_tibble() %>% 
      mutate(id = row_number()) %>% 
      pivot_longer(cols = -id, names_to = "cycle", values_to = "Stage") %>% 
      left_join(
        transition_costs_m_alt
      )
  )
  

final_cost_m2_alt <-
  map(
    final_cost_m_alt,
    ~ .x %>% 
      group_by(cycle) %>% 
      summarise(
      n = n(),
      sum_costs = sum(cost, na.rm = TRUE)
    ) %>% 
    mutate(cycle = as_factor (cycle) %>%  fct_relevel(c("cycle 0", "cycle 1", "cycle 2", "cycle 3", "cycle 4", "cycle 5", "cycle 6", "cycle 7", "cycle 8", "cycle 9", "cycle 10", "cycle 11", "cycle 12", "cycle 13", "cycle 14"))) %>%  arrange(cycle) %>% 
     filter(cycle != "cycle 15")
  )
final_cost_m2_alt
```

```{r}
m.M <- m.C <-  matrix(nrow = n_females,
                      ncol = n.t + 1,
                      dimnames = list(paste("ind", 1:n_females, sep = " "), paste("cycle", 0:n.t, sep = " "))) 
m.M[, 1] <- v.M_1_females
```


The same reasoning is applied to female patients:

```{r, warning=FALSE, message=FALSE}
#Females
Probs <- function(state){
  return(transition_prob_f_alt[[state]])
}
Costs <- function(state) {
  return(transition_costs_f[[state]])
}
# Testing 
set.seed(1) #deterministic sequence of random numbers

transition_prob_f_alt <- transition_prob_f_alt %>% 
  map(~ map(.x, ~ sort(.x, decreasing = TRUE)))
loop_microsim_alt <- function(n.t) {
     for (t in 1:n.t) {
      m.p <- m.M_alt[, t]
# calculate the transition probabilities at cycle t
     #state <- list("P", "MPD", "APD","D")
      for (i in 1:length(m.p)) {
        current_state <- m.p[i]
        new_state <- m.p[i]
         if (t > 10) {
           new_state <- sample(names(transition_prob_f_alt[[10]][[current_state]]), 1, prob = transition_prob_f_alt[[10]][[current_state]])
         } else {
           new_state <- sample(names(transition_prob_f_alt[[t]][[current_state]]), 1, prob = transition_prob_f_alt[[t]][[current_state]])
         }
        m.M_alt[i, t + 1] <- new_state
        #m.C[i, t + 1] <- Costs(current_state)
      }   
    } # close the loop for the time points
  return(m.M_alt)
}

# Init m.M #repeat it!!!!
model_results_f_alt <- list()
for(i in 1:n.sim) {
m.M_alt <- m.C_alt <-  matrix(nrow = n_females,
                      ncol = n.t + 1,
                      dimnames = list(paste("ind", 1:n_females, sep = " "), paste("cycle", 0:n.t, sep = " "))) 
m.M_alt[, 1] <- v.M_1_females
# Microsim loop
model_results_f_alt[[i]] <- loop_microsim_alt(n.t)
print(i)
}  
# repeat it!!!

#Results of the median simulation, the 50th
model_results_f_alt[[50]][1:300, ]
df_m.M_alt <- model_results_f_alt[[50]] %>% as.tibble()
library(janitor)
map(
  c("cycle 0", "cycle 1", "cycle 2", "cycle 3", "cycle 4", "cycle 5",
    "cycle 6", "cycle 7", "cycle 8", "cycle 9", "cycle 10", "cycle 11", "cycle 12", "cycle 13", "cycle 14"),
  ~ df_m.M_alt %>% tabyl(!!sym(.x))
)

#Transition costs
transition_costs_f_alt <-
  transition_costs_f_alt %>% 
  data.table::rbindlist() %>% 
  t() %>% 
  as_tibble(rownames = "Stage") %>% 
  rename_with(~ c("Stage", "cycle 0", "cycle 1", "cycle 2", "cycle 3", "cycle 4",
    "cycle 5", "cycle 6", "cycle 7", "cycle 8", "cycle 9", "cycle 10", "cycle 11", "cycle 12", "cycle 13", "cycle 14")) %>% 
  pivot_longer(cols = -Stage, names_to = "cycle", values_to = "cost")

final_cost_f_alt <- map(
    model_results_f_alt,
    ~ .x %>% 
      as_tibble() %>% 
      mutate(id = row_number()) %>% 
      pivot_longer(cols = -id, names_to = "cycle", values_to = "Stage") %>% 
      left_join(
        transition_costs_f_alt
      )
  )
 

final_cost_f2_alt <-
  map(
    final_cost_f_alt,
    ~ .x %>% 
      group_by(cycle) %>% 
      summarise(
      n = n(),
      sum_costs = sum(cost, na.rm = TRUE)
    ) %>% 
    mutate(cycle = as_factor (cycle) %>%  fct_relevel(c("cycle 0", "cycle 1", "cycle 2", "cycle 3", "cycle 4", "cycle 5", "cycle 6", "cycle 7", "cycle 8", "cycle 9", "cycle 10", "cycle 11", "cycle 12", "cycle 13", "cycle 14"))) %>%  arrange(cycle) %>% 
    filter(cycle != "cycle 15")
  )
final_cost_f2_alt
```

The variability of costs over 30 simulations is observed through a box plot:

```{r}
#Males
final_cost_m2_alt_combined <- bind_rows(final_cost_m2_alt)

final_cost_m2_alt_combined$cycle <- factor(final_cost_m2_alt_combined$cycle, 
                                           levels = c("cycle 0", "cycle 1", "cycle 2", "cycle 3", "cycle 4", 
                                                      "cycle 5", "cycle 6", "cycle 7", "cycle 8", "cycle 9", "cycle 10", "cycle 11", "cycle 12", "cycle 13", "cycle 14"))

var_graph_m_alt <- ggplot(final_cost_m2_alt_combined, aes(x = cycle, y = sum_costs)) +
  geom_boxplot(width = 0.9) +  
  labs(title = "Box Plot of Total Costs per Cycle, Alternative Scenario (Males)",
       x = "Cycle",
       y = "Variability") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
var_graph_m_alt

#Females
final_cost_f2_alt_combined <- bind_rows(final_cost_f2_alt)

final_cost_f2_alt_combined$cycle <- factor(final_cost_f2_alt_combined$cycle, 
                                           levels = c("cycle 0", "cycle 1", "cycle 2", "cycle 3", "cycle 4", 
                                                      "cycle 5", "cycle 6", "cycle 7", "cycle 8", "cycle 9", "cycle 10", "cycle 11", "cycle 12", "cycle 13", "cycle 14"))

var_graph_f_alt <- ggplot(final_cost_f2_alt_combined, aes(x = cycle, y = sum_costs)) +
  geom_boxplot(width = 0.9) +  
  labs(title = "Box Plot of Total Costs per Cycle, Alternative Scenario (Females)",
       x = "Cycle",
       y = "Variability") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
var_graph_f_alt
```

The highest total cost is reached in “cycle 0” due to the additional medical expenses depicted in “Table 36”. Then, a sharp decrease is observed for male patients due to the higher incidence of mortality compared to female patients. Note that, again, total costs tend to drop earlier for male patients, remarking the higher longevity of female patients, and variability is moderate just like in the baseline scenario.

The graphs showcasing costs over cycles are:

```{r}
#Averaging costs across simulations
#Males
combined_costs_m_alt <- map_df(final_cost_m2_alt, ~ .x)
mean_costs_per_cycle_m_alt <- combined_costs_m_alt %>%
  group_by(cycle) %>%
  summarise(avg_tot_costs = mean(sum_costs, na.rm = TRUE)) %>%
  mutate(cycle = as_factor(cycle) %>% fct_relevel(c("cycle 0", "cycle 1", "cycle 2", "cycle 3", "cycle 4", "cycle 5", "cycle 6", "cycle 7", "cycle 8", "cycle 9", "cycle 10", "cycle 11", "cycle 12", "cycle 13", "cycle 14"))) %>%
  arrange(cycle)
print(mean_costs_per_cycle_m_alt)
#Females
combined_costs_f_alt <- map_df(final_cost_f2_alt, ~ .x)
mean_costs_per_cycle_f_alt <- combined_costs_f_alt %>%
  group_by(cycle) %>%
  summarise(avg_tot_costs = mean(sum_costs, na.rm = TRUE)) %>%
  mutate(cycle = as_factor(cycle) %>% fct_relevel(c("cycle 0", "cycle 1", "cycle 2", "cycle 3", "cycle 4", "cycle 5", "cycle 6", "cycle 7", "cycle 8", "cycle 9", "cycle 10", "cycle 11", "cycle 12", "cycle 13", "cycle 14"))) %>%
  arrange(cycle)
print(mean_costs_per_cycle_f_alt)

#Graphs
#Males
graph1_alt <- ggplot(data = mean_costs_per_cycle_m_alt %>% mutate(Year = c("2020-25", "2025-30", "2030-35", "2035-40", "2040-45", "2045-50", "2050-55", "2055-60", "2060-65", "2065-70", "2070-75", "2075-80", "2080-85", "2085-90", "2090-95")), aes(x = Year, y = avg_tot_costs))+
  geom_col(fill = "turquoise") +
  ggtitle("Average total costs from microsimulation, alternative scenario (Males)") +
  xlab("Year") +
  ylab("Cost") +
  theme_minimal() +
  scale_y_continuous(labels = scales::comma, limits = c(0, max(mean_costs_per_cycle_m_alt$avg_tot_costs) * 1)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8))
  options(scipen=999)
  
#Females
graph2_alt <- ggplot(data = mean_costs_per_cycle_f_alt %>% mutate(Year = c("2020-25", "2025-30", "2030-35", "2035-40", "2040-45", "2045-50", "2050-55", "2055-60", "2060-65", "2065-70", "2070-75", "2075-80", "2080-85", "2085-90", "2090-95")), aes(x = Year, y = avg_tot_costs))+
  geom_col(fill = "pink") +
  ggtitle("Average total costs from microsimulation, alternative scenario (Females)") +
  xlab("Year") +
  ylab("Cost") +
  theme_minimal() +
  scale_y_continuous(labels = scales::comma, limits = c(0, max(mean_costs_per_cycle_f_alt$avg_tot_costs) * 1)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8))
  options(scipen=999)

graph1_alt
graph2_alt
```

Let's compare average total costs across scenarios:

```{r}
#Males
mean_costs_combined_m <- mean_costs_per_cycle_m %>%
  rename(avg_tot_costs_baseline = avg_tot_costs) %>%
  inner_join(mean_costs_per_cycle_m_alt %>%
               rename(avg_tot_costs_alt = avg_tot_costs),
             by = "cycle") %>%
  mutate(extra_cost = avg_tot_costs_baseline - avg_tot_costs_alt) %>% 
  pivot_longer(cols = c(avg_tot_costs_baseline, avg_tot_costs_alt, extra_cost),
               names_to = "Scenario", values_to = "avg_tot_costs") %>%
  mutate(Scenario = recode(Scenario, "avg_tot_costs_baseline" = "Baseline", "avg_tot_costs_alt" = "Alternative", "extra_cost" = "Extra cost of baseline")) %>% 
  filter(Scenario != "Baseline") %>% 
  mutate(
    Scenario = as_factor(Scenario) %>% fct_relevel("Extra cost of baseline")
  )

graph_combined_m <- ggplot(data = mean_costs_combined_m, aes(x = cycle, y = avg_tot_costs, fill = "Gains/losses")) +
  geom_col(data = subset(mean_costs_combined_m, Scenario == "Alternative"), fill = "blue", width = 0.4) +
  geom_col(data = subset(mean_costs_combined_m, Scenario == "Extra cost of baseline"),
           aes(fill = ifelse(avg_tot_costs < 0, "Loss", "Gain")), 
           width = 0.4) +
  scale_fill_manual(name = "Gains/losses", values = c("Alternative" = "blue", "Loss" = "red", "Gain" = "green")) +
  ggtitle("Comparison of average total costs of alternative scenario wrt baseline scenario (Males)") +
  xlab("Cycle") +
  ylab("Cost") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 7), plot.title = element_text(size = 10)) +
  scale_y_continuous(labels = scales::comma, limits = c(min(mean_costs_combined_m$avg_tot_costs), max(mean_costs_combined_m$avg_tot_costs)))
graph_combined_m

#Females
mean_costs_combined_f <- mean_costs_per_cycle_f %>%
  rename(avg_tot_costs_baseline = avg_tot_costs) %>%
  inner_join(mean_costs_per_cycle_f_alt %>%
               rename(avg_tot_costs_alt = avg_tot_costs),
             by = "cycle") %>%
  mutate(extra_cost = avg_tot_costs_baseline - avg_tot_costs_alt) %>% 
  pivot_longer(cols = c(avg_tot_costs_baseline, avg_tot_costs_alt, extra_cost),
               names_to = "Scenario", values_to = "avg_tot_costs") %>%
  mutate(Scenario = recode(Scenario, "avg_tot_costs_baseline" = "Baseline", "avg_tot_costs_alt" = "Alternative", "extra_cost" = "Extra cost of baseline")) %>% 
  filter(Scenario != "Baseline") %>% 
  mutate(
    Scenario = as_factor(Scenario) %>% fct_relevel("Extra cost of baseline")
  )

graph_combined_f <- ggplot(data = mean_costs_combined_f, aes(x = cycle, y = avg_tot_costs, fill = "Gains/losses")) +
  geom_col(data = subset(mean_costs_combined_f, Scenario == "Alternative"), fill = "pink", width = 0.4) +
  geom_col(data = subset(mean_costs_combined_f, Scenario == "Extra cost of baseline"),
           aes(fill = ifelse(avg_tot_costs < 0, "Loss", "Gain")), 
           width = 0.4) +
  scale_fill_manual(name = "Gains/losses", values = c("Alternative" = "pink", "Loss" = "red", "Gain" = "green")) +
  ggtitle("Comparison of average total costs of alternative scenario wrt baseline scenario (Females)") +
  xlab("Cycle") +
  ylab("Cost") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 7), plot.title = element_text(size = 10)) +
  scale_y_continuous(labels = scales::comma, limits = c(min(mean_costs_combined_f$avg_tot_costs), max(mean_costs_combined_f$avg_tot_costs)))
graph_combined_f
```

Note that “cycle 0” is characterized by a huge loss due to the earlier treatment of prodromal patients. Then, “cycle 1” does not have any gain or loss since the probabilities of transitioning from the prodromal state P in “cycle 0” are not modified by any alternative scenario. The following cycles depict moderate gains and significant losses, with the only exception of “cycle 3” of male patients where there is an insignificant gain/loss. The main takeaway is that, from a financial point of view, early detection does not allow to save any money but rather configures as an investment. 
The reason is that, globally speaking, the higher probability of remaining in the MPD stage implies a loss for the public health insurance since there are more MPD patients to be treated. As well as that, a lower probability of death is associated with a loss since there are less deceased patients who cost 0. On the contrary, a lower probability of transitioning from MPD to APD results in a gain since APD patients cost more than MPD patients on average. However, two variations out of three explain why losses outbalance gains in the above graphs.

Discounted costs are:

```{r}
discounted_costs_m_alt <-
  map(final_cost_m2_alt, 
  ~ .x %>%  
   mutate(
    dw = ifelse(row_number() <= 10, 
                (1)/((1+d.c.1)^(row_number()-1)), 
                (1)/((1+d.c.2)^(row_number()-1))), #vector of discount weights
    discounted_costs = sum_costs * dw )%>% #the column "discounted_costs" represents the vector of discounted costs  
  select(cycle, n, discounted_costs) 
  )
discounted_costs_m_alt

# Females
discounted_costs_f_alt <-
  map(final_cost_f2_alt, 
  ~ .x %>%  
   mutate(
    dw = ifelse(row_number() <= 10, 
                (1)/((1+d.c.1)^(row_number()-1)), 
                (1)/((1+d.c.2)^(row_number()-1))), #vector of discount weights
    discounted_costs = sum_costs * dw )%>% #the column "discounted_costs" represents the vector of discounted costs  
  select(cycle, n, discounted_costs) 
  )
discounted_costs_f_alt

```

The Total Discounted Cost of PD patients for n.t = 15 (cycles) is:

```{r}
#Males
tot_discounted_costs_m_alt <- list()
for(i in 1:n.sim) {
tot_discounted_cost <- sum(discounted_costs_m_alt[[i]]$discounted_costs) 
tot_discounted_costs_m_alt[[i]] <- list(
  "tot_discounted_costs" = c(tot_discounted_cost)
)
}
print(tot_discounted_costs_m_alt)
#Females
tot_discounted_costs_f_alt <- list()
for(i in 1:n.sim) {
tot_discounted_cost <- sum(discounted_costs_f_alt[[i]]$discounted_costs) 
tot_discounted_costs_f_alt[[i]] <- list(
  "tot_discounted_costs" = c(tot_discounted_cost)
)
}
print(tot_discounted_costs_f_alt)
#Averaging total costs across simulations
TDC_m_alternative <- mean(unlist(tot_discounted_costs_m_alt))
TDC_f_alternative <- mean(unlist(tot_discounted_costs_f_alt))
#Final result
TDC_alternative <- TDC_m_alternative + TDC_f_alternative
TDC_alternative
```

The total amount of money that needs to be invested for early detection is:

```{r}
total_savings <- TDC_baseline - TDC_alternative
total_savings
```

The following is a useful graph to evaluate the trends of P, MPD, APD and D patients over the microsimulation time period:

```{r}
prepare_plot_data <- function(df_m, scenario) {
  df_m %>%
    as_tibble() %>%
    pivot_longer(cols = starts_with("cycle"), names_to = "cycle", values_to = "state") %>%
    count(cycle, state) %>%
    group_by(cycle) %>%
    mutate(percent = n / sum(n)) %>%
    ungroup() %>%
    mutate(scenario = scenario)
}


num_cols_m <- ncol(model_results_m[[50]])
num_cols_m_alt <- ncol(model_results_m_alt[[50]])

colnames(model_results_m[[50]]) <- paste("cycle", 0:(num_cols_m-1), sep = " ")
colnames(model_results_m_alt[[50]]) <- paste("cycle", 0:(num_cols_m_alt-1), sep = " ")


# Baseline
df_m.M <- model_results_m[[50]] %>% prepare_plot_data("Baseline")

# Alternative
df_m.M_alt <- model_results_m_alt[[50]] %>% prepare_plot_data("Alternative")

# Combining
combined_data_m <- bind_rows(df_m.M, df_m.M_alt)

combined_data1 <- combined_data_m %>% mutate(cycle = factor(cycle, levels = c("cycle 0", "cycle 1", "cycle 2", "cycle 3", "cycle 4", "cycle 5", "cycle 6", "cycle 7", "cycle 8", "cycle 9", "cycle 10", "cycle 11", "cycle 12", "cycle 13", "cycle 14"))) %>% 
filter(cycle != "cycle 15")

# Plot 
summary_plot_male <- ggplot(combined_data1 %>% mutate(statescenario = paste(state, scenario)), aes(x = cycle, y = percent, color = state, linetype = scenario, group = statescenario)) +
  geom_line() +
  labs(title = "Comparison of states across cycles and scenarios (Males)",
       x = "Cycle",
       y = "Percentage") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
summary_plot_male
```

The same graph as before for females: 

```{r}
prepare_plot_data <- function(df_m, scenario) {
  df_m %>%
    as_tibble() %>%
    pivot_longer(cols = starts_with("cycle"), names_to = "cycle", values_to = "state") %>%
    count(cycle, state) %>%
    group_by(cycle) %>%
    mutate(percent = n / sum(n)) %>%
    ungroup() %>%
    mutate(scenario = scenario)
}


num_cols_f <- ncol(model_results_f[[50]])
num_cols_f_alt <- ncol(model_results_f_alt[[50]])

colnames(model_results_f[[50]]) <- paste("cycle", 0:(num_cols_f-1), sep = " ")
colnames(model_results_f_alt[[50]]) <- paste("cycle", 0:(num_cols_f_alt-1), sep = " ")


# Baseline
df_m.M <- model_results_f[[50]] %>% prepare_plot_data("Baseline")

# Alternative
df_m.M_alt <- model_results_f_alt[[50]] %>% prepare_plot_data("Alternative")

# Combining
combined_data_f <- bind_rows(df_m.M, df_m.M_alt)

combined_data2 <- combined_data_f %>% mutate(cycle = factor(cycle, levels = c("cycle 0", "cycle 1", "cycle 2", "cycle 3", "cycle 4", "cycle 5", "cycle 6", "cycle 7", "cycle 8", "cycle 9", "cycle 10", "cycle 11", "cycle 12", "cycle 13", "cycle 14"))) %>% 
filter(cycle != "cycle 15")

# Plot 
summary_plot_female <- ggplot(combined_data2 %>% mutate(statescenario = paste(state, scenario)), aes(x = cycle, y = percent, color = state, linetype = scenario, group = statescenario)) +
  geom_line() +
  labs(title = "Comparison of states across cycles and scenarios (Females)",
       x = "Cycle",
       y = "Percentage") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
summary_plot_female
```

Losses are really prominent from a financial point of view, as indicated by the final result and by the graph comparing costs across scenarios:

* a higher average number of MPD patients means higher medical costs

* a lower average number of deceased patients, again, results in higher medical costs

* only the lower average number of APD patients represents a financial gain

However, if the point of view of patients is considered, the previous remarks represent a gain both in terms of life quality and life expectancy.

Let's evaluate this gain:

```{r}
process_model_result <- function(model_result) {
  df <- model_result %>% as_tibble()
  cycle_columns <- paste0("cycle ", 0:14)
  map(cycle_columns, ~ df %>% tabyl(!!sym(.x)))
}

# Males
percent_tables_m <- map(model_results_m[1:100], process_model_result)

# Females
percent_tables_f <- map(model_results_f[1:100], process_model_result)

# Aggregate results and compute the averages
aggregate_results <- function(percent_tables) {
  all_states <- c("P", "MPD", "APD", "D")
  cycle_columns <- paste0("cycle ", 0:14)
  
  aggregated <- map(cycle_columns, function(cycle) {
    state_sums <- map_dbl(all_states, function(state) {
      state_n_values <- map_dbl(percent_tables, ~ {
        tabyl_result <- .x[[which(cycle_columns == cycle)]]
        if (state %in% tabyl_result[[1]]) {
          return(tabyl_result$n[tabyl_result[[1]] == state])
        } else {
          return(0)
        }
      })
      mean(state_n_values)
    })
    tibble(state = all_states, mean_n = state_sums)
  })
  
  bind_rows(aggregated, .id = "cycle") %>%
    mutate(cycle = as.numeric(cycle) - 1) 
}

# Aggregate for males
aggregated_m <- aggregate_results(percent_tables_m)

# Aggregate for females
aggregated_f <- aggregate_results(percent_tables_f)

aggregated_m
aggregated_f


#Same approach for the alternative scenario

percent_tables_m_alt <- map(model_results_m_alt[1:100], process_model_result)
percent_tables_f_alt <- map(model_results_f_alt[1:100], process_model_result)

# Aggregate for males
aggregated_m_alt <- aggregate_results(percent_tables_m_alt)

# Aggregate for females
aggregated_f_alt <- aggregate_results(percent_tables_f_alt)

aggregated_m_alt
aggregated_f_alt
```

With the new tables at hand it is possible to compute the 3 differences that indicate a gain for patients:

* the alternative scenario has more MPD patients, which means that there are more patients spending time in the MPD state. This state is characterized by decent life conditions if compared to the severe stage.

* the alternative scenario has less APD patients, which means that there are less patients spending time in the severe stage of the disease, characterized by severe symptoms that heavily impact life quality.

* the alternative scenario has less deceased patients, which means that, generally speaking, patients lead a longer life.

```{r}
library(dplyr)

calculate_differences <- function(baseline, alternative) {
  baseline %>%
    inner_join(alternative, by = c("cycle", "state"), suffix = c("_baseline", "_alt")) %>%
    mutate(
      difference = case_when(
        state == "MPD" ~ mean_n_alt - mean_n_baseline,
        state == "APD" ~ mean_n_baseline - mean_n_alt,
        state == "D" ~ mean_n_baseline - mean_n_alt,
        TRUE ~ NA_real_
      )
    ) %>%
    select(cycle, state, difference) %>%
    filter(!is.na(difference))
}

differences_m <- calculate_differences(aggregated_m, aggregated_m_alt)
differences_f <- calculate_differences(aggregated_f, aggregated_f_alt)

differences_m
differences_f
```

Differences are aggregated with respect to cycles, truncated, since patients have to be counted with integer numbers, and multiplied by 5, since each cycle lasts 5 years.

```{r}
#Males
summary_m <- differences_m %>% 
    group_by(state) %>%
    summarise(
      diff_sum = sum(difference, na.rm = TRUE)
    ) %>%
    mutate(
      diff_sum = floor(diff_sum) * 5
    ) %>%
    select(state, diff_sum)
summary_m

#Females
summary_f <- differences_f %>% 
    group_by(state) %>%
    summarise(
      diff_sum = sum(difference, na.rm = TRUE)
    ) %>%
    mutate(
      diff_sum = floor(diff_sum) * 5
    ) %>%
    select(state, diff_sum)
summary_f

```

The previous are the total numbers of years:

* additionally spent in MPD

* less spent in APD

* additionally spent in life

The results with respect to the average male or female patient require the previous results to be divided by the total number of male and females patients:

```{r}
averages_m <- summary_m %>%
    mutate(
      diff_sum = (diff_sum)/(n_males)
    ) %>%
    select(state, diff_sum)

averages_f <- summary_f %>%
    mutate(
      diff_sum = (diff_sum)/(n_females)
    ) %>%
    select(state, diff_sum)

averages_m
averages_f
```

Therefore, in alternative scenario A1 a male patient gains, on average, about 2 years and 1 month more in the mild stage, about 4 months and a half less in the severe stage and about 1 year, as well as about 1 year and 9 months in terms of life expectancy. In the same way, a female patient gains, on average, about 2 years and 3 months more in the mild stage, about 4 months and a half less in the severe stage and about 1 year and 11 months in terms of life expectancy.
Note that the subdivision of gains is compliant with the methodological framework suggested by the LEMEREND project: there are gains in terms of years in almost “perfect health” referring to the MPD stage and gains in the severity of the illness referring to the APD stage. The first set of benefits considers the MPD stage instead of the prodromal state P since state-of-the-art detection techniques do not allow physicians to identify prodromal patients. However, this analysis can be improved in the future with the data obtained from the new AI-supported algorithms for early detection which, hopefully, will be put in place. 

The graph representing gains from a patient's point of view in terms of:

* additional months spent as a mild patient (MPD)
* fewer months spent as a severe patient (APD)
* additional months of life expectancy (D)

is the following:

```{r}
calculate_differencesm1 <- function(baseline, alternative) {
  baseline %>%
    inner_join(alternative, by = c("cycle", "state"), suffix = c("_baseline", "_alt")) %>%
    mutate(
      difference = case_when(
        state == "MPD" ~ ((((((mean_n_alt - mean_n_baseline)*5))/(n_males)))*(12)),
        state == "APD" ~ ((((((mean_n_baseline - mean_n_alt)*5))/(n_males)))*(12)),
        state == "D" ~ ((((((mean_n_baseline - mean_n_alt)*5))/(n_males)))*(12)),
        TRUE ~ NA_real_
      )
    ) %>%
    select(cycle, state, difference) %>%
    filter(!is.na(difference))
}

calculate_differencesf1 <- function(baseline, alternative) {
  baseline %>%
    inner_join(alternative, by = c("cycle", "state"), suffix = c("_baseline", "_alt")) %>%
    mutate(
      difference = case_when(
        state == "MPD" ~ ((((((mean_n_alt - mean_n_baseline)*5))/(n_females)))*(12)),
        state == "APD" ~ ((((((mean_n_baseline - mean_n_alt)*5))/(n_females)))*(12)),
        state == "D" ~ ((((((mean_n_baseline - mean_n_alt)*5))/(n_females)))*(12)),
        TRUE ~ NA_real_
      )
    ) %>%
    select(cycle, state, difference) %>%
    filter(!is.na(difference))
}

differences_m1 <- calculate_differencesm1(aggregated_m, aggregated_m_alt)
differences_f1 <- calculate_differencesf1(aggregated_f, aggregated_f_alt)

plot_differencesm1 <- ggplot(differences_m1, aes(x = cycle, y = difference, color = state)) +
  geom_line(size = 0.8) +        
  theme_minimal() +              
  labs(title = "Gains of the average male patient per cycle (Alternative scenario A1)", 
       x = "Cycle", 
       y = "Months gained") +
  scale_x_continuous(breaks = unique(differences_m1$cycle)) +
  theme(plot.title = element_text(hjust = 0.5)) 

plot_differencesm1

plot_differencesf1 <- ggplot(differences_f1, aes(x = cycle, y = difference, color = state)) +
  geom_line(size = 0.8) +        
  theme_minimal() +              
  labs(title = "Gains of the average female patient per cycle (Alternative scenario A1)", 
       x = "Cycle", 
       y = "Months gained") +
  scale_x_continuous(breaks = unique(differences_f1$cycle)) +
  theme(plot.title = element_text(hjust = 0.5)) 

plot_differencesf1
```


```{r}
plot_differencesm11 <- ggplot(differences_m1, aes(x = cycle, y = difference, color = state)) +
  geom_line(size = 0.8) +        
  theme_minimal() +              
  labs(title = "Gains of the average male patient per cycle (Alternative scenario A1)", 
       x = "Cycle", 
       y = "Months gained") +
  scale_x_continuous(breaks = unique(differences_m1$cycle)) +
   geom_vline(xintercept = 5, color = "red", linetype = "dashed", size = 0.8) +
  theme(plot.title = element_text(hjust = 0.5)) 

plot_differencesm11

plot_differencesf11 <- ggplot(differences_f1, aes(x = cycle, y = difference, color = state)) +
  geom_line(size = 0.8) +        
  theme_minimal() +              
  labs(title = "Gains of the average female patient per cycle (Alternative scenario A1)", 
       x = "Cycle", 
       y = "Months gained") +
  scale_x_continuous(breaks = unique(differences_f1$cycle)) +
  geom_vline(xintercept = 5, color = "red", linetype = "dashed", size = 0.8) +
  theme(plot.title = element_text(hjust = 0.5)) 

plot_differencesf11
```

### Alternative scenario: A2

This alternative scenario does not consider a gain in terms of life expectancy but it redistributes the positive gain in P(MPD→MPD) only to P(MPD→APD) by applying the following equation:

$$ p\prime(\mathrm{MPD} \rightarrow \mathrm{APD})\ =\ 1\ -\ \ p(\mathrm{MPD} \rightarrow \mathrm{D})\ -\ p\prime $$

where p' is:

$$ p^\prime=\ p^\frac{60-12}{60}=p^\frac{4}{5} $$

Consequently, a change in mortality is not considered and therefore P(MPD→D) is not varied.

However, starting from transition matrix 6/10 for male patients and 7/10 for female patients, the probabilities of transitioning to APD appear as negative. Therefore, an adjustment is needed and the approach held in alternative scenario A1 is adopted to compute new probabilities:

$$ \Delta(\mathrm{MPD} \rightarrow \mathrm{APD}) = \frac{p(\mathrm{MPD} \rightarrow \mathrm{APD})}{p(\mathrm{MPD} \rightarrow \mathrm{APD}) + p(\mathrm{MPD} \rightarrow \mathrm{D})} \ \mathrm{\Delta} $$

However, the probabilities in the second row no longer sum up to 1 and this issue is tackled by dividing probabilities by their sum if their sum is more than 1. Note that this adjustment artificially reduces the probability of dying for the eldest age classes, hence the consequent moderate gain in terms of life expectancy shall not be considered. Moreover, this adjustment will artificially decrease P(MPD→MPD) and P(MPD→APD) as well, but a lower probability of remaining MPD can be assumed to be counterbalanced by a lower probability of transitioning to another state, which is APD.

```{r}
# Adjust probability_of_death for 95+ patients
final_data2_alt <- final_data_alt_old %>%
  group_by(gender) %>%
  mutate(probability_of_death = ifelse(
    age_class == "95et+" & severity == "Prodromal",
    probability_of_death[age_class == "95et+" & severity == "Mild"] -
      (probability_of_death[age_class == "90-94" & severity == "Mild"] -
       probability_of_death[age_class == "90-94" & severity == "Prodromal"]),
    probability_of_death
  ))

age_classes <- c("50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85-89", "90-94", "95et+")
genders <- c("Male", "Female")

# Update f_prob1 with correct probabilities
f_prob2 <- f_prob %>%
  mutate(
    F = case_when(
      `Age class` == "95et+" & Gender == "Male" ~ final_data1_alt %>% filter(gender == "Male", age_class == "95et+") %>% pull(probability_of_death) %>% first(),
      `Age class` == "95et+" & Gender == "Female" ~ final_data1_alt %>% filter(gender == "Female", age_class == "95et+") %>% pull(probability_of_death) %>% first(),
      TRUE ~ F
    )
  )

# Function to generate transition matrix
generate_transition_matrix_alt2 <- function(summary_df, summary_df2, final_data2_alt, age_class, gender_name) {
  x <- matrix(NA, nrow = 4, ncol = 4)
  x[1, 1] <- 0

  f_prob2 <- f_prob1 %>%
    filter(`Age class` == age_class & Gender == gender_name) %>%
    pull(F)
   
  x[1, 2] <- 1 - f_prob2
  x[1, 3] <- 0
  x[1, 4] <- f_prob2

  x[2, 1] <- 0

  numerator_MPD_APD <- summary_df1 %>%
    filter(CLA_AGE_5 == age_class & gender == gender_name & severity == "Transitioned" & yod_binary == "Alive") %>%
    summarise(n_patients = sum(n_patients)) %>%
    pull(n_patients)

  numerator_MPD_MPD <- summary_df %>%
    filter(CLA_AGE_5 == age_class & gender == gender_name & severity == "Mild" & yod_binary == "Alive") %>%
    summarise(n_patients = sum(n_patients)) %>%
    pull(n_patients)

  numerator_MPD_D <- summary_df %>%
    filter(CLA_AGE_5 == age_class & gender == gender_name & severity %in% c("Mild", "Transitioned") & yod_binary == "Dead") %>%
    summarise(n_patients = sum(n_patients)) %>%
    pull(n_patients)

  denominator_MPD <- summary_df %>%
    filter(CLA_AGE_5 == age_class & gender == gender_name & severity %in% c("Mild", "Transitioned")) %>%
    summarise(n_patients = sum(n_patients)) %>%
    pull(n_patients)

   x[2, 2] <- (numerator_MPD_MPD / denominator_MPD)^(4/5)  
  
   x[2, 3] <- 1 - ((numerator_MPD_MPD / denominator_MPD)^(4/5)) - (numerator_MPD_D / denominator_MPD) 
   
   x[2, 4] <- numerator_MPD_D / denominator_MPD
   
  
  #The adjustment is introduced here
  #sum_probs <- x[2, 2] + x[2, 3] + x[2, 4]

  #if (sum_probs > 1) {
  #x[2, 2] <- x[2, 2] / sum_values
  #x[2, 3] <- x[2, 3] / sum_values
  #x[2, 4] <- x[2, 4] / sum_values
  #}
   
  
  x[3, 1] <- 0
  x[3, 2] <- 0
  numerator_APD_D <- summary_df2 %>%
    filter(CLA_AGE_5 == age_class, gender == gender_name, severity_at_end == "Severe", yod_binary == "Dead") %>%
    summarise(n_patients = sum(n_patients)) %>%
    pull(n_patients)
  
  denominator_APD_D <- summary_df2 %>%
    filter(CLA_AGE_5 == age_class, gender == gender_name, severity_at_end == "Severe") %>%
    summarise(n_patients = sum(n_patients)) %>%
    pull(n_patients)

    x[3, 4] <- numerator_APD_D / denominator_APD_D
    x[3, 3] <- 1 - x[3, 4]

  x[4, 1] <- 0
  x[4, 2] <- 0
  x[4, 3] <- 0
  x[4, 4] <- 1

  return(x)
}

transition_matrices_alt2 <- list()

for (gender in genders) {
  for (age_class in age_classes) {
    matrix_name <- paste(gender, age_class, sep = "_")
    transition_matrices_alt2[[matrix_name]] <- generate_transition_matrix_alt2(summary_df, summary_df2, final_data2_alt, age_class, gender)
  }
}

names(transition_matrices_alt2) <- NULL  

males_alt2 <- transition_matrices_alt2[1:10]
females_alt2 <- transition_matrices_alt2[11:20]

matrices_mf_alt2 <- list(males_alt2, females_alt2)

for (i in 1:length(males_alt2)) {
  colnames(males_alt2[[i]]) <- c("P.m", "MPD.m", "APD.m", "D.m")
  rownames(males_alt2[[i]]) <- c("P.m", "MPD.m", "APD.m", "D.m")
}
for (i in 1:length(females_alt2)) {
  colnames(females_alt2[[i]]) <- c("P.f", "MPD.f", "APD.f", "D.f")
  rownames(females_alt2[[i]]) <- c("P.f", "MPD.f", "APD.f", "D.f")
}

transition_matrices_m_alt2 <- matrices_mf_alt2[[1]]
transition_matrices_f_alt2 <- matrices_mf_alt2[[2]]

extract_rows_as_named_list <- function(matrix) {
  list(
    P = setNames(as.numeric(matrix[1, ]), c("P", "MPD", "APD", "D")),
    MPD = setNames(as.numeric(matrix[2, ]), c("P", "MPD", "APD", "D")),
    APD = setNames(as.numeric(matrix[3, ]), c("P", "MPD", "APD", "D")),
    D = setNames(as.numeric(matrix[4, ]), c("P", "MPD", "APD", "D"))
  )
}

transition_prob_m_alt2 <- lapply(transition_matrices_m_alt2, extract_rows_as_named_list)
transition_prob_f_alt2 <- lapply(transition_matrices_f_alt2, extract_rows_as_named_list)

print("Transition Probabilities for Males:")
print(transition_prob_m_alt2)

print("Transition Probabilities for Females:")
print(transition_prob_f_alt2)


#Let's adjust the matrices containing negative probabilities of transitioning to APD: the adjustment concerns matrices 6-10 for male patients and matrices 7-10 for female patients

# Function to calculate delta
calculate_delta <- function(baseline, alt) {
  delta <- alt - baseline
  return(delta)
}

update_transition_probabilities1_m <- function(transition_prob_m, transition_prob_m_alt2) {
  for (i in 6:length(transition_prob_m)) {
    # Extract baseline and alternative matrices
    baseline_matrix_m <- transition_prob_m[[i]]$MPD
    alt_matrix_m <- transition_prob_m_alt2[[i]]$MPD
    
    # Baseline and alternative [2,2] elements
    baseline_m_MPD <- baseline_matrix_m["MPD"]
    alt_m_MPD <- alt_matrix_m["MPD"]
    
    # Calculate deltas
    delta_m <- calculate_delta(baseline_m_MPD, alt_m_MPD)
    
    # Calculate baseline probabilities
    p_m_APD <- baseline_matrix_m["APD"]
    p_m_D <- baseline_matrix_m["D"]
    
    # Calculate delta distribution for males
    sum_m_APD_D <- p_m_APD + p_m_D
    delta_m_APD <- (p_m_APD / sum_m_APD_D) * delta_m
    
    # Update alternative transition probabilities for males
    transition_prob_m_alt2[[i]]$MPD["APD"] <- baseline_matrix_m["APD"] - delta_m_APD
    
    #Adjust probabilities if their sum is more than 1
    sum_probs_m <- transition_prob_m_alt2[[i]]$MPD["MPD"] + transition_prob_m_alt2[[i]]$MPD["APD"] + transition_prob_m_alt2[[i]]$MPD["D"]  

  if (sum_probs_m > 1) {
  transition_prob_m_alt2[[i]]$MPD["MPD"] <- transition_prob_m_alt2[[i]]$MPD["MPD"] / sum_probs_m
  transition_prob_m_alt2[[i]]$MPD["APD"] <- transition_prob_m_alt2[[i]]$MPD["APD"] / sum_probs_m
  transition_prob_m_alt2[[i]]$MPD["D"]   <- transition_prob_m_alt2[[i]]$MPD["D"]   / sum_probs_m
  }
    
  }
  return(list(transition_prob_m_alt2))
}


update_transition_probabilities1_f <- function(transition_prob_f, transition_prob_f_alt2) {
  for (i in 7:length(transition_prob_f)) {
    # Extract baseline and alternative matrices
    baseline_matrix_f <- transition_prob_f[[i]]$MPD
    alt_matrix_f <- transition_prob_f_alt2[[i]]$MPD
    
    # Baseline and alternative [2,2] elements
    baseline_f_MPD <- baseline_matrix_f["MPD"]
    alt_f_MPD <- alt_matrix_f["MPD"]
    
    # Calculate deltas
    delta_f <- calculate_delta(baseline_f_MPD, alt_f_MPD)
    
    # Calculate baseline probabilities
    p_f_APD <- baseline_matrix_f["APD"]
    p_f_D <- baseline_matrix_f["D"]
    
    # Calculate delta distribution for females
    sum_f_APD_D <- p_f_APD + p_f_D
    delta_f_APD <- (p_f_APD / sum_f_APD_D) * delta_f
    
    # Update alternative transition probabilities for females
    transition_prob_f_alt2[[i]]$MPD["APD"] <- baseline_matrix_f["APD"] - delta_f_APD
    
    #Adjust probabilities if their sum is more than 1
  sum_probs_f <- transition_prob_f_alt2[[i]]$MPD["MPD"] + transition_prob_f_alt2[[i]]$MPD["APD"] + transition_prob_f_alt2[[i]]$MPD["D"]  

  if (sum_probs_f > 1) {
  transition_prob_f_alt2[[i]]$MPD["MPD"] <- transition_prob_f_alt2[[i]]$MPD["MPD"] / sum_probs_f
  transition_prob_f_alt2[[i]]$MPD["APD"] <- transition_prob_f_alt2[[i]]$MPD["APD"] / sum_probs_f
  transition_prob_f_alt2[[i]]$MPD["D"]   <- transition_prob_f_alt2[[i]]$MPD["D"]   / sum_probs_f
  } 
    
  }
  return(list(transition_prob_f_alt2))
}

# Call the function to update transition probabilities
transition_prob_m_altA1 <- update_transition_probabilities1_m(transition_prob_m, transition_prob_m_alt2)
transition_prob_f_altA1 <- update_transition_probabilities1_f(transition_prob_f, transition_prob_f_alt2)

transition_prob_m_altA <- transition_prob_m_altA1[[1]]
transition_prob_f_altA <- transition_prob_f_altA1[[1]]

print("Updated Transition Probabilities for Males (Alternative Scenario):")
print(transition_prob_m_altA)

print("Updated Transition Probabilities for Females (Alternative Scenario):")
print(transition_prob_f_altA)

males_altA <- lapply(transition_prob_m_altA, function(prob) {
  matrix(c(prob$P, prob$MPD, prob$APD, prob$D), nrow = 4, byrow = TRUE)
})
females_altA <- lapply(transition_prob_f_altA, function(prob) {
  matrix(c(prob$P, prob$MPD, prob$APD, prob$D), nrow = 4, byrow = TRUE)
})

for (i in 1:length(males_altA)) {
  colnames(males_altA[[i]]) <- c("P.m", "MPD.m", "APD.m", "D.m")
  rownames(males_altA[[i]]) <- c("P.m", "MPD.m", "APD.m", "D.m")
}
for (i in 1:length(females_altA)) {
  colnames(females_altA[[i]]) <- c("P.f", "MPD.f", "APD.f", "D.f")
  rownames(females_altA[[i]]) <- c("P.f", "MPD.f", "APD.f", "D.f")
}

print("Updated Transition Matrices for Males (Alternative Scenario):")
print(males_altA)

print("Updated Transition Matrices for Females (Alternative Scenario):")
print(females_altA)

```

The graph showcasing probabilities of remaining MPD:

```{r}
extract_probabilities2_alt <- function(matrices, age_classes, genders) {
  data <- data.frame()
  
  for (i in 1:length(matrices)) {
    age_class <- age_classes[i]
    matrix <- matrices[[i]]
    
    data <- rbind(data, data.frame(
      age_class = age_class,
      gender = genders,
      severity = severity_labels[2],
      probability_of_remainingMPD = matrix[2, 2]
    ))
    
  }
  
  return(data)
}

males_data_rem_altA <- extract_probabilities2_alt(males_altA, age_classes, "Male")
females_data_rem_altA <- extract_probabilities2_alt(females_altA, age_classes, "Female")

final_data_rem_altA <- rbind(males_data_rem_altA, females_data_rem_altA)

graph_prob_mf_rem_altA <- ggplot(final_data_rem_altA, aes(x = age_class, y = probability_of_remainingMPD, colour = gender, group = gender)) +
  geom_line() +
  geom_point() +
  facet_wrap(~ gender) +
  theme_minimal() +
  labs(title = "Probability of remaining MPD with respect to gender and age classes, alternative scenario",
       x = "Age class",
       y = "Probability") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), plot.title = element_text(size = 10))
graph_prob_mf_rem_altA
```

The graph showcasing probabilities of transitioning from MPD to APD is:

```{r}
extract_probabilities1 <- function(matrices, age_classes, genders) {
  data <- data.frame()
  
  for (i in 1:length(matrices)) {
    age_class <- age_classes[i]
    matrix <- matrices[[i]]
    
    data <- rbind(data, data.frame(
      age_class = age_class,
      gender = genders,
      severity = severity_labels[2],
      probability_of_transitioning = matrix[2, 3]
    ))
    
  }
  
  return(data)
}

males_data_tra_altA <- extract_probabilities1(males_altA, age_classes, "Male")
females_data_tra_altA <- extract_probabilities1(females_altA, age_classes, "Female")

final_data_tra_altA <- rbind(males_data_tra_altA, females_data_tra_altA)

graph_prob_mf_tra_altA <- ggplot(final_data_tra_altA, aes(x = age_class, y = probability_of_transitioning, colour = gender, group = gender)) +
  geom_line() +
  geom_point() +
  facet_wrap(~ gender) +
  theme_minimal() +
  labs(title = "Probability of transitioning from MPD to APD with respect to gender and age classes, alternative scenario",
       x = "Age class",
       y = "Probability") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), plot.title = element_text(size = 10))
graph_prob_mf_tra_altA
```

Comparison across alternative scenarios A1/A2 (probability of remaining MPD):

```{r}
extract_probabilities_comb1 <- function(matrices, age_classes, genders, scenario) {
  data <- data.frame()
  
  for (i in 1:length(matrices)) {
    age_class <- age_classes[i]
    matrix <- matrices[[i]]
    
    data <- rbind(data, data.frame(
      age_class = age_class,
      gender = genders,
      severity = severity_labels[2],
      probability_of_remainingMPD = matrix[2, 2],
      scenario = scenario
    ))
    
  }
  
  return(data)
}

# Extract data for baseline scenario
males_data_rem_comb_alt <- extract_probabilities_comb1(males_alt, age_classes, "Male", "Alternative A1")
females_data_rem_comb_alt <- extract_probabilities_comb1(females_alt, age_classes, "Female", "Alternative A1")

# Extract data for alternative scenario
males_data_rem_alt_comb_altA <- extract_probabilities_comb1(males_altA, age_classes, "Male", "Alternative A2")
females_data_rem_alt_comb_altA <- extract_probabilities_comb1(females_altA, age_classes, "Female", "Alternative A2")

# Combine all data
final_data_rem_combA <- rbind(males_data_rem_comb_alt, females_data_rem_comb_alt, males_data_rem_alt_comb_altA, females_data_rem_alt_comb_altA)

# Create the combined graph
graph_prob_mf_rem_combinedA <- ggplot(final_data_rem_combA, aes(x = age_class, y = probability_of_remainingMPD, colour = scenario, group = scenario)) +
  geom_line() +
  geom_point() +
  facet_wrap(~ gender) +
  theme_minimal() +
  labs(title = "Probability of remaining MPD: comparison across alternative scenarios",
       x = "Age class",
       y = "Probability",
       colour = "Scenario") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), plot.title = element_text(size = 10))

graph_prob_mf_rem_combinedA
```

As expected, this probability is lower than that of the previous alternative scenario (A1)

Comparison across alternative scenarios (probability of transitioning from MPD to APD):

```{r}
extract_probabilities_comb2 <- function(matrices, age_classes, genders, scenario) {
  data <- data.frame()
  
  for (i in 1:length(matrices)) {
    age_class <- age_classes[i]
    matrix <- matrices[[i]]
    
    data <- rbind(data, data.frame(
      age_class = age_class,
      gender = genders,
      severity = severity_labels[2],
      probability_of_transitioning = matrix[2, 3],
      scenario = scenario
    ))
    
  }
  
  return(data)
}

# Extract data for baseline scenario
males_data_tra_comb_alt <- extract_probabilities_comb2(males_alt, age_classes, "Male", "Alternative A1")
females_data_tra_comb_alt <- extract_probabilities_comb2(females_alt, age_classes, "Female", "Alternative A1")

# Extract data for alternative scenario
males_data_tra_alt_comb_altA <- extract_probabilities_comb2(males_altA, age_classes, "Male", "Alternative A2")
females_data_tra_alt_comb_altA <- extract_probabilities_comb2(females_altA, age_classes, "Female", "Alternative A2")

# Combine all data
final_data_tra_combA <- rbind(males_data_tra_comb_alt, females_data_tra_comb_alt, males_data_tra_alt_comb_altA, females_data_tra_alt_comb_altA)

# Create the combined graph
graph_prob_mf_tra_combinedA <- ggplot(final_data_tra_combA, aes(x = age_class, y = probability_of_transitioning, colour = scenario, group = scenario)) +
  geom_line() +
  geom_point() +
  facet_wrap(~ gender) +
  theme_minimal() +
  labs(title = "Probability of transitioning from MPD to APD: comparison across alternative scenarios",
       x = "Age class",
       y = "Probability",
       colour = "Scenario") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), plot.title = element_text(size = 10))

graph_prob_mf_tra_combinedA
```

Again, as expected, this probability is lower than that of alternative scenario A1, even if in a slight way. This decrease in P(MPD→APD) is assumed to counterbalance the decrease in P(MPD→MPD).

Comparison across alternative scenarios (probability of dying when MPD):

```{r}
extract_probabilities_comb3 <- function(matrices, age_classes, genders, scenario) {
  data <- data.frame()
  
  for (i in 1:length(matrices)) {
    age_class <- age_classes[i]
    matrix <- matrices[[i]]
    
    data <- rbind(data, data.frame(
      age_class = age_class,
      gender = genders,
      severity = severity_labels[2],
      probability_of_dyingMPD = matrix[2, 4],
      scenario = scenario
    ))
    
  }
  
  return(data)
}

# Extract data for baseline scenario
males_data_die_comb_alt <- extract_probabilities_comb3(males_alt, age_classes, "Male", "Alternative A1")
females_data_die_comb_alt <- extract_probabilities_comb3(females_alt, age_classes, "Female", "Alternative A1")

# Extract data for alternative scenario
males_data_die_alt_comb_altA <- extract_probabilities_comb3(males_altA, age_classes, "Male", "Alternative A2")
females_data_die_alt_comb_altA <- extract_probabilities_comb3(females_altA, age_classes, "Female", "Alternative A2")

# Combine all data
final_data_die_combA <- rbind(males_data_die_comb_alt, females_data_die_comb_alt, males_data_die_alt_comb_altA, females_data_die_alt_comb_altA)

# Create the combined graph
graph_prob_mf_die_combinedA <- ggplot(final_data_die_combA, aes(x = age_class, y = probability_of_dyingMPD, colour = scenario, group = scenario)) +
  geom_line() +
  geom_point() +
  facet_wrap(~ gender) +
  theme_minimal() +
  labs(title = "Probability of dying when MPD: comparison across alternative scenarios",
       x = "Age class",
       y = "Probability",
       colour = "Scenario") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), plot.title = element_text(size = 10))

graph_prob_mf_die_combinedA
```

This time the probability is higher, which means that patients are more prone to death in this scenario. This is a positive remark since alternative scenario A2 does not consider any gain in terms of life expectancy.

Comparison wrt the baseline scenario (probability of remaining MPD):

```{r}
extract_probabilities_comb1 <- function(matrices, age_classes, genders, scenario) {
  data <- data.frame()
  
  for (i in 1:length(matrices)) {
    age_class <- age_classes[i]
    matrix <- matrices[[i]]
    
    data <- rbind(data, data.frame(
      age_class = age_class,
      gender = genders,
      severity = severity_labels[2],
      probability_of_remainingMPD = matrix[2, 2],
      scenario = scenario
    ))
    
  }
  
  return(data)
}

# Extract data for baseline scenario
males_data_rem_comb <- extract_probabilities_comb1(males, age_classes, "Male", "Baseline")
females_data_rem_comb <- extract_probabilities_comb1(females, age_classes, "Female", "Baseline")

# Extract data for alternative scenario
males_data_rem_alt_comb_altA <- extract_probabilities_comb1(males_altA, age_classes, "Male", "Alternative A2")
females_data_rem_alt_comb_altA <- extract_probabilities_comb1(females_altA, age_classes, "Female", "Alternative A2")

# Combine all data
final_data_rem_comb_A <- rbind(males_data_rem_comb, females_data_rem_comb, males_data_rem_alt_comb_altA, females_data_rem_alt_comb_altA)

# Create the combined graph
graph_prob_mf_rem_combined_A <- ggplot(final_data_rem_comb_A, aes(x = age_class, y = probability_of_remainingMPD, colour = scenario, group = scenario)) +
  geom_line() +
  geom_point() +
  facet_wrap(~ gender) +
  theme_minimal() +
  labs(title = "Probability of remaining MPD: comparison across scenarios",
       x = "Age class",
       y = "Probability",
       colour = "Scenario") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), plot.title = element_text(size = 10))

graph_prob_mf_rem_combined_A
```

Comparison wrt the baseline scenario (probability of transitioning from MPD to APD):

```{r}
extract_probabilities_comb2 <- function(matrices, age_classes, genders, scenario) {
  data <- data.frame()
  
  for (i in 1:length(matrices)) {
    age_class <- age_classes[i]
    matrix <- matrices[[i]]
    
    data <- rbind(data, data.frame(
      age_class = age_class,
      gender = genders,
      severity = severity_labels[2],
      probability_of_transitioning = matrix[2, 3],
      scenario = scenario
    ))
    
  }
  
  return(data)
}

# Extract data for baseline scenario
males_data_tra_comb <- extract_probabilities_comb2(males, age_classes, "Male", "Baseline")
females_data_tra_comb <- extract_probabilities_comb2(females, age_classes, "Female", "Baseline")

# Extract data for alternative scenario
males_data_tra_alt_comb_altA <- extract_probabilities_comb2(males_altA, age_classes, "Male", "Alternative A2")
females_data_tra_alt_comb_altA <- extract_probabilities_comb2(females_altA, age_classes, "Female", "Alternative A2")

# Combine all data
final_data_tra_comb_A <- rbind(males_data_tra_comb, females_data_tra_comb, males_data_tra_alt_comb_altA, females_data_tra_alt_comb_altA)

# Create the combined graph
graph_prob_mf_tra_combined_A <- ggplot(final_data_tra_comb_A, aes(x = age_class, y = probability_of_transitioning, colour = scenario, group = scenario)) +
  geom_line() +
  geom_point() +
  facet_wrap(~ gender) +
  theme_minimal() +
  labs(title = "Probability of transitioning from MPD to APD: comparison across scenarios",
       x = "Age class",
       y = "Probability",
       colour = "Scenario") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), plot.title = element_text(size = 10))

graph_prob_mf_tra_combined_A
```

Comparison wrt the baseline scenario (probability of dying when MPD):

```{r}
extract_probabilities_comb3 <- function(matrices, age_classes, genders, scenario) {
  data <- data.frame()
  
  for (i in 1:length(matrices)) {
    age_class <- age_classes[i]
    matrix <- matrices[[i]]
    
    data <- rbind(data, data.frame(
      age_class = age_class,
      gender = genders,
      severity = severity_labels[2],
      probability_of_dyingMPD = matrix[2, 4],
      scenario = scenario
    ))
    
  }
  
  return(data)
}

# Extract data for baseline scenario
males_data_die_comb <- extract_probabilities_comb3(males, age_classes, "Male", "Baseline")
females_data_die_comb <- extract_probabilities_comb3(females, age_classes, "Female", "Baseline")

# Extract data for alternative scenario
males_data_die_alt_comb_altA <- extract_probabilities_comb3(males_altA, age_classes, "Male", "Alternative A2")
females_data_die_alt_comb_altA <- extract_probabilities_comb3(females_altA, age_classes, "Female", "Alternative A2")

# Combine all data
final_data_die_comb_A <- rbind(males_data_die_comb, females_data_die_comb, males_data_die_alt_comb_altA, females_data_die_alt_comb_altA)

# Create the combined graph
graph_prob_mf_die_combined_A <- ggplot(final_data_die_comb_A, aes(x = age_class, y = probability_of_dyingMPD, colour = scenario, group = scenario)) +
  geom_line() +
  geom_point() +
  facet_wrap(~ gender) +
  theme_minimal() +
  labs(title = "Probability of dying when MPD: comparison across scenarios",
       x = "Age class",
       y = "Probability",
       colour = "Scenario") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), plot.title = element_text(size = 10))

graph_prob_mf_die_combined_A
```

The new version of the microsimulation model is to be initialized:

```{r}
n.i <- 26000 #number of newly diagnosed PD patients in 2020, according to the French public health agency. This institution also claims that PD is approximately 1.5 times more frequent in men than women
n_males <- n.i * 0.6
n_females <- n.i * 0.4
n.t <- 15 #number of cycles of the model: starting from 2020, 2 5-year cycles are necessary to reach 2030
n.sim <- 100 #number of simulations. The higher the number of simulations, the more precise the results of the model, but the processing power at hand should be taken into account when setting this number.
v.n <- c("P", "MPD", "APD", "D") # model states
n.s <- length(v.n) # number of health states
v.M_1_males <- rep("P", n_males) #everyone begins in the prodromal stage
v.M_1_females <- rep("P", n_females) #everyone begins in the prodromal stage
d.c.1 <- ((1+0.025)^5) - 1 # 5-year discount rate for costs, assuming a annual discount rate of 2.5% for the 2020-2070 period
d.c.2 <- ((1+0.015)^5) - 1 # 5-year discount rate for costs, assuming a annual discount rate of 1.5% for the 2070-2095 period
```

Costs in alternative scenarios are:

```{r, warning=FALSE, message=FALSE}
#Males
lambda <- 0.5
transition_costs_m_alt <- list()
for (cycle in 1:10) {
  c.P.m <- costs_model_males[[cycle, "cp"]] + (lambda*(2/5)*costs_model_males[[cycle, "c"]])
  c.MPD.m <- costs_model_males[[cycle, "c"]]
  c.APD.m <- costs_model_males[[cycle, "C"]]
  c.D.m <- costs_model_males[[cycle, "D"]]
  transition_costs_m_alt[[cycle]] <- list(
    "P" = c(c.P.m),
    "MPD" = c(c.MPD.m),
    "APD" = c(c.APD.m),
    "D" = c(c.D.m)
  )
  
}

#Costs are repeated for 95+
last_transition_m_alt <- transition_costs_m_alt[[10]]
for (i in 11:n.t) {
  transition_costs_m_alt[[i]] <- last_transition_m_alt
}
print(transition_costs_m_alt)

#Females
transition_costs_f_alt <- list()
for (cycle in 1:10) {
  c.P.f <- costs_model_females[[cycle, "cp"]] + (lambda*(2/5)*costs_model_females[[cycle, "c"]])
  c.MPD.f <- costs_model_females[[cycle, "c"]]
  c.APD.f <- costs_model_females[[cycle, "C"]]
  c.D.f <- costs_model_females[[cycle, "D"]]
  transition_costs_f_alt[[cycle]] <- list(
    "P" = c(c.P.f),
    "MPD" = c(c.MPD.f),
    "APD" = c(c.APD.f),
    "D" = c(c.D.f)
  )
  
}

#Costs are repeated for 95+
last_transition_f_alt <- transition_costs_f_alt[[10]]
for (i in 11:n.t) {
  transition_costs_f_alt[[i]] <- last_transition_f_alt
}

print(transition_costs_f_alt)
```

The microsimulation function for male patients is:

```{r}
m.M <- m.C <-  matrix(nrow = n_males,
                      ncol = n.t + 1,
                      dimnames = list(paste("ind", 1:n_males, sep = " "), paste("cycle", 0:n.t, sep = " "))) 
m.M[, 1] <- v.M_1_males
```

```{r, warning=FALSE, message=FALSE}
#Males
Probs <- function(state){
  return(transition_prob_m_alt[[state]])
}
Costs <- function(state) {
  return(transition_costs_m[[state]])
}

# Testing 
set.seed(1) #deterministic sequence of random numbers

transition_prob_m_altA <- transition_prob_m_altA %>% 
  map(~ map(.x, ~ sort(.x, decreasing = TRUE)))
loop_microsim_altA <- function(n.t) {
     for (t in 1:n.t) {
      m.p <- m.M_altA[, t]
# calculate the transition probabilities at cycle t
     #state <- list("P", "MPD", "APD","D")
      for (i in 1:length(m.p)) {
        current_state <- m.p[i]
        new_state <- m.p[i]
         if (t > 10) {
           new_state <- sample(names(transition_prob_m_altA[[10]][[current_state]]), 1, prob = transition_prob_m_altA[[10]][[current_state]])
         } else {
           new_state <- sample(names(transition_prob_m_altA[[t]][[current_state]]), 1, prob = transition_prob_m_altA[[t]][[current_state]])
         }
        m.M_altA[i, t + 1] <- new_state
        #m.C[i, t + 1] <- Costs(current_state)
      }   
    } # close the loop for the time points
  return(m.M_altA)
}

# Init m.M #repeat it!!!!
model_results_m_altA <- list()
for(i in 1:n.sim) {
m.M_altA <- m.C_altA <-  matrix(nrow = n_males,
                      ncol = n.t + 1,
                      dimnames = list(paste("ind", 1:n_males, sep = " "), paste("cycle", 0:n.t, sep = " "))) 
m.M_altA[, 1] <- v.M_1_males
# Microsim loop
model_results_m_altA[[i]] <- loop_microsim_altA(n.t)
print(i)
} 
# repeat it!!!


#Results of the median simulation, the 50th
model_results_m_altA[[50]][1:300, ]
df_m.M_altA <- model_results_m_altA[[50]] %>% as.tibble()
library(janitor)
map(
  c("cycle 0", "cycle 1", "cycle 2", "cycle 3", "cycle 4", "cycle 5",
    "cycle 6", "cycle 7", "cycle 8", "cycle 9", "cycle 10", "cycle 11", "cycle 12", "cycle 13", "cycle 14"),
  ~ df_m.M_altA %>% tabyl(!!sym(.x))
)

# Transition costs in a dataframe
transition_costs_m_alt <-
 transition_costs_m_alt %>% 
  data.table::rbindlist() %>% 
  t() %>% 
  as_tibble(rownames = "Stage") %>% 
  rename_with(~ c("Stage", "cycle 0", "cycle 1", "cycle 2", "cycle 3", "cycle 4",
   "cycle 5", "cycle 6", "cycle 7", "cycle 8", "cycle 9", "cycle 10", "cycle 11", "cycle 12", "cycle 13", "cycle 14")) %>% 
  pivot_longer(cols = -Stage, names_to = "cycle", values_to = "cost")


final_cost_m_altA <-
  map(
    model_results_m_altA,
    ~ .x %>% 
      as_tibble() %>% 
      mutate(id = row_number()) %>% 
      pivot_longer(cols = -id, names_to = "cycle", values_to = "Stage") %>% 
      left_join(
        transition_costs_m_alt
      )
  )
  

final_cost_m2_altA <-
  map(
    final_cost_m_altA,
    ~ .x %>% 
      group_by(cycle) %>% 
      summarise(
      n = n(),
      sum_costs = sum(cost, na.rm = TRUE)
    ) %>% 
    mutate(cycle = as_factor (cycle) %>%  fct_relevel(c("cycle 0", "cycle 1", "cycle 2", "cycle 3", "cycle 4", "cycle 5", "cycle 6", "cycle 7", "cycle 8", "cycle 9", "cycle 10", "cycle 11", "cycle 12", "cycle 13", "cycle 14"))) %>%  arrange(cycle) %>% 
     filter(cycle != "cycle 15")
  )
final_cost_m2_altA
```

```{r}
m.M <- m.C <-  matrix(nrow = n_females,
                      ncol = n.t + 1,
                      dimnames = list(paste("ind", 1:n_females, sep = " "), paste("cycle", 0:n.t, sep = " "))) 
m.M[, 1] <- v.M_1_females
```


The same reasoning is applied to female patients:

```{r, warning=FALSE, message=FALSE}
#Females
Probs <- function(state){
  return(transition_prob_f_alt[[state]])
}
Costs <- function(state) {
  return(transition_costs_f[[state]])
}
# Testing 
set.seed(1) #deterministic sequence of random numbers

transition_prob_f_altA <- transition_prob_f_altA %>% 
  map(~ map(.x, ~ sort(.x, decreasing = TRUE)))
loop_microsim_altA <- function(n.t) {
     for (t in 1:n.t) {
      m.p <- m.M_altA[, t]
# calculate the transition probabilities at cycle t
     #state <- list("P", "MPD", "APD","D")
      for (i in 1:length(m.p)) {
        current_state <- m.p[i]
        new_state <- m.p[i]
         if (t > 10) {
           new_state <- sample(names(transition_prob_f_altA[[10]][[current_state]]), 1, prob = transition_prob_f_altA[[10]][[current_state]])
         } else {
           new_state <- sample(names(transition_prob_f_altA[[t]][[current_state]]), 1, prob = transition_prob_f_altA[[t]][[current_state]])
         }
        m.M_altA[i, t + 1] <- new_state
        #m.C[i, t + 1] <- Costs(current_state)
      }   
    } # close the loop for the time points
  return(m.M_altA)
}

# Init m.M #repeat it!!!!
model_results_f_altA <- list()
for(i in 1:n.sim) {
m.M_altA <- m.C_altA <-  matrix(nrow = n_females,
                      ncol = n.t + 1,
                      dimnames = list(paste("ind", 1:n_females, sep = " "), paste("cycle", 0:n.t, sep = " "))) 
m.M_altA[, 1] <- v.M_1_females
# Microsim loop
model_results_f_altA[[i]] <- loop_microsim_altA(n.t)
print(i)
}  
# repeat it!!!

#Results of the median simulation, the 50th
model_results_f_altA[[50]][1:300, ]
df_m.M_altA <- model_results_f_altA[[50]] %>% as.tibble()
library(janitor)
map(
  c("cycle 0", "cycle 1", "cycle 2", "cycle 3", "cycle 4", "cycle 5",
    "cycle 6", "cycle 7", "cycle 8", "cycle 9", "cycle 10", "cycle 11", "cycle 12", "cycle 13", "cycle 14"),
  ~ df_m.M_altA %>% tabyl(!!sym(.x))
)

#Transition costs
transition_costs_f_alt <-
  transition_costs_f_alt %>% 
  data.table::rbindlist() %>% 
  t() %>% 
  as_tibble(rownames = "Stage") %>% 
  rename_with(~ c("Stage", "cycle 0", "cycle 1", "cycle 2", "cycle 3", "cycle 4",
    "cycle 5", "cycle 6", "cycle 7", "cycle 8", "cycle 9", "cycle 10", "cycle 11", "cycle 12", "cycle 13", "cycle 14")) %>% 
  pivot_longer(cols = -Stage, names_to = "cycle", values_to = "cost")

final_cost_f_altA <- map(
    model_results_f_altA,
    ~ .x %>% 
      as_tibble() %>% 
      mutate(id = row_number()) %>% 
      pivot_longer(cols = -id, names_to = "cycle", values_to = "Stage") %>% 
      left_join(
        transition_costs_f_alt
      )
  )
 

final_cost_f2_altA <-
  map(
    final_cost_f_altA,
    ~ .x %>% 
      group_by(cycle) %>% 
      summarise(
      n = n(),
      sum_costs = sum(cost, na.rm = TRUE)
    ) %>% 
    mutate(cycle = as_factor (cycle) %>%  fct_relevel(c("cycle 0", "cycle 1", "cycle 2", "cycle 3", "cycle 4", "cycle 5", "cycle 6", "cycle 7", "cycle 8", "cycle 9", "cycle 10", "cycle 11", "cycle 12", "cycle 13", "cycle 14"))) %>%  arrange(cycle) %>% 
    filter(cycle != "cycle 15")
  )
final_cost_f2_altA
```

The variability of costs over 30 simulations is observed through a box plot:

```{r}
#Males
final_cost_m2_alt_combinedA <- bind_rows(final_cost_m2_altA)

final_cost_m2_alt_combinedA$cycle <- factor(final_cost_m2_alt_combinedA$cycle, 
                                           levels = c("cycle 0", "cycle 1", "cycle 2", "cycle 3", "cycle 4", 
                                                      "cycle 5", "cycle 6", "cycle 7", "cycle 8", "cycle 9", "cycle 10", "cycle 11", "cycle 12", "cycle 13", "cycle 14"))

var_graph_m_altA <- ggplot(final_cost_m2_alt_combinedA, aes(x = cycle, y = sum_costs)) +
  geom_boxplot(width = 0.9) +  
  labs(title = "Box Plot of Total Costs per Cycle, Alternative Scenario A2 (Males)",
       x = "Cycle",
       y = "Variability") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
var_graph_m_altA

#Females
final_cost_f2_alt_combinedA <- bind_rows(final_cost_f2_altA)

final_cost_f2_alt_combinedA$cycle <- factor(final_cost_f2_alt_combinedA$cycle, 
                                           levels = c("cycle 0", "cycle 1", "cycle 2", "cycle 3", "cycle 4", 
                                                      "cycle 5", "cycle 6", "cycle 7", "cycle 8", "cycle 9", "cycle 10", "cycle 11", "cycle 12", "cycle 13", "cycle 14"))

var_graph_f_altA <- ggplot(final_cost_f2_alt_combinedA, aes(x = cycle, y = sum_costs)) +
  geom_boxplot(width = 0.9) +  
  labs(title = "Box Plot of Total Costs per Cycle, Alternative Scenario A2 (Females)",
       x = "Cycle",
       y = "Variability") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
var_graph_f_altA
```

The graphs showcasing costs over cycles are:

```{r}
#Averaging costs across simulations
#Males
combined_costs_m_altA <- map_df(final_cost_m2_altA, ~ .x)
mean_costs_per_cycle_m_altA <- combined_costs_m_altA %>%
  group_by(cycle) %>%
  summarise(avg_tot_costs = mean(sum_costs, na.rm = TRUE)) %>%
  mutate(cycle = as_factor(cycle) %>% fct_relevel(c("cycle 0", "cycle 1", "cycle 2", "cycle 3", "cycle 4", "cycle 5", "cycle 6", "cycle 7", "cycle 8", "cycle 9", "cycle 10", "cycle 11", "cycle 12", "cycle 13", "cycle 14"))) %>%
  arrange(cycle)
print(mean_costs_per_cycle_m_altA)
#Females
combined_costs_f_altA <- map_df(final_cost_f2_altA, ~ .x)
mean_costs_per_cycle_f_altA <- combined_costs_f_altA %>%
  group_by(cycle) %>%
  summarise(avg_tot_costs = mean(sum_costs, na.rm = TRUE)) %>%
  mutate(cycle = as_factor(cycle) %>% fct_relevel(c("cycle 0", "cycle 1", "cycle 2", "cycle 3", "cycle 4", "cycle 5", "cycle 6", "cycle 7", "cycle 8", "cycle 9", "cycle 10", "cycle 11", "cycle 12", "cycle 13", "cycle 14"))) %>%
  arrange(cycle)
print(mean_costs_per_cycle_f_altA)

#Graphs
#Males
graph1_altA <- ggplot(data = mean_costs_per_cycle_m_altA %>% mutate(Year = c("2020-25", "2025-30", "2030-35", "2035-40", "2040-45", "2045-50", "2050-55", "2055-60", "2060-65", "2065-70", "2070-75", "2075-80", "2080-85", "2085-90", "2090-95")), aes(x = Year, y = avg_tot_costs))+
  geom_col(fill = "turquoise") +
  ggtitle("Average total costs from microsimulation, alternative scenario A2 (Males)") +
  xlab("Year") +
  ylab("Cost") +
  theme_minimal() +
  scale_y_continuous(labels = scales::comma, limits = c(0, max(mean_costs_per_cycle_m_alt$avg_tot_costs) * 1)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8))
  options(scipen=999)
  
#Females
graph2_altA <- ggplot(data = mean_costs_per_cycle_f_altA %>% mutate(Year = c("2020-25", "2025-30", "2030-35", "2035-40", "2040-45", "2045-50", "2050-55", "2055-60", "2060-65", "2065-70", "2070-75", "2075-80", "2080-85", "2085-90", "2090-95")), aes(x = Year, y = avg_tot_costs))+
  geom_col(fill = "pink") +
  ggtitle("Average total costs from microsimulation, alternative scenario A2 (Females)") +
  xlab("Year") +
  ylab("Cost") +
  theme_minimal() +
  scale_y_continuous(labels = scales::comma, limits = c(0, max(mean_costs_per_cycle_f_alt$avg_tot_costs) * 1)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8))
  options(scipen=999)

graph1_altA
graph2_altA
```

Let's compare graphs across scenarios:

```{r}
#Males
mean_costs_combined_mA <- mean_costs_per_cycle_m %>%
  rename(avg_tot_costs_baseline = avg_tot_costs) %>%
  inner_join(mean_costs_per_cycle_m_altA %>%
               rename(avg_tot_costs_alt = avg_tot_costs),
             by = "cycle") %>%
  mutate(extra_cost = avg_tot_costs_baseline - avg_tot_costs_alt) %>% 
  pivot_longer(cols = c(avg_tot_costs_baseline, avg_tot_costs_alt, extra_cost),
               names_to = "Scenario", values_to = "avg_tot_costs") %>%
  mutate(Scenario = recode(Scenario, "avg_tot_costs_baseline" = "Baseline", "avg_tot_costs_alt" = "Alternative A2", "extra_cost" = "Extra cost of baseline")) %>% 
  filter(Scenario != "Baseline") %>% 
  mutate(
    Scenario = as_factor(Scenario) %>% fct_relevel("Extra cost of baseline")
  )

graph_combined_mA <- ggplot(data = mean_costs_combined_mA, aes(x = cycle, y = avg_tot_costs, fill = "Gains/losses")) +
  geom_col(data = subset(mean_costs_combined_mA, Scenario == "Alternative A2"), fill = "blue", width = 0.4) +
  geom_col(data = subset(mean_costs_combined_mA, Scenario == "Extra cost of baseline"),
           aes(fill = ifelse(avg_tot_costs < 0, "Loss", "Gain")), 
           width = 0.4) +
  scale_fill_manual(name = "Gains/losses", values = c("Alternative A2" = "blue", "Loss" = "red", "Gain" = "green")) +
  ggtitle("Comparison of average total costs of alternative scenario A2 wrt baseline scenario (Males)") +
  xlab("Cycle") +
  ylab("Cost") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 7), plot.title = element_text(size = 10)) +
  scale_y_continuous(labels = scales::comma, limits = c(min(mean_costs_combined_m$avg_tot_costs), max(mean_costs_combined_m$avg_tot_costs)))
graph_combined_mA

#Females
mean_costs_combined_fA <- mean_costs_per_cycle_f %>%
  rename(avg_tot_costs_baseline = avg_tot_costs) %>%
  inner_join(mean_costs_per_cycle_f_altA %>%
               rename(avg_tot_costs_alt = avg_tot_costs),
             by = "cycle") %>%
  mutate(extra_cost = avg_tot_costs_baseline - avg_tot_costs_alt) %>% 
  pivot_longer(cols = c(avg_tot_costs_baseline, avg_tot_costs_alt, extra_cost),
               names_to = "Scenario", values_to = "avg_tot_costs") %>%
  mutate(Scenario = recode(Scenario, "avg_tot_costs_baseline" = "Baseline", "avg_tot_costs_alt" = "Alternative A2", "extra_cost" = "Extra cost of baseline")) %>% 
  filter(Scenario != "Baseline") %>% 
  mutate(
    Scenario = as_factor(Scenario) %>% fct_relevel("Extra cost of baseline")
  )

graph_combined_fA <- ggplot(data = mean_costs_combined_fA, aes(x = cycle, y = avg_tot_costs, fill = "Gains/losses")) +
  geom_col(data = subset(mean_costs_combined_fA, Scenario == "Alternative A2"), fill = "pink", width = 0.4) +
  geom_col(data = subset(mean_costs_combined_fA, Scenario == "Extra cost of baseline"),
           aes(fill = ifelse(avg_tot_costs < 0, "Loss", "Gain")), 
           width = 0.4) +
  scale_fill_manual(name = "Gains/losses", values = c("Alternative A2" = "pink", "Loss" = "red", "Gain" = "green")) +
  ggtitle("Comparison of average total costs of alternative scenario A2 wrt baseline scenario (Females)") +
  xlab("Cycle") +
  ylab("Cost") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 7), plot.title = element_text(size = 10)) +
  scale_y_continuous(labels = scales::comma, limits = c(min(mean_costs_combined_f$avg_tot_costs), max(mean_costs_combined_f$avg_tot_costs)))
graph_combined_fA
```

This scenario is characterized by more significant financial gains compared to the situation of the previous scenario due to a higher mortality.  

Discounted costs are:

```{r}
discounted_costs_m_altA <-
  map(final_cost_m2_altA, 
  ~ .x %>%  
   mutate(
    dw = ifelse(row_number() <= 10, 
                (1)/((1+d.c.1)^(row_number()-1)), 
                (1)/((1+d.c.2)^(row_number()-1))), #vector of discount weights
    discounted_costs = sum_costs * dw )%>% #the column "discounted_costs" represents the vector of discounted costs  
  select(cycle, n, discounted_costs) 
  )
discounted_costs_m_altA

# Females
discounted_costs_f_altA <-
  map(final_cost_f2_altA, 
  ~ .x %>%  
   mutate(
    dw = ifelse(row_number() <= 10, 
                (1)/((1+d.c.1)^(row_number()-1)), 
                (1)/((1+d.c.2)^(row_number()-1))), #vector of discount weights
    discounted_costs = sum_costs * dw )%>% #the column "discounted_costs" represents the vector of discounted costs  
  select(cycle, n, discounted_costs) 
  )
discounted_costs_f_altA

```

The Total Discounted Cost of PD patients for n.t = 15 (cycles) is:

```{r}
#Males
tot_discounted_costs_m_altA <- list()
for(i in 1:n.sim) {
tot_discounted_cost <- sum(discounted_costs_m_altA[[i]]$discounted_costs) 
tot_discounted_costs_m_altA[[i]] <- list(
  "tot_discounted_costs" = c(tot_discounted_cost)
)
}
print(tot_discounted_costs_m_altA)
#Females
tot_discounted_costs_f_altA <- list()
for(i in 1:n.sim) {
tot_discounted_cost <- sum(discounted_costs_f_altA[[i]]$discounted_costs) 
tot_discounted_costs_f_altA[[i]] <- list(
  "tot_discounted_costs" = c(tot_discounted_cost)
)
}
print(tot_discounted_costs_f_altA)
#Averaging total costs across simulations
TDC_m_alternativeA <- mean(unlist(tot_discounted_costs_m_altA))
TDC_f_alternativeA <- mean(unlist(tot_discounted_costs_f_altA))
#Final result
TDC_alternativeA <- TDC_m_alternativeA + TDC_f_alternativeA
TDC_alternativeA
```

The total amount of money that needs to be invested for early detection is:

```{r}
total_savingsA <- TDC_baseline - TDC_alternativeA
total_savingsA
```

Consistently with the above discussion, the loss is more moderate than that of alternative scenario A1.

The following is a useful graph to evaluate the trends of P, MPD, APD and D patients over the microsimulation time period:

```{r}
prepare_plot_data <- function(df_m, scenario) {
  df_m %>%
    as_tibble() %>%
    pivot_longer(cols = starts_with("cycle"), names_to = "cycle", values_to = "state") %>%
    count(cycle, state) %>%
    group_by(cycle) %>%
    mutate(percent = n / sum(n)) %>%
    ungroup() %>%
    mutate(scenario = scenario)
}


num_cols_m <- ncol(model_results_m[[50]])
num_cols_m_altA <- ncol(model_results_m_altA[[50]])

colnames(model_results_m[[50]]) <- paste("cycle", 0:(num_cols_m-1), sep = " ")
colnames(model_results_m_altA[[50]]) <- paste("cycle", 0:(num_cols_m_altA-1), sep = " ")


# Baseline
df_m.M <- model_results_m[[50]] %>% prepare_plot_data("Baseline")

# Alternative
df_m.M_altA <- model_results_m_altA[[50]] %>% prepare_plot_data("Alternative")

# Combining
combined_data_mA <- bind_rows(df_m.M, df_m.M_altA)

combined_data1A <- combined_data_mA %>% mutate(cycle = factor(cycle, levels = c("cycle 0", "cycle 1", "cycle 2", "cycle 3", "cycle 4", "cycle 5", "cycle 6", "cycle 7", "cycle 8", "cycle 9", "cycle 10", "cycle 11", "cycle 12", "cycle 13", "cycle 14"))) %>% 
filter(cycle != "cycle 15")

# Plot 
summary_plot_maleA <- ggplot(combined_data1A %>% mutate(statescenario = paste(state, scenario)), aes(x = cycle, y = percent, color = state, linetype = scenario, group = statescenario)) +
  geom_line() +
  labs(title = "Comparison of states across cycles and scenarios (Males)",
       x = "Cycle",
       y = "Percentage") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
summary_plot_maleA
```

The graph for females: 

```{r}
prepare_plot_data <- function(df_m, scenario) {
  df_m %>%
    as_tibble() %>%
    pivot_longer(cols = starts_with("cycle"), names_to = "cycle", values_to = "state") %>%
    count(cycle, state) %>%
    group_by(cycle) %>%
    mutate(percent = n / sum(n)) %>%
    ungroup() %>%
    mutate(scenario = scenario)
}


num_cols_f <- ncol(model_results_f[[50]])
num_cols_f_altA <- ncol(model_results_f_altA[[50]])

colnames(model_results_f[[50]]) <- paste("cycle", 0:(num_cols_f-1), sep = " ")
colnames(model_results_f_altA[[50]]) <- paste("cycle", 0:(num_cols_f_altA-1), sep = " ")


# Baseline
df_m.M <- model_results_f[[50]] %>% prepare_plot_data("Baseline")

# Alternative
df_m.M_altA <- model_results_f_altA[[50]] %>% prepare_plot_data("Alternative")

# Combining
combined_data_fA <- bind_rows(df_m.M, df_m.M_altA)

combined_data2A <- combined_data_fA %>% mutate(cycle = factor(cycle, levels = c("cycle 0", "cycle 1", "cycle 2", "cycle 3", "cycle 4", "cycle 5", "cycle 6", "cycle 7", "cycle 8", "cycle 9", "cycle 10", "cycle 11", "cycle 12", "cycle 13", "cycle 14"))) %>% 
filter(cycle != "cycle 15")

# Plot 
summary_plot_femaleA <- ggplot(combined_data2A %>% mutate(statescenario = paste(state, scenario)), aes(x = cycle, y = percent, color = state, linetype = scenario, group = statescenario)) +
  geom_line() +
  labs(title = "Comparison of states across cycles and scenarios (Females)",
       x = "Cycle",
       y = "Percentage") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
summary_plot_femaleA
```

Losses are really prominent from a financial point of view, as indicated by the final result and by the graph comparing costs across scenarios:

* a higher average number of MPD patients means higher medical costs

* a lower average number of APD patients represents a financial gain

However, if the point of view of patients is considered, the previous remarks represent a gain both in terms of life quality and life expectancy.

Let's evaluate this gain:

```{r}
process_model_result <- function(model_result) {
  df <- model_result %>% as_tibble()
  cycle_columns <- paste0("cycle ", 0:14)
  map(cycle_columns, ~ df %>% tabyl(!!sym(.x)))
}

# Males
percent_tables_m <- map(model_results_m[1:100], process_model_result)

# Females
percent_tables_f <- map(model_results_f[1:100], process_model_result)

# Aggregate results and compute the averages
aggregate_results <- function(percent_tables) {
  all_states <- c("P", "MPD", "APD", "D")
  cycle_columns <- paste0("cycle ", 0:14)
  
  aggregated <- map(cycle_columns, function(cycle) {
    state_sums <- map_dbl(all_states, function(state) {
      state_n_values <- map_dbl(percent_tables, ~ {
        tabyl_result <- .x[[which(cycle_columns == cycle)]]
        if (state %in% tabyl_result[[1]]) {
          return(tabyl_result$n[tabyl_result[[1]] == state])
        } else {
          return(0)
        }
      })
      mean(state_n_values)
    })
    tibble(state = all_states, mean_n = state_sums)
  })
  
  bind_rows(aggregated, .id = "cycle") %>%
    mutate(cycle = as.numeric(cycle) - 1) 
}

# Aggregate for males
aggregated_m <- aggregate_results(percent_tables_m)

# Aggregate for females
aggregated_f <- aggregate_results(percent_tables_f)

aggregated_m
aggregated_f


#Same approach for the alternative scenario

percent_tables_m_altA <- map(model_results_m_altA[1:100], process_model_result)
percent_tables_f_altA <- map(model_results_f_altA[1:100], process_model_result)

# Aggregate for males
aggregated_m_altA <- aggregate_results(percent_tables_m_altA)

# Aggregate for females
aggregated_f_altA <- aggregate_results(percent_tables_f_altA)

aggregated_m_altA
aggregated_f_altA
```

With the new tables at hand it is possible to compute the 3 differences that indicate a gain for patients:

* the alternative scenario has more MPD patients, which means that there are more patients spending time in the MPD state. This state is characterized by decent life conditions if compared to the severe stage.

* the alternative scenario has less APD patients, which means that there are less patients spending time in the severe stage of the disease, characterized by severe symptoms that heavily impact life quality.


```{r}
library(dplyr)

calculate_differencesA <- function(baseline, alternativeA) {
  baseline %>%
    inner_join(alternativeA, by = c("cycle", "state"), suffix = c("_baseline", "_altA")) %>%
    mutate(
      difference = case_when(
        state == "MPD" ~ mean_n_altA - mean_n_baseline,
        state == "APD" ~ mean_n_baseline - mean_n_altA,
        state == "D" ~ mean_n_baseline - mean_n_altA,
        TRUE ~ NA_real_
      )
    ) %>%
    select(cycle, state, difference) %>%
    filter(!is.na(difference))
}

differences_mA <- calculate_differencesA(aggregated_m, aggregated_m_altA)
differences_fA <- calculate_differencesA(aggregated_f, aggregated_f_altA)

differences_mA
differences_fA
```

Differences are aggregated with respect to cycles, truncated, since patients have to be counted with integer numbers, and multiplied by 5, since each cycle lasts 5 years.

```{r}
#Males
summary_mA <- differences_mA %>% 
    group_by(state) %>%
    summarise(
      diff_sum = sum(difference, na.rm = TRUE)
    ) %>%
    mutate(
      diff_sum = floor(diff_sum) * 5
    ) %>%
    select(state, diff_sum)
summary_mA

#Females
summary_fA <- differences_fA %>% 
    group_by(state) %>%
    summarise(
      diff_sum = sum(difference, na.rm = TRUE)
    ) %>%
    mutate(
      diff_sum = floor(diff_sum) * 5
    ) %>%
    select(state, diff_sum)
summary_fA

```

The previous are the total numbers of years:

* additionally spent in MPD

* less spent in APD

The results with respect to the average male or female patient require the previous results to be divided by the total number of male and females patients:

```{r}
averages_mA <- summary_mA %>%
    mutate(
      diff_sum = (diff_sum)/(n_males)
    ) %>%
    select(state, diff_sum)

averages_fA <- summary_fA %>%
    mutate(
      diff_sum = (diff_sum)/(n_females)
    ) %>%
    select(state, diff_sum)

averages_mA
averages_fA
```


As expected, the gains in terms of life expectancy are moderate and could be expressed in terms of months. As previously discussed, this gain should not be commented as it represents an artificial gain that does not appear as a hypothesis of alternative scenario A2. On the other hand, in alternative scenario A2 a male patient gains, on average, about 1 year and 10 months more in the mild stage and about 1 year and 3 months less in the severe stage. Moreover, a female patient gains, on average, about 1 year 11 months more in the mild stage and about 1 year and 4 months less in the severe stage.

The graph representing gains from a patient's point of view in terms of:

* additional months spent as a mild patient (MPD)
* fewer months spent as a severe patient (APD)

is the following:

```{r}
calculate_differencesm1A <- function(baseline, alternative) {
  baseline %>%
    inner_join(alternative, by = c("cycle", "state"), suffix = c("_baseline", "_alt")) %>%
    mutate(
      difference = case_when(
        state == "MPD" ~ ((((((mean_n_alt - mean_n_baseline)*5))/(n_males)))*(12)),
        state == "APD" ~ ((((((mean_n_baseline - mean_n_alt)*5))/(n_males)))*(12)),
        TRUE ~ NA_real_
      )
    ) %>%
    select(cycle, state, difference) %>%
    filter(!is.na(difference))
}

calculate_differencesf1A <- function(baseline, alternative) {
  baseline %>%
    inner_join(alternative, by = c("cycle", "state"), suffix = c("_baseline", "_alt")) %>%
    mutate(
      difference = case_when(
        state == "MPD" ~ ((((((mean_n_alt - mean_n_baseline)*5))/(n_females)))*(12)),
        state == "APD" ~ ((((((mean_n_baseline - mean_n_alt)*5))/(n_females)))*(12)),
        TRUE ~ NA_real_
      )
    ) %>%
    select(cycle, state, difference) %>%
    filter(!is.na(difference))
}

differences_m1A <- calculate_differencesm1A(aggregated_m, aggregated_m_altA)
differences_f1A <- calculate_differencesf1A(aggregated_f, aggregated_f_altA)

plot_differencesm1A <- ggplot(differences_m1A, aes(x = cycle, y = difference, color = state)) +
  geom_line(size = 0.8) +        
  theme_minimal() +              
  labs(title = "Gains of the average male patient per cycle (Alternative scenario A2)", 
       x = "Cycle", 
       y = "Months gained") +
  scale_x_continuous(breaks = unique(differences_m1$cycle)) +
  theme(plot.title = element_text(hjust = 0.5)) 

plot_differencesm1A

plot_differencesf1A <- ggplot(differences_f1A, aes(x = cycle, y = difference, color = state)) +
  geom_line(size = 0.8) +        
  theme_minimal() +              
  labs(title = "Gains of the average female patient per cycle (Alternative scenario A2)", 
       x = "Cycle", 
       y = "Months gained") +
  scale_x_continuous(breaks = unique(differences_f1$cycle)) +
  theme(plot.title = element_text(hjust = 0.5)) 

plot_differencesf1A
```


```{r}
plot_differencesm1A1 <- ggplot(differences_m1A, aes(x = cycle, y = difference, color = state)) +
  geom_line(size = 0.8) +        
  theme_minimal() +              
  labs(title = "Gains of the average male patient per cycle (Alternative scenario A2)", 
       x = "Cycle", 
       y = "Months gained") +
  scale_x_continuous(breaks = unique(differences_m1$cycle)) +
  geom_vline(xintercept = 5, color = "red", linetype = "dashed", size = 0.8) +
  theme(plot.title = element_text(hjust = 0.5)) 

plot_differencesm1A1

plot_differencesf1A1 <- ggplot(differences_f1A, aes(x = cycle, y = difference, color = state)) +
  geom_line(size = 0.8) +        
  theme_minimal() +              
  labs(title = "Gains of the average female patient per cycle (Alternative scenario A2)", 
       x = "Cycle", 
       y = "Months gained") +
  scale_x_continuous(breaks = unique(differences_f1$cycle)) +
  geom_vline(xintercept = 5, color = "red", linetype = "dashed", size = 0.8) +
  theme(plot.title = element_text(hjust = 0.5)) 

plot_differencesf1A1
```


### Alternative scenario: B

The alternative scenario B considers a 2-year and a half delay in the onset of APD thanks to AI-based early detection. Physicians will be able to slow down the progression of PD thanks to an aggressive early treatment of the disease, resulting in a higher probability of remaining in the mild stage (P(MPD→MPD)) which consequently reduces the probability of transitioning to the severe stage (P(MPD→APD)).

The increase in P(MPD→MPD) is modelled through the following formula: $$
p^\prime = p^{\frac{60-x}{60}}$$

where p' is the new probability, p is the initial probability, 60 is the number of months for the 5-year period and x is the number of additional months of the mild stage gained due to early detection. Consequently, the new probability of transitioning to the severe stage is P(MPD→APD) = 1 – p’ – P(MPD→D).

According to the initial hypothesis, x = 12 months and therefore $$ p^\prime=\ p^\frac{60-30}{60}=p^\frac{1}{2} $$.

Transition probabilities will be changed accordingly:

```{r}
library(dplyr)
library(ggplot2)
library(fastmap)
library(purrr)
library(tibble)
library(tidyr)
library(forcats)
age_classes <- c("50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85-89", "90-94", "95et+")
genders <- c("Male", "Female")

generate_transition_matrix_alt_old2 <- function(summary_df, summary_df2, age_classes, gender_name) {
  
  x <- matrix(NA, nrow = 4, ncol = 4)

  x[1, 1] <- 0
  f_prob1 <- f_prob %>% 
    filter(`Age class` == age_class, Gender == gender_name) %>% 
    summarise(f_prob = F) %>% 
    pull(f_prob)
  x[1, 2] <- 1 - f_prob1
  x[1, 3] <- 0
  x[1, 4] <- f_prob1
  
  
   numerator_MPD_APD <- summary_df1 %>%
    filter(CLA_AGE_5 == age_class & gender == gender_name & severity == "Transitioned" & yod_binary == "Alive") %>%
    summarise(n_patients = sum(n_patients)) %>%
    pull(n_patients)

  numerator_MPD_MPD <- summary_df %>%
    filter(CLA_AGE_5 == age_class & gender == gender_name & severity == "Mild" & yod_binary == "Alive") %>%
    summarise(n_patients = sum(n_patients)) %>%
    pull(n_patients)

  numerator_MPD_D <- summary_df %>%
    filter(CLA_AGE_5 == age_class & gender == gender_name & severity %in% c("Mild", "Transitioned") & yod_binary == "Dead") %>%
    summarise(n_patients = sum(n_patients)) %>%
    pull(n_patients)

  denominator_MPD <- summary_df %>%
    filter(CLA_AGE_5 == age_class & gender == gender_name & severity %in% c("Mild", "Transitioned")) %>%
    summarise(n_patients = sum(n_patients)) %>%
    pull(n_patients)

  x[2, 1] <- 0
  
  x[2, 3] <- 1 - (numerator_MPD_D / denominator_MPD) - ((1 - (numerator_MPD_APD / denominator_MPD) - (numerator_MPD_D / denominator_MPD))^(1/2)) 

  x[2, 4] <- numerator_MPD_D / denominator_MPD

  x[2, 2] <- (1 - (numerator_MPD_APD / denominator_MPD - (numerator_MPD_D / denominator_MPD)))^(1/2)

  x[3, 1] <- 0
  x[3, 2] <- 0
  numerator_APD_D <- summary_df2 %>%
    filter(CLA_AGE_5 == age_class, gender == gender_name, severity_at_end == "Severe", yod_binary == "Dead") %>%
    summarise(n_patients = sum(n_patients)) %>% 
    pull(n_patients)
  
  denominator_APD_D <- summary_df2 %>%
    filter(CLA_AGE_5 == age_class, gender == gender_name, severity_at_end == "Severe") %>%
    summarise(n_patients = sum(n_patients)) %>% 
    pull(n_patients)
  
  x[3, 4] <- numerator_APD_D / denominator_APD_D

  x[3, 3] <- 1 - (numerator_APD_D / denominator_APD_D)

  x[4, 1] <- 0
  x[4, 2] <- 0
  x[4, 3] <- 0
  x[4, 4] <- 1

  return(x)
}

transition_matrices_alt_old2 <- list()

for (gender in genders) {
  for (age_class in age_classes) {
    matrix_name <- paste(gender, age_class, sep = "_")
    transition_matrices_alt_old2[[matrix_name]] <- generate_transition_matrix_alt_old2(summary_df, summary_df2, age_class, gender)
  }
}


transition_matrices_alt_old2

names(transition_matrices_alt_old2) <- NULL  

males_alt_old2 <- transition_matrices_alt_old2[1:10]
females_alt_old2 <- transition_matrices_alt_old2[11:20]

matrices_mf_alt_old2 <- list(males_alt_old2, females_alt_old2)

for (i in 1:length(males_alt_old2)) {
  colnames(males_alt_old2[[i]]) <- c("P.m", "MPD.m", "APD.m", "D.m")
  col_names_m <- c("P.m", "MPD.m", "APD.m", "D.m") 
  rownames(males_alt_old2[[i]]) <- c("P.m", "MPD.m", "APD.m", "D.m")
  row_names_m <- c("P.m", "MPD.m", "APD.m", "D.m") 
}
for (i in 1:length(females_alt_old2)) {
  colnames(females_alt_old2[[i]]) <- c("P.f", "MPD.f", "APD.f", "D.f")
  col_names_f <- c("P.f", "MPD.f", "APD.f", "D.f")
  rownames(females_alt_old2[[i]]) <- c("P.f", "MPD.f", "APD.f", "D.f")
  row_names_f <- c("P.f", "MPD.f", "APD.f", "D.f")
}
for (i in 1:length(males_alt_old2)) {
  dimnames(males_alt_old2[[i]]) <- list(row_names_m, col_names_m)
}
for (i in 1:length(females_alt_old2)) {
  dimnames(females_alt_old2[[i]]) <- list(row_names_f, col_names_f)
}

transition_matrices_mf_alt_old2 <- list(males_alt_old2, females_alt_old2)
transition_matrices_mf_alt_old2
transition_matrices_m_alt_old2 <- transition_matrices_mf_alt_old2[[1]]
transition_matrices_f_alt_old2 <- transition_matrices_mf_alt_old2[[2]]

extract_rows_as_named_list <- function(matrix) {
  list(
    P = setNames(as.numeric(matrix[1, ]), c("P", "MPD", "APD", "D")),
    MPD = setNames(as.numeric(matrix[2, ]), c("P", "MPD", "APD", "D")),
    APD = setNames(as.numeric(matrix[3, ]), c("P", "MPD", "APD", "D")),
    D = setNames(as.numeric(matrix[4, ]), c("P", "MPD", "APD", "D"))
  )
}

transition_prob_m_alt_old2 <- lapply(transition_matrices_m_alt_old2, extract_rows_as_named_list)

transition_prob_f_alt_old2 <- lapply(transition_matrices_f_alt_old2, extract_rows_as_named_list)

print("Transition Probabilities for Males:")
print(transition_prob_m_alt_old2)

print("Transition Probabilities for Females:")
print(transition_prob_f_alt_old2)
```

The graph showcasing probabilities of death with respect to severity:

```{r}
severity_labels <- c("Prodromal", "Mild", "Advanced")

# Extracting probabilities of death from matrices
extract_probabilities <- function(matrices, age_classes, genders) {
  data <- data.frame()
  
  for (i in 1:length(matrices)) {
    age_class <- age_classes[i]
    matrix <- matrices[[i]]
    
    data <- rbind(data, data.frame(
      age_class = age_class,
      gender = genders,
      severity = severity_labels[1],
      probability_of_death = matrix[1, 4]
    ))
    
    data <- rbind(data, data.frame(
      age_class = age_class,
      gender = genders,
      severity = severity_labels[2],
      probability_of_death = matrix[2, 4]
    ))
    
    data <- rbind(data, data.frame(
      age_class = age_class,
      gender = genders,
      severity = severity_labels[3],
      probability_of_death = matrix[3, 4]
    ))
  }
  
  return(data)
}

# Extracting data for males/females
males_data_alt_old2 <- extract_probabilities(males_alt_old2, age_classes, "Male")
females_data_alt_old2 <- extract_probabilities(females_alt_old2, age_classes, "Female")

final_data_alt_old2 <- rbind(males_data_alt_old2, females_data_alt_old2)

# Let's apply the adjustment
final_data_alt1_old2 <- final_data_alt_old2 %>%
  group_by(gender) %>% 
  mutate(probability_of_death = ifelse(
    age_class == "95et+" & severity == "Prodromal",
    probability_of_death[age_class == "95et+" & severity == "Mild"] -
      (probability_of_death[age_class == "90-94" & severity == "Mild"] -
       probability_of_death[age_class == "90-94" & severity == "Prodromal"]),
    probability_of_death
  ))

graph_prob_mf_alt2 <- ggplot(final_data_alt1_old2, aes(x = age_class, y = probability_of_death, color = severity, group = severity)) +
  geom_line() +
  geom_point() +
  facet_wrap(~ gender) +
  scale_color_manual(values = c("Prodromal" = "green", "Mild" = "orange", "Advanced" = "red")) +
  theme_minimal() +
  labs(title = "Probability of death with respect to severity, alternative scenario",
       x = "Age class",
       y = "Probability",
       color = "Severity") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
graph_prob_mf_alt2
```

Considering the alternative scenario B, the proposed assumption is to consider a 2-year and a half delay in the onset of APD thanks to AI-based early detection. The manipulation of the prodromal period should not be considered as this stage cannot be precisely detected by definition, as well as the rigor of the criteria used to distinguish between MPD and APD should not be varied as such variation is already used to tackle the issue related to the unclear definition of APD.  The new approach suggests that physicians will be able to slow down the progression of PD thanks to an aggressive early treatment of the disease, resulting in a higher probability of remaining in the mild stage (P(MPD→MPD)) which proportionally reduces the probability of transitioning to the severe stage (P(MPD→APD)) and the probability of dying (P(MPD→D)).
The increase in P(MPD→MPD) is modeled through the following formula: 

$$ p^\prime=\ p^\frac{60-x}{60} $$

where p’ is the new probability, p is the initial probability, 60 is the number of months for the 5-year period and x is the number of additional months of the mild stage gained due to early detection. Accordingly, the positive gain in P(MPD→APD) is defined as:

$$ \mathrm{\Delta}\ =\ p^\prime\ -\ p $$
This gain is counterbalanced by a proportional redistribution of its negative value, - delta, among the other two transition probabilities having MPD as the initial state, namely P(MPD→APD) and P(MPD→D).  For this purpose, the negative gain is decomposed into:

$$ -\ \mathrm{\Delta}\ =\ -\ \Delta(\mathrm{MPD} \rightarrow \mathrm{APD})\ -\ \Delta(\mathrm{MPD} \rightarrow \mathrm{D}) $$ 

The two components are proportional to the initial probabilities computed in the baseline scenario:

$$ \Delta(\mathrm{MPD} \rightarrow \mathrm{APD}) = \frac{p(\mathrm{MPD} \rightarrow \mathrm{APD})}{p(\mathrm{MPD} \rightarrow \mathrm{APD}) + p(\mathrm{MPD} \rightarrow \mathrm{D})} \ \mathrm{\Delta} $$
$$ \Delta(\mathrm{MPD} \rightarrow \mathrm{D}) = \frac{p(\mathrm{MPD} \rightarrow \mathrm{D})}{p(\mathrm{MPD} \rightarrow \mathrm{APD}) + p(\mathrm{MPD} \rightarrow \mathrm{D})} \ \mathrm{\Delta} $$

Consequently, the new probabilities for the alternative scenario are defined as:

$$ p'(\mathrm{MPD} \rightarrow \mathrm{APD}) = p(\mathrm{MPD} \rightarrow \mathrm{APD}) - \Delta(\mathrm{MPD} \rightarrow \mathrm{APD}) $$

$$ p'(\mathrm{MPD} \rightarrow \mathrm{D}) = p(\mathrm{MPD} \rightarrow \mathrm{D}) - \Delta(\mathrm{MPD} \rightarrow \mathrm{D}) $$ 

In this way, the sum to 1 for the second row of the transition matrices is ensured in the alternative scenario B.

```{r}
# Adjust probability_of_death for 95+ patients
final_data1_alt2 <- final_data_alt_old2 %>%
  group_by(gender) %>%
  mutate(probability_of_death = ifelse(
    age_class == "95et+" & severity == "Prodromal",
    probability_of_death[age_class == "95et+" & severity == "Mild"] -
      (probability_of_death[age_class == "90-94" & severity == "Mild"] -
       probability_of_death[age_class == "90-94" & severity == "Prodromal"]),
    probability_of_death
  ))

age_classes <- c("50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85-89", "90-94", "95et+")
genders <- c("Male", "Female")

# Update f_prob1 with correct probabilities
f_prob12 <- f_prob %>%
  mutate(
    F = case_when(
      `Age class` == "95et+" & Gender == "Male" ~ final_data1_alt2 %>% filter(gender == "Male", age_class == "95et+") %>% pull(probability_of_death) %>% first(),
      `Age class` == "95et+" & Gender == "Female" ~ final_data1_alt2 %>% filter(gender == "Female", age_class == "95et+") %>% pull(probability_of_death) %>% first(),
      TRUE ~ F
    )
  )

# Function to generate transition matrix
generate_transition_matrix_altB <- function(summary_df, summary_df2, final_data1_alt, age_class, gender_name) {
  x <- matrix(NA, nrow = 4, ncol = 4)
  x[1, 1] <- 0

  f_prob1B <- f_prob12 %>%
    filter(`Age class` == age_class & Gender == gender_name) %>%
    pull(F)
   
  x[1, 2] <- 1 - f_prob1B
  x[1, 3] <- 0
  x[1, 4] <- f_prob1B

  x[2, 1] <- 0

  numerator_MPD_APD <- summary_df1 %>%
    filter(CLA_AGE_5 == age_class & gender == gender_name & severity == "Transitioned" & yod_binary == "Alive") %>%
    summarise(n_patients = sum(n_patients)) %>%
    pull(n_patients)

  numerator_MPD_MPD <- summary_df %>%
    filter(CLA_AGE_5 == age_class & gender == gender_name & severity == "Mild" & yod_binary == "Alive") %>%
    summarise(n_patients = sum(n_patients)) %>%
    pull(n_patients)

  numerator_MPD_D <- summary_df %>%
    filter(CLA_AGE_5 == age_class & gender == gender_name & severity %in% c("Mild", "Transitioned") & yod_binary == "Dead") %>%
    summarise(n_patients = sum(n_patients)) %>%
    pull(n_patients)

  denominator_MPD <- summary_df %>%
    filter(CLA_AGE_5 == age_class & gender == gender_name & severity %in% c("Mild", "Transitioned")) %>%
    summarise(n_patients = sum(n_patients)) %>%
    pull(n_patients)
  
     if (length(numerator_MPD_D) > 0 && length(denominator_MPD) > 0 && denominator_MPD != 0) {
    x[2, 4] <- numerator_MPD_D / denominator_MPD
  } else {
    x[2, 4] <- NA
  }

  if (length(numerator_MPD_D) > 0 && length(denominator_MPD) > 0 && denominator_MPD != 0) {
    x[2, 3] <- 1 - (numerator_MPD_D / denominator_MPD) - ((numerator_MPD_MPD / denominator_MPD)^(1/2))
  } else {
    x[2, 3] <- NA
  }

  x[2, 2] <- ifelse(length(numerator_MPD_MPD) > 0 && length(denominator_MPD) > 0 && denominator_MPD != 0, 
                    (numerator_MPD_MPD / denominator_MPD)^(1/2), NA)

  x[3, 1] <- 0
  x[3, 2] <- 0
  numerator_APD_D <- summary_df2 %>%
    filter(CLA_AGE_5 == age_class, gender == gender_name, severity_at_end == "Severe", yod_binary == "Dead") %>%
    summarise(n_patients = sum(n_patients)) %>%
    pull(n_patients)
  
  denominator_APD_D <- summary_df2 %>%
    filter(CLA_AGE_5 == age_class, gender == gender_name, severity_at_end == "Severe") %>%
    summarise(n_patients = sum(n_patients)) %>%
    pull(n_patients)

  if (length(numerator_APD_D) > 0 && length(denominator_APD_D) > 0 && denominator_APD_D != 0) {
    x[3, 4] <- numerator_APD_D / denominator_APD_D
    x[3, 3] <- 1 - x[3, 4]
  } else {
    x[3, 4] <- NA
    x[3, 3] <- NA
  }

  x[4, 1] <- 0
  x[4, 2] <- 0
  x[4, 3] <- 0
  x[4, 4] <- 1

  return(x)
}

transition_matrices_alt1B <- list()

for (gender in genders) {
  for (age_class in age_classes) {
    matrix_name <- paste(gender, age_class, sep = "_")
    transition_matrices_alt1B[[matrix_name]] <- generate_transition_matrix_altB(summary_df, summary_df2, final_data1_alt, age_class, gender)
  }
}

names(transition_matrices_alt1B) <- NULL  

males_alt1B <- transition_matrices_alt1B[1:10]
females_alt1B <- transition_matrices_alt1B[11:20]

matrices_mf_alt1B <- list(males_alt1B, females_alt1B)

for (i in 1:length(males_alt1B)) {
  colnames(males_alt1B[[i]]) <- c("P.m", "MPD.m", "APD.m", "D.m")
  rownames(males_alt1B[[i]]) <- c("P.m", "MPD.m", "APD.m", "D.m")
}
for (i in 1:length(females_alt1B)) {
  colnames(females_alt1B[[i]]) <- c("P.f", "MPD.f", "APD.f", "D.f")
  rownames(females_alt1B[[i]]) <- c("P.f", "MPD.f", "APD.f", "D.f")
}

transition_matrices_m_alt1B <- matrices_mf_alt1B[[1]]
transition_matrices_f_alt1B <- matrices_mf_alt1B[[2]]

extract_rows_as_named_list <- function(matrix) {
  list(
    P = setNames(as.numeric(matrix[1, ]), c("P", "MPD", "APD", "D")),
    MPD = setNames(as.numeric(matrix[2, ]), c("P", "MPD", "APD", "D")),
    APD = setNames(as.numeric(matrix[3, ]), c("P", "MPD", "APD", "D")),
    D = setNames(as.numeric(matrix[4, ]), c("P", "MPD", "APD", "D"))
  )
}

transition_prob_m_alt1B <- lapply(transition_matrices_m_alt1B, extract_rows_as_named_list)
transition_prob_f_alt1B <- lapply(transition_matrices_f_alt1B, extract_rows_as_named_list)

print("Transition Probabilities for Males:")
print(transition_prob_m_alt1B)

print("Transition Probabilities for Females:")
print(transition_prob_f_alt1B)

# Function to calculate delta
calculate_delta <- function(baseline, alt) {
  delta <- alt - baseline
  return(delta)
}

# Function to update transition probabilities based on delta distribution
update_transition_probabilitiesB <- function(transition_prob_m, transition_prob_f, transition_prob_m_alt1B, transition_prob_f_alt1B) {
  for (i in 1:length(transition_prob_m)) {
    # Extract baseline and alternative matrices
    baseline_matrix_m <- transition_prob_m[[i]]$MPD
    alt_matrix_m <- transition_prob_m_alt1B[[i]]$MPD
    baseline_matrix_f <- transition_prob_f[[i]]$MPD
    alt_matrix_f <- transition_prob_f_alt1B[[i]]$MPD
    
    # Baseline and alternative [2,2] elements
    baseline_m_MPD <- baseline_matrix_m["MPD"]
    alt_m_MPD <- alt_matrix_m["MPD"]
    
    baseline_f_MPD <- baseline_matrix_f["MPD"]
    alt_f_MPD <- alt_matrix_f["MPD"]
    
    # Calculate deltas
    delta_m <- calculate_delta(baseline_m_MPD, alt_m_MPD)
    delta_f <- calculate_delta(baseline_f_MPD, alt_f_MPD)
    
    # Calculate baseline probabilities
    p_m_APD <- baseline_matrix_m["APD"]
    p_m_D <- baseline_matrix_m["D"]
    p_f_APD <- baseline_matrix_f["APD"]
    p_f_D <- baseline_matrix_f["D"]
    
    # Calculate delta distribution for males
    sum_m_APD_D <- p_m_APD + p_m_D
    delta_m_APD <- (p_m_APD / sum_m_APD_D) * delta_m
    delta_m_D <- (p_m_D / sum_m_APD_D) * delta_m
    
    # Calculate delta distribution for females
    sum_f_APD_D <- p_f_APD + p_f_D
    delta_f_APD <- (p_f_APD / sum_f_APD_D) * delta_f
    delta_f_D <- (p_f_D / sum_f_APD_D) * delta_f
    
    # Update alternative transition probabilities for males
    transition_prob_m_alt1B[[i]]$MPD["APD"] <- baseline_matrix_m["APD"] - delta_m_APD
    transition_prob_m_alt1B[[i]]$MPD["D"] <- baseline_matrix_m["D"] - delta_m_D
    
    # Update alternative transition probabilities for females
    transition_prob_f_alt1B[[i]]$MPD["APD"] <- baseline_matrix_f["APD"] - delta_f_APD
    transition_prob_f_alt1B[[i]]$MPD["D"] <- baseline_matrix_f["D"] - delta_f_D
  }
  return(list(transition_prob_m_alt1B, transition_prob_f_alt1B))
}

# Call the function to update transition probabilities
updated_transition_probsB <- update_transition_probabilitiesB(transition_prob_m, transition_prob_f, transition_prob_m_alt1B, transition_prob_f_alt1B)
transition_prob_m_altB <- updated_transition_probsB[[1]]
transition_prob_f_altB <- updated_transition_probsB[[2]]

print("Updated Transition Probabilities for Males (Alternative Scenario):")
print(transition_prob_m_altB)

print("Updated Transition Probabilities for Females (Alternative Scenario):")
print(transition_prob_f_altB)

males_altB <- lapply(transition_prob_m_altB, function(prob) {
  matrix(c(prob$P, prob$MPD, prob$APD, prob$D), nrow = 4, byrow = TRUE)
})
females_altB <- lapply(transition_prob_f_altB, function(prob) {
  matrix(c(prob$P, prob$MPD, prob$APD, prob$D), nrow = 4, byrow = TRUE)
})

for (i in 1:length(males_altB)) {
  colnames(males_altB[[i]]) <- c("P.m", "MPD.m", "APD.m", "D.m")
  rownames(males_altB[[i]]) <- c("P.m", "MPD.m", "APD.m", "D.m")
}
for (i in 1:length(females_altB)) {
  colnames(females_altB[[i]]) <- c("P.f", "MPD.f", "APD.f", "D.f")
  rownames(females_altB[[i]]) <- c("P.f", "MPD.f", "APD.f", "D.f")
}

print("Updated Transition Matrices for Males (Alternative Scenario):")
print(males_altB)

print("Updated Transition Matrices for Females (Alternative Scenario):")
print(females_altB)
```

The graph showcasing probabilities of remaining MPD:

```{r}
extract_probabilities2_alt <- function(matrices, age_classes, genders) {
  data <- data.frame()
  
  for (i in 1:length(matrices)) {
    age_class <- age_classes[i]
    matrix <- matrices[[i]]
    
    data <- rbind(data, data.frame(
      age_class = age_class,
      gender = genders,
      severity = severity_labels[2],
      probability_of_remainingMPD = matrix[2, 2]
    ))
    
  }
  
  return(data)
}

males_data_rem_altB <- extract_probabilities2_alt(males_altB, age_classes, "Male")
females_data_rem_altB <- extract_probabilities2_alt(females_altB, age_classes, "Female")

final_data_rem_altB <- rbind(males_data_rem_altB, females_data_rem_altB)

graph_prob_mf_rem_altB <- ggplot(final_data_rem_altB, aes(x = age_class, y = probability_of_remainingMPD, colour = gender, group = gender)) +
  geom_line() +
  geom_point() +
  facet_wrap(~ gender) +
  theme_minimal() +
  labs(title = "Probability of remaining MPD with respect to gender and age classes, alternative scenario",
       x = "Age class",
       y = "Probability") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), plot.title = element_text(size = 10))
graph_prob_mf_rem_altB
```


The graph showcasing probabilities of transitioning from MPD to APD is:

```{r}
extract_probabilities1 <- function(matrices, age_classes, genders) {
  data <- data.frame()
  
  for (i in 1:length(matrices)) {
    age_class <- age_classes[i]
    matrix <- matrices[[i]]
    
    data <- rbind(data, data.frame(
      age_class = age_class,
      gender = genders,
      severity = severity_labels[2],
      probability_of_transitioning = matrix[2, 3]
    ))
    
  }
  
  return(data)
}

males_data_tra_altB <- extract_probabilities1(males_altB, age_classes, "Male")
females_data_tra_altB <- extract_probabilities1(females_altB, age_classes, "Female")

final_data_tra_altB <- rbind(males_data_tra_altB, females_data_tra_altB)

graph_prob_mf_tra_altB <- ggplot(final_data_tra_altB, aes(x = age_class, y = probability_of_transitioning, colour = gender, group = gender)) +
  geom_line() +
  geom_point() +
  facet_wrap(~ gender) +
  theme_minimal() +
  labs(title = "Probability of transitioning from MPD to APD with respect to gender and age classes, alternative scenario",
       x = "Age class",
       y = "Probability") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), plot.title = element_text(size = 10))
graph_prob_mf_tra_altB
```

Comparison across scenarios (probability of remaining MPD):

```{r}
extract_probabilities_comb1 <- function(matrices, age_classes, genders, scenario) {
  data <- data.frame()
  
  for (i in 1:length(matrices)) {
    age_class <- age_classes[i]
    matrix <- matrices[[i]]
    
    data <- rbind(data, data.frame(
      age_class = age_class,
      gender = genders,
      severity = severity_labels[2],
      probability_of_remainingMPD = matrix[2, 2],
      scenario = scenario
    ))
    
  }
  
  return(data)
}

# Extract data for baseline scenario
males_data_rem_comb <- extract_probabilities_comb1(males, age_classes, "Male", "Baseline")
females_data_rem_comb <- extract_probabilities_comb1(females, age_classes, "Female", "Baseline")

# Extract data for alternative scenario
males_data_rem_alt_combB <- extract_probabilities_comb1(males_altB, age_classes, "Male", "Alternative B")
females_data_rem_alt_combB <- extract_probabilities_comb1(females_altB, age_classes, "Female", "Alternative B")

# Combine all data
final_data_rem_combB <- rbind(males_data_rem_comb, females_data_rem_comb, males_data_rem_alt_combB, females_data_rem_alt_combB)

# Create the combined graph
graph_prob_mf_rem_combinedB <- ggplot(final_data_rem_combB, aes(x = age_class, y = probability_of_remainingMPD, colour = scenario, group = scenario)) +
  geom_line() +
  geom_point() +
  facet_wrap(~ gender) +
  theme_minimal() +
  labs(title = "Probability of remaining MPD: comparison across scenarios",
       x = "Age class",
       y = "Probability",
       colour = "Scenario") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), plot.title = element_text(size = 10))

graph_prob_mf_rem_combinedB
```

Comparison across scenarios (probability of transitioning from MPD to APD):

```{r}
extract_probabilities_comb2 <- function(matrices, age_classes, genders, scenario) {
  data <- data.frame()
  
  for (i in 1:length(matrices)) {
    age_class <- age_classes[i]
    matrix <- matrices[[i]]
    
    data <- rbind(data, data.frame(
      age_class = age_class,
      gender = genders,
      severity = severity_labels[2],
      probability_of_transitioning = matrix[2, 3],
      scenario = scenario
    ))
    
  }
  
  return(data)
}

# Extract data for baseline scenario
males_data_tra_comb <- extract_probabilities_comb2(males, age_classes, "Male", "Baseline")
females_data_tra_comb <- extract_probabilities_comb2(females, age_classes, "Female", "Baseline")

# Extract data for alternative scenario
males_data_tra_alt_combB <- extract_probabilities_comb2(males_altB, age_classes, "Male", "Alternative B")
females_data_tra_alt_combB <- extract_probabilities_comb2(females_altB, age_classes, "Female", "Alternative B")

# Combine all data
final_data_tra_combB <- rbind(males_data_tra_comb, females_data_tra_comb, males_data_tra_alt_combB, females_data_tra_alt_combB)

# Create the combined graph
graph_prob_mf_tra_combinedB <- ggplot(final_data_tra_combB, aes(x = age_class, y = probability_of_transitioning, colour = scenario, group = scenario)) +
  geom_line() +
  geom_point() +
  facet_wrap(~ gender) +
  theme_minimal() +
  labs(title = "Probability of transitioning from MPD to APD: comparison across scenarios",
       x = "Age class",
       y = "Probability",
       colour = "Scenario") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), plot.title = element_text(size = 10))

graph_prob_mf_tra_combinedB
```

Comparison across scenarios (probability of dying when MPD):

```{r}
extract_probabilities_comb3 <- function(matrices, age_classes, genders, scenario) {
  data <- data.frame()
  
  for (i in 1:length(matrices)) {
    age_class <- age_classes[i]
    matrix <- matrices[[i]]
    
    data <- rbind(data, data.frame(
      age_class = age_class,
      gender = genders,
      severity = severity_labels[2],
      probability_of_dyingMPD = matrix[2, 4],
      scenario = scenario
    ))
    
  }
  
  return(data)
}

# Extract data for baseline scenario
males_data_die_comb <- extract_probabilities_comb3(males, age_classes, "Male", "Baseline")
females_data_die_comb <- extract_probabilities_comb3(females, age_classes, "Female", "Baseline")

# Extract data for alternative scenario
males_data_die_alt_combB <- extract_probabilities_comb3(males_altB, age_classes, "Male", "Alternative B")
females_data_die_alt_combB <- extract_probabilities_comb3(females_altB, age_classes, "Female", "Alternative B")

# Combine all data
final_data_die_combB <- rbind(males_data_die_comb, females_data_die_comb, males_data_die_alt_combB, females_data_die_alt_combB)

# Create the combined graph
graph_prob_mf_die_combinedB <- ggplot(final_data_die_combB, aes(x = age_class, y = probability_of_dyingMPD, colour = scenario, group = scenario)) +
  geom_line() +
  geom_point() +
  facet_wrap(~ gender) +
  theme_minimal() +
  labs(title = "Probability of dying when MPD: comparison across scenarios",
       x = "Age class",
       y = "Probability",
       colour = "Scenario") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), plot.title = element_text(size = 10))

graph_prob_mf_die_combinedB
```


The new version of the microsimulation model is to be initialized:

```{r}
n.i <- 26000 #number of newly diagnosed PD patients in 2020, according to the French public health agency. This institution also claims that PD is approximately 1.5 times more frequent in men than women
n_males <- n.i * 0.6
n_females <- n.i * 0.4
n.t <- 15 #number of cycles of the model: starting from 2020, 2 5-year cycles are necessary to reach 2030
n.sim <- 100 #number of simulations. The higher the number of simulations, the more precise the results of the model, but the processing power at hand should be taken into account when setting this number.
v.n <- c("P", "MPD", "APD", "D") # model states
n.s <- length(v.n) # number of health states
v.M_1_males <- rep("P", n_males) #everyone begins in the prodromal stage
v.M_1_females <- rep("P", n_females) #everyone begins in the prodromal stage
d.c.1 <- ((1+0.025)^5) - 1 # 5-year discount rate for costs, assuming a annual discount rate of 2.5% for the 2020-2070 period
d.c.2 <- ((1+0.015)^5) - 1 # 5-year discount rate for costs, assuming a annual discount rate of 1.5% for the 2070-2095 period
```

Costs in alternative scenarios are:

```{r, warning=FALSE, message=FALSE}
#Males
lambda <- 0.5
transition_costs_m_alt <- list()
for (cycle in 1:10) {
  c.P.m <- costs_model_males[[cycle, "cp"]] + (lambda*(2/5)*costs_model_males[[cycle, "c"]])
  c.MPD.m <- costs_model_males[[cycle, "c"]]
  c.APD.m <- costs_model_males[[cycle, "C"]]
  c.D.m <- costs_model_males[[cycle, "D"]]
  transition_costs_m_alt[[cycle]] <- list(
    "P" = c(c.P.m),
    "MPD" = c(c.MPD.m),
    "APD" = c(c.APD.m),
    "D" = c(c.D.m)
  )
  
}

#Costs are repeated for 95+
last_transition_m_alt <- transition_costs_m_alt[[10]]
for (i in 11:n.t) {
  transition_costs_m_alt[[i]] <- last_transition_m_alt
}
print(transition_costs_m_alt)

#Females
transition_costs_f_alt <- list()
for (cycle in 1:10) {
  c.P.f <- costs_model_females[[cycle, "cp"]] + (lambda*(2/5)*costs_model_females[[cycle, "c"]])
  c.MPD.f <- costs_model_females[[cycle, "c"]]
  c.APD.f <- costs_model_females[[cycle, "C"]]
  c.D.f <- costs_model_females[[cycle, "D"]]
  transition_costs_f_alt[[cycle]] <- list(
    "P" = c(c.P.f),
    "MPD" = c(c.MPD.f),
    "APD" = c(c.APD.f),
    "D" = c(c.D.f)
  )
  
}

#Costs are repeated for 95+
last_transition_f_alt <- transition_costs_f_alt[[10]]
for (i in 11:n.t) {
  transition_costs_f_alt[[i]] <- last_transition_f_alt
}

print(transition_costs_f_alt)
```

The microsimulation function for male patients is:

```{r}
m.M <- m.C <-  matrix(nrow = n_males,
                      ncol = n.t + 1,
                      dimnames = list(paste("ind", 1:n_males, sep = " "), paste("cycle", 0:n.t, sep = " "))) 
m.M[, 1] <- v.M_1_males
```

```{r, warning=FALSE, message=FALSE}
#Males
Probs <- function(state){
  return(transition_prob_m_alt[[state]])
}
Costs <- function(state) {
  return(transition_costs_m[[state]])
}

# Testing 
set.seed(1) #deterministic sequence of random numbers

transition_prob_m_altB <- transition_prob_m_altB %>% 
  map(~ map(.x, ~ sort(.x, decreasing = TRUE)))
loop_microsim_altB <- function(n.t) {
     for (t in 1:n.t) {
      m.p <- m.M_altB[, t]
# calculate the transition probabilities at cycle t
     #state <- list("P", "MPD", "APD","D")
      for (i in 1:length(m.p)) {
        current_state <- m.p[i]
        new_state <- m.p[i]
         if (t > 10) {
           new_state <- sample(names(transition_prob_m_altB[[10]][[current_state]]), 1, prob = transition_prob_m_altB[[10]][[current_state]])
         } else {
           new_state <- sample(names(transition_prob_m_altB[[t]][[current_state]]), 1, prob = transition_prob_m_altB[[t]][[current_state]])
         }
        m.M_altB[i, t + 1] <- new_state
        #m.C[i, t + 1] <- Costs(current_state)
      }   
    } # close the loop for the time points
  return(m.M_altB)
}

# Init m.M #repeat it!!!!
model_results_m_altB <- list()
for(i in 1:n.sim) {
m.M_altB <- m.C_altB <-  matrix(nrow = n_males,
                      ncol = n.t + 1,
                      dimnames = list(paste("ind", 1:n_males, sep = " "), paste("cycle", 0:n.t, sep = " "))) 
m.M_altB[, 1] <- v.M_1_males
# Microsim loop
model_results_m_altB[[i]] <- loop_microsim_altB(n.t)
print(i)
} 
# repeat it!!!


#Results of the median simulation, the 50th
model_results_m_altB[[50]][1:300, ]
df_m.M_altB <- model_results_m_altB[[50]] %>% as.tibble()
library(janitor)
map(
  c("cycle 0", "cycle 1", "cycle 2", "cycle 3", "cycle 4", "cycle 5",
    "cycle 6", "cycle 7", "cycle 8", "cycle 9", "cycle 10", "cycle 11", "cycle 12", "cycle 13", "cycle 14"),
  ~ df_m.M_altB %>% tabyl(!!sym(.x))
)

# Transition costs in a dataframe
transition_costs_m_alt <-
 transition_costs_m_alt %>% 
  data.table::rbindlist() %>% 
  t() %>% 
  as_tibble(rownames = "Stage") %>% 
  rename_with(~ c("Stage", "cycle 0", "cycle 1", "cycle 2", "cycle 3", "cycle 4",
   "cycle 5", "cycle 6", "cycle 7", "cycle 8", "cycle 9", "cycle 10", "cycle 11", "cycle 12", "cycle 13", "cycle 14")) %>% 
  pivot_longer(cols = -Stage, names_to = "cycle", values_to = "cost")


final_cost_m_altB <-
  map(
    model_results_m_altB,
    ~ .x %>% 
      as_tibble() %>% 
      mutate(id = row_number()) %>% 
      pivot_longer(cols = -id, names_to = "cycle", values_to = "Stage") %>% 
      left_join(
        transition_costs_m_alt
      )
  )
  

final_cost_m2_altB <-
  map(
    final_cost_m_altB,
    ~ .x %>% 
      group_by(cycle) %>% 
      summarise(
      n = n(),
      sum_costs = sum(cost, na.rm = TRUE)
    ) %>% 
    mutate(cycle = as_factor (cycle) %>%  fct_relevel(c("cycle 0", "cycle 1", "cycle 2", "cycle 3", "cycle 4", "cycle 5", "cycle 6", "cycle 7", "cycle 8", "cycle 9", "cycle 10", "cycle 11", "cycle 12", "cycle 13", "cycle 14"))) %>%  arrange(cycle) %>% 
     filter(cycle != "cycle 15")
  )
final_cost_m2_altB
```

```{r}
m.M <- m.C <-  matrix(nrow = n_females,
                      ncol = n.t + 1,
                      dimnames = list(paste("ind", 1:n_females, sep = " "), paste("cycle", 0:n.t, sep = " "))) 
m.M[, 1] <- v.M_1_females
```


The same reasoning is applied to female patients:

```{r, warning=FALSE, message=FALSE}
#Females
Probs <- function(state){
  return(transition_prob_f_alt[[state]])
}
Costs <- function(state) {
  return(transition_costs_f[[state]])
}
# Testing 
set.seed(1) #deterministic sequence of random numbers

transition_prob_f_altB <- transition_prob_f_altB %>% 
  map(~ map(.x, ~ sort(.x, decreasing = TRUE)))
loop_microsim_altB <- function(n.t) {
     for (t in 1:n.t) {
      m.p <- m.M_altB[, t]
# calculate the transition probabilities at cycle t
     #state <- list("P", "MPD", "APD","D")
      for (i in 1:length(m.p)) {
        current_state <- m.p[i]
        new_state <- m.p[i]
         if (t > 10) {
           new_state <- sample(names(transition_prob_f_altB[[10]][[current_state]]), 1, prob = transition_prob_f_altB[[10]][[current_state]])
         } else {
           new_state <- sample(names(transition_prob_f_altB[[t]][[current_state]]), 1, prob = transition_prob_f_altB[[t]][[current_state]])
         }
        m.M_altB[i, t + 1] <- new_state
        #m.C[i, t + 1] <- Costs(current_state)
      }   
    } # close the loop for the time points
  return(m.M_altB)
}

# Init m.M #repeat it!!!!
model_results_f_altB <- list()
for(i in 1:n.sim) {
m.M_altB <- m.C_altB <-  matrix(nrow = n_females,
                      ncol = n.t + 1,
                      dimnames = list(paste("ind", 1:n_females, sep = " "), paste("cycle", 0:n.t, sep = " "))) 
m.M_altB[, 1] <- v.M_1_females
# Microsim loop
model_results_f_altB[[i]] <- loop_microsim_altB(n.t)
print(i)
}  
# repeat it!!!

#Results of the median simulation, the 50th
model_results_f_altB[[50]][1:300, ]
df_m.M_altB <- model_results_f_altB[[50]] %>% as.tibble()
library(janitor)
map(
  c("cycle 0", "cycle 1", "cycle 2", "cycle 3", "cycle 4", "cycle 5",
    "cycle 6", "cycle 7", "cycle 8", "cycle 9", "cycle 10", "cycle 11", "cycle 12", "cycle 13", "cycle 14"),
  ~ df_m.M_altB %>% tabyl(!!sym(.x))
)

#Transition costs
transition_costs_f_alt <-
  transition_costs_f_alt %>% 
  data.table::rbindlist() %>% 
  t() %>% 
  as_tibble(rownames = "Stage") %>% 
  rename_with(~ c("Stage", "cycle 0", "cycle 1", "cycle 2", "cycle 3", "cycle 4",
    "cycle 5", "cycle 6", "cycle 7", "cycle 8", "cycle 9", "cycle 10", "cycle 11", "cycle 12", "cycle 13", "cycle 14")) %>% 
  pivot_longer(cols = -Stage, names_to = "cycle", values_to = "cost")

final_cost_f_altB <- map(
    model_results_f_altB,
    ~ .x %>% 
      as_tibble() %>% 
      mutate(id = row_number()) %>% 
      pivot_longer(cols = -id, names_to = "cycle", values_to = "Stage") %>% 
      left_join(
        transition_costs_f_alt
      )
  )
 

final_cost_f2_altB <-
  map(
    final_cost_f_altB,
    ~ .x %>% 
      group_by(cycle) %>% 
      summarise(
      n = n(),
      sum_costs = sum(cost, na.rm = TRUE)
    ) %>% 
    mutate(cycle = as_factor (cycle) %>%  fct_relevel(c("cycle 0", "cycle 1", "cycle 2", "cycle 3", "cycle 4", "cycle 5", "cycle 6", "cycle 7", "cycle 8", "cycle 9", "cycle 10", "cycle 11", "cycle 12", "cycle 13", "cycle 14"))) %>%  arrange(cycle) %>% 
    filter(cycle != "cycle 15")
  )
final_cost_f2_altB
```

The variability of costs over 30 simulations is observed through a box plot:

```{r}
#Males
final_cost_m2_alt_combinedB <- bind_rows(final_cost_m2_altB)

final_cost_m2_alt_combinedB$cycle <- factor(final_cost_m2_alt_combinedB$cycle, 
                                           levels = c("cycle 0", "cycle 1", "cycle 2", "cycle 3", "cycle 4", 
                                                      "cycle 5", "cycle 6", "cycle 7", "cycle 8", "cycle 9", "cycle 10", "cycle 11", "cycle 12", "cycle 13", "cycle 14"))

var_graph_m_altB <- ggplot(final_cost_m2_alt_combinedB, aes(x = cycle, y = sum_costs)) +
  geom_boxplot(width = 0.9) +  
  labs(title = "Box Plot of Total Costs per Cycle, Alternative Scenario (Males)",
       x = "Cycle",
       y = "Variability") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
var_graph_m_altB

#Females
final_cost_f2_alt_combinedB <- bind_rows(final_cost_f2_altB)

final_cost_f2_alt_combinedB$cycle <- factor(final_cost_f2_alt_combinedB$cycle, 
                                           levels = c("cycle 0", "cycle 1", "cycle 2", "cycle 3", "cycle 4", 
                                                      "cycle 5", "cycle 6", "cycle 7", "cycle 8", "cycle 9", "cycle 10", "cycle 11", "cycle 12", "cycle 13", "cycle 14"))

var_graph_f_altB <- ggplot(final_cost_f2_alt_combinedB, aes(x = cycle, y = sum_costs)) +
  geom_boxplot(width = 0.9) +  
  labs(title = "Box Plot of Total Costs per Cycle, Alternative Scenario (Females)",
       x = "Cycle",
       y = "Variability") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
var_graph_f_altB
```


The graphs showcasing costs over cycles are:

```{r}
#Averaging costs across simulations
#Males
combined_costs_m_altB <- map_df(final_cost_m2_altB, ~ .x)
mean_costs_per_cycle_m_altB <- combined_costs_m_altB %>%
  group_by(cycle) %>%
  summarise(avg_tot_costs = mean(sum_costs, na.rm = TRUE)) %>%
  mutate(cycle = as_factor(cycle) %>% fct_relevel(c("cycle 0", "cycle 1", "cycle 2", "cycle 3", "cycle 4", "cycle 5", "cycle 6", "cycle 7", "cycle 8", "cycle 9", "cycle 10", "cycle 11", "cycle 12", "cycle 13", "cycle 14"))) %>%
  arrange(cycle)
print(mean_costs_per_cycle_m_altB)
#Females
combined_costs_f_altB <- map_df(final_cost_f2_altB, ~ .x)
mean_costs_per_cycle_f_altB <- combined_costs_f_altB %>%
  group_by(cycle) %>%
  summarise(avg_tot_costs = mean(sum_costs, na.rm = TRUE)) %>%
  mutate(cycle = as_factor(cycle) %>% fct_relevel(c("cycle 0", "cycle 1", "cycle 2", "cycle 3", "cycle 4", "cycle 5", "cycle 6", "cycle 7", "cycle 8", "cycle 9", "cycle 10", "cycle 11", "cycle 12", "cycle 13", "cycle 14"))) %>%
  arrange(cycle)
print(mean_costs_per_cycle_f_altB)

#Graphs
#Males
graph1_altB <- ggplot(data = mean_costs_per_cycle_m_altB %>% mutate(Year = c("2020-25", "2025-30", "2030-35", "2035-40", "2040-45", "2045-50", "2050-55", "2055-60", "2060-65", "2065-70", "2070-75", "2075-80", "2080-85", "2085-90", "2090-95")), aes(x = Year, y = avg_tot_costs))+
  geom_col(fill = "turquoise") +
  ggtitle("Average total costs from microsimulation, alternative scenario B (Males)") +
  xlab("Year") +
  ylab("Cost") +
  theme_minimal() +
  scale_y_continuous(labels = scales::comma, limits = c(0, max(mean_costs_per_cycle_m_alt$avg_tot_costs) * 1)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8))
  options(scipen=999)
  
#Females
graph2_altB <- ggplot(data = mean_costs_per_cycle_f_altB %>% mutate(Year = c("2020-25", "2025-30", "2030-35", "2035-40", "2040-45", "2045-50", "2050-55", "2055-60", "2060-65", "2065-70", "2070-75", "2075-80", "2080-85", "2085-90", "2090-95")), aes(x = Year, y = avg_tot_costs))+
  geom_col(fill = "pink") +
  ggtitle("Average total costs from microsimulation, alternative scenario B (Females)") +
  xlab("Year") +
  ylab("Cost") +
  theme_minimal() +
  scale_y_continuous(labels = scales::comma, limits = c(0, max(mean_costs_per_cycle_f_alt$avg_tot_costs) * 1)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8))
  options(scipen=999)

graph1_altB
graph2_altB
```

Let's compare graphs across scenarios:

```{r}
#Males
mean_costs_combined_mB <- mean_costs_per_cycle_m %>%
  rename(avg_tot_costs_baseline = avg_tot_costs) %>%
  inner_join(mean_costs_per_cycle_m_altB %>%
               rename(avg_tot_costs_alt = avg_tot_costs),
             by = "cycle") %>%
  mutate(extra_cost = avg_tot_costs_baseline - avg_tot_costs_alt) %>% 
  pivot_longer(cols = c(avg_tot_costs_baseline, avg_tot_costs_alt, extra_cost),
               names_to = "Scenario", values_to = "avg_tot_costs") %>%
  mutate(Scenario = recode(Scenario, "avg_tot_costs_baseline" = "Baseline", "avg_tot_costs_alt" = "Alternative B", "extra_cost" = "Extra cost of baseline")) %>% 
  filter(Scenario != "Baseline") %>% 
  mutate(
    Scenario = as_factor(Scenario) %>% fct_relevel("Extra cost of baseline")
  )

graph_combined_mB <- ggplot(data = mean_costs_combined_mB, aes(x = cycle, y = avg_tot_costs, fill = "Gains/losses")) +
  geom_col(data = subset(mean_costs_combined_mB, Scenario == "Alternative B"), fill = "blue", width = 0.4) +
  geom_col(data = subset(mean_costs_combined_mB, Scenario == "Extra cost of baseline"),
           aes(fill = ifelse(avg_tot_costs < 0, "Loss", "Gain")), 
           width = 0.4) +
  scale_fill_manual(name = "Gains/losses", values = c("Alternative B" = "blue", "Loss" = "red", "Gain" = "green")) +
  ggtitle("Comparison of average total costs of alternative scenario B wrt baseline scenario (Males)") +
  xlab("Cycle") +
  ylab("Cost") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 7), plot.title = element_text(size = 10)) +
  scale_y_continuous(labels = scales::comma, limits = c(min(mean_costs_combined_m$avg_tot_costs), max(mean_costs_combined_m$avg_tot_costs)))
graph_combined_mB

#Females
mean_costs_combined_fB <- mean_costs_per_cycle_f %>%
  rename(avg_tot_costs_baseline = avg_tot_costs) %>%
  inner_join(mean_costs_per_cycle_f_altB %>%
               rename(avg_tot_costs_alt = avg_tot_costs),
             by = "cycle") %>%
  mutate(extra_cost = avg_tot_costs_baseline - avg_tot_costs_alt) %>% 
  pivot_longer(cols = c(avg_tot_costs_baseline, avg_tot_costs_alt, extra_cost),
               names_to = "Scenario", values_to = "avg_tot_costs") %>%
  mutate(Scenario = recode(Scenario, "avg_tot_costs_baseline" = "Baseline", "avg_tot_costs_alt" = "Alternative B", "extra_cost" = "Extra cost of baseline")) %>% 
  filter(Scenario != "Baseline") %>% 
  mutate(
    Scenario = as_factor(Scenario) %>% fct_relevel("Extra cost of baseline")
  )

graph_combined_fB <- ggplot(data = mean_costs_combined_fB, aes(x = cycle, y = avg_tot_costs, fill = "Gains/losses")) +
  geom_col(data = subset(mean_costs_combined_fB, Scenario == "Alternative B"), fill = "pink", width = 0.4) +
  geom_col(data = subset(mean_costs_combined_fB, Scenario == "Extra cost of baseline"),
           aes(fill = ifelse(avg_tot_costs < 0, "Loss", "Gain")), 
           width = 0.4) +
  scale_fill_manual(name = "Gains/losses", values = c("Alternative B" = "pink", "Loss" = "red", "Gain" = "green")) +
  ggtitle("Comparison of average total costs of alternative scenario B wrt baseline scenario (Females)") +
  xlab("Cycle") +
  ylab("Cost") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 7), plot.title = element_text(size = 10)) +
  scale_y_continuous(labels = scales::comma, limits = c(min(mean_costs_combined_f$avg_tot_costs), max(mean_costs_combined_f$avg_tot_costs)))
graph_combined_fB
```

Discounted costs are:

```{r}
discounted_costs_m_altB <-
  map(final_cost_m2_altB, 
  ~ .x %>%  
   mutate(
    dw = ifelse(row_number() <= 10, 
                (1)/((1+d.c.1)^(row_number()-1)), 
                (1)/((1+d.c.2)^(row_number()-1))), #vector of discount weights
    discounted_costs = sum_costs * dw )%>% #the column "discounted_costs" represents the vector of discounted costs  
  select(cycle, n, discounted_costs) 
  )
discounted_costs_m_altB

# Females
discounted_costs_f_altB <-
  map(final_cost_f2_altB, 
  ~ .x %>%  
   mutate(
    dw = ifelse(row_number() <= 10, 
                (1)/((1+d.c.1)^(row_number()-1)), 
                (1)/((1+d.c.2)^(row_number()-1))), #vector of discount weights
    discounted_costs = sum_costs * dw )%>% #the column "discounted_costs" represents the vector of discounted costs  
  select(cycle, n, discounted_costs) 
  )
discounted_costs_f_altB

```

The Total Discounted Cost of PD patients for n.t = 15 (cycles) is:

```{r}
#Males
tot_discounted_costs_m_altB <- list()
for(i in 1:n.sim) {
tot_discounted_cost <- sum(discounted_costs_m_altB[[i]]$discounted_costs) 
tot_discounted_costs_m_altB[[i]] <- list(
  "tot_discounted_costs" = c(tot_discounted_cost)
)
}
print(tot_discounted_costs_m_altB)
#Females
tot_discounted_costs_f_altB <- list()
for(i in 1:n.sim) {
tot_discounted_cost <- sum(discounted_costs_f_altB[[i]]$discounted_costs) 
tot_discounted_costs_f_altB[[i]] <- list(
  "tot_discounted_costs" = c(tot_discounted_cost)
)
}
print(tot_discounted_costs_f_altB)
#Averaging total costs across simulations
TDC_m_alternativeB <- mean(unlist(tot_discounted_costs_m_altB))
TDC_f_alternativeB <- mean(unlist(tot_discounted_costs_f_altB))
#Final result
TDC_alternativeB <- TDC_m_alternativeB + TDC_f_alternativeB
TDC_alternativeB
```

The total amount of money that can be saved thanks to early detection is:

```{r}
total_savingsB <- TDC_baseline - TDC_alternativeB
total_savingsB
```

The following is a useful graph to evaluate the trends of P, MPD, APD and D patients over the microsimulation time period:

```{r}
prepare_plot_data <- function(df_m, scenario) {
  df_m %>%
    as_tibble() %>%
    pivot_longer(cols = starts_with("cycle"), names_to = "cycle", values_to = "state") %>%
    count(cycle, state) %>%
    group_by(cycle) %>%
    mutate(percent = n / sum(n)) %>%
    ungroup() %>%
    mutate(scenario = scenario)
}


num_cols_m <- ncol(model_results_m[[50]])
num_cols_m_altB <- ncol(model_results_m_altB[[50]])

colnames(model_results_m[[50]]) <- paste("cycle", 0:(num_cols_m-1), sep = " ")
colnames(model_results_m_altB[[50]]) <- paste("cycle", 0:(num_cols_m_altB-1), sep = " ")


# Baseline
df_m.M <- model_results_m[[50]] %>% prepare_plot_data("Baseline")

# Alternative
df_m.M_altB <- model_results_m_altB[[50]] %>% prepare_plot_data("Alternative")

# Combining
combined_data_mB <- bind_rows(df_m.M, df_m.M_altB)

combined_data1B <- combined_data_mB %>% mutate(cycle = factor(cycle, levels = c("cycle 0", "cycle 1", "cycle 2", "cycle 3", "cycle 4", "cycle 5", "cycle 6", "cycle 7", "cycle 8", "cycle 9", "cycle 10", "cycle 11", "cycle 12", "cycle 13", "cycle 14"))) %>% 
filter(cycle != "cycle 15")

# Plot 
summary_plot_maleB <- ggplot(combined_data1B %>% mutate(statescenario = paste(state, scenario)), aes(x = cycle, y = percent, color = state, linetype = scenario, group = statescenario)) +
  geom_line() +
  labs(title = "Comparison of states across cycles and scenarios (Males)",
       x = "Cycle",
       y = "Percentage") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
summary_plot_maleB
```

The graph for females: 

```{r}
prepare_plot_data <- function(df_m, scenario) {
  df_m %>%
    as_tibble() %>%
    pivot_longer(cols = starts_with("cycle"), names_to = "cycle", values_to = "state") %>%
    count(cycle, state) %>%
    group_by(cycle) %>%
    mutate(percent = n / sum(n)) %>%
    ungroup() %>%
    mutate(scenario = scenario)
}


num_cols_f <- ncol(model_results_f[[50]])
num_cols_f_altB <- ncol(model_results_f_altB[[50]])

colnames(model_results_f[[50]]) <- paste("cycle", 0:(num_cols_f-1), sep = " ")
colnames(model_results_f_altB[[50]]) <- paste("cycle", 0:(num_cols_f_altB-1), sep = " ")


# Baseline
df_m.M <- model_results_f[[50]] %>% prepare_plot_data("Baseline")

# Alternative
df_m.M_altB <- model_results_f_altB[[50]] %>% prepare_plot_data("Alternative")

# Combining
combined_data_fB <- bind_rows(df_m.M, df_m.M_altB)

combined_data2B <- combined_data_fB %>% mutate(cycle = factor(cycle, levels = c("cycle 0", "cycle 1", "cycle 2", "cycle 3", "cycle 4", "cycle 5", "cycle 6", "cycle 7", "cycle 8", "cycle 9", "cycle 10", "cycle 11", "cycle 12", "cycle 13", "cycle 14"))) %>% 
filter(cycle != "cycle 15")

# Plot 
summary_plot_femaleB <- ggplot(combined_data2B %>% mutate(statescenario = paste(state, scenario)), aes(x = cycle, y = percent, color = state, linetype = scenario, group = statescenario)) +
  geom_line() +
  labs(title = "Comparison of states across cycles and scenarios (Females)",
       x = "Cycle",
       y = "Percentage") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
summary_plot_femaleB
```

Losses are really prominent from a financial point of view, as indicated by the final result and by the graph comparing costs across scenarios:

* a higher average number of MPD patients means higher medical costs

* a lower average number of deceased patients, again, results in higher medical costs

* only the lower average number of APD patients represents a financial gain

However, if the point of view of patients is considered, the previous remarks represent a gain both in terms of life quality and life expectancy.

Let's evaluate this gain:

```{r}
process_model_result <- function(model_result) {
  df <- model_result %>% as_tibble()
  cycle_columns <- paste0("cycle ", 0:14)
  map(cycle_columns, ~ df %>% tabyl(!!sym(.x)))
}

# Males
percent_tables_m <- map(model_results_m[1:100], process_model_result)

# Females
percent_tables_f <- map(model_results_f[1:100], process_model_result)

# Aggregate results and compute the averages
aggregate_results <- function(percent_tables) {
  all_states <- c("P", "MPD", "APD", "D")
  cycle_columns <- paste0("cycle ", 0:14)
  
  aggregated <- map(cycle_columns, function(cycle) {
    state_sums <- map_dbl(all_states, function(state) {
      state_n_values <- map_dbl(percent_tables, ~ {
        tabyl_result <- .x[[which(cycle_columns == cycle)]]
        if (state %in% tabyl_result[[1]]) {
          return(tabyl_result$n[tabyl_result[[1]] == state])
        } else {
          return(0)
        }
      })
      mean(state_n_values)
    })
    tibble(state = all_states, mean_n = state_sums)
  })
  
  bind_rows(aggregated, .id = "cycle") %>%
    mutate(cycle = as.numeric(cycle) - 1) # Aggiustare i cicli da 0 a 14
}

# Aggregate for males
aggregated_m <- aggregate_results(percent_tables_m)

# Aggregate for females
aggregated_f <- aggregate_results(percent_tables_f)

aggregated_m
aggregated_f


#Same approach for the alternative scenario

percent_tables_m_altB <- map(model_results_m_altB[1:100], process_model_result)
percent_tables_f_altB <- map(model_results_f_altB[1:100], process_model_result)

# Aggregate for males
aggregated_m_altB <- aggregate_results(percent_tables_m_altB)

# Aggregate for females
aggregated_f_altB <- aggregate_results(percent_tables_f_altB)

aggregated_m_altB
aggregated_f_altB
```

With the new tables at hand it is possible to compute the 3 differences that indicate a gain for patients:

* the alternative scenario has more MPD patients, which means that there are more patients spending time in the MPD state. This state is characterized by decent life conditions if compared to the severe stage.

* the alternative scenario has less APD patients, which means that there are less patients spending time in the severe stage of the disease, characterized by severe symptoms that heavily impact life quality.

* the alternative scenario has less deceased patients, which means that, generally speaking, patients lead a longer life.

```{r}
library(dplyr)

calculate_differences <- function(baseline, alternativeB) {
  baseline %>%
    inner_join(alternativeB, by = c("cycle", "state"), suffix = c("_baseline", "_altB")) %>%
    mutate(
      difference = case_when(
        state == "MPD" ~ mean_n_altB - mean_n_baseline,
        state == "APD" ~ mean_n_baseline - mean_n_altB,
        state == "D" ~ mean_n_baseline - mean_n_altB,
        TRUE ~ NA_real_
      )
    ) %>%
    select(cycle, state, difference) %>%
    filter(!is.na(difference))
}

differences_mB <- calculate_differences(aggregated_m, aggregated_m_altB)
differences_fB <- calculate_differences(aggregated_f, aggregated_f_altB)

differences_mB
differences_fB
```

Differences are aggregated with respect to cycles, truncated, since patients have to be counted with integer numbers, and multiplied by 5, since each cycle lasts 5 years.

```{r}
#Males
summary_mB <- differences_mB %>% 
    group_by(state) %>%
    summarise(
      diff_sum = sum(difference, na.rm = TRUE)
    ) %>%
    mutate(
      diff_sum = floor(diff_sum) * 5
    ) %>%
    select(state, diff_sum)
summary_mB

#Females
summary_fB <- differences_fB %>% 
    group_by(state) %>%
    summarise(
      diff_sum = sum(difference, na.rm = TRUE)
    ) %>%
    mutate(
      diff_sum = floor(diff_sum) * 5
    ) %>%
    select(state, diff_sum)
summary_fB

```

The previous are the total numbers of years:

* additionally spent in MPD

* less spent in APD

* additionally spent in life

The results with respect to the average male or female patient require the previous results to be divided by the total number of male and females patients:

```{r}
averages_mB <- summary_mB %>%
    mutate(
      diff_sum = (diff_sum)/(n_males)
    ) %>%
    select(state, diff_sum)

averages_fB <- summary_fB %>%
    mutate(
      diff_sum = (diff_sum)/(n_females)
    ) %>%
    select(state, diff_sum)

averages_mB
averages_fB
```

Therefore, in alternative scenario B a male patient gains, on average, about 6 years and 11 month more in the mild stage, about 1 year and 8 months less in the severe stage and about 1 year, as well as about 5 year and 11 months in terms of life expectancy. In the same way, a female patient gains, on average, about 7 years and 8 months more in the mild stage, about 1 year and 1 month less in the severe stage and about 6 year and 7 months in terms of life expectancy.

The graph representing gains from a patient's point of view in terms of:

* additional months spent as a mild patient (MPD)
* fewer months spent as a severe patient (APD)
* additional months of life expectancy (D)

is the following:

```{r}
differences_m1B <- calculate_differencesm1(aggregated_m, aggregated_m_altB)
differences_f1B <- calculate_differencesf1(aggregated_f, aggregated_f_altB)

plot_differencesm1B <- ggplot(differences_m1B, aes(x = cycle, y = difference, color = state)) +
  geom_line(size = 0.8) +        
  theme_minimal() +              
  labs(title = "Gains of the average male patient per cycle (Alternative scenario B)", 
       x = "Cycle", 
       y = "Months gained") +
  scale_x_continuous(breaks = unique(differences_m1$cycle)) +
  theme(plot.title = element_text(hjust = 0.5)) 

plot_differencesm1B

plot_differencesf1B <- ggplot(differences_f1B, aes(x = cycle, y = difference, color = state)) +
  geom_line(size = 0.8) +        
  theme_minimal() +              
  labs(title = "Gains of the average female patient per cycle (Alternative scenario B)", 
       x = "Cycle", 
       y = "Months gained") +
  scale_x_continuous(breaks = unique(differences_f1$cycle)) +
  theme(plot.title = element_text(hjust = 0.5)) 

plot_differencesf1B
```


```{r}
plot_differencesm1B1 <- ggplot(differences_m1B, aes(x = cycle, y = difference, color = state)) +
  geom_line(size = 0.8) +        
  theme_minimal() +              
  labs(title = "Gains of the average male patient per cycle (Alternative scenario B)", 
       x = "Cycle", 
       y = "Months gained") +
  scale_x_continuous(breaks = unique(differences_m1$cycle)) +
  geom_vline(xintercept = 5, color = "red", linetype = "dashed", size = 0.8) +
  theme(plot.title = element_text(hjust = 0.5)) 

plot_differencesm1B1

plot_differencesf1B1 <- ggplot(differences_f1B, aes(x = cycle, y = difference, color = state)) +
  geom_line(size = 0.8) +        
  theme_minimal() +              
  labs(title = "Gains of the average female patient per cycle (Alternative scenario B)", 
       x = "Cycle", 
       y = "Months gained") +
  scale_x_continuous(breaks = unique(differences_f1$cycle)) +
  geom_vline(xintercept = 5, color = "red", linetype = "dashed", size = 0.8) +
  theme(plot.title = element_text(hjust = 0.5)) 

plot_differencesf1B1
```


